# Story 2.3: Project-Level Progress Calculation & Visualization

## Status
Draft

## Story
**As a** multi-business operator,
**I want** projects to show overall completion based on all phases and tasks,
**so that** I can quickly assess project health and communicate status to clients.

## Acceptance Criteria
1. Project completion % is calculated as: (Sum of all phase completion %) / (Number of phases)
2. Projects without phases calculate directly from tasks: (Completed tasks) / (Total tasks) × 100
3. Project cards on Business pages display large progress bar with % complete prominently shown
4. Project header includes visual milestone markers if key deliverables are defined (optional, not blocking)
5. Project cards use same color gradient as phases: red/yellow/green based on % complete
6. Projects display estimated completion date based on current velocity (tasks completed per day × remaining tasks)
7. Stalled projects (no task progress in 7+ days) display warning indicator: "⚠️ No recent activity"
8. Project progress visualization is prominent enough for screenshots in client case studies

## Tasks / Subtasks
- [ ] Task 1: Create useProjectProgress hook for multi-level progress calculation (AC: 1, 2)
  - [ ] Create src/hooks/useProjectProgress.ts hook
  - [ ] Implement phase-based calculation: (sum of phase progress) / phase count
  - [ ] Implement fallback task-based calculation: (tasks at 100%) / total tasks × 100
  - [ ] Use phase-based if phases exist, otherwise use task-based
  - [ ] Handle edge case: projects with 0 phases AND 0 tasks return null
  - [ ] Memoize calculation with useMemo for performance
  - [ ] Return { progress: number | null, hasPhases: boolean, phaseCount: number, taskCount: number }
- [ ] Task 2: Add project progress visualization to ProjectCard (AC: 3, 5, 8)
  - [ ] Update src/components/business/ProjectCard.tsx to use ProgressBar from Story 2.2
  - [ ] Call useProjectProgress(projectId) to get progress data
  - [ ] Display large ProgressBar (size='lg') prominently at top of card
  - [ ] Show progress percentage in large font (text-2xl) next to bar
  - [ ] Use red/yellow/green color gradient from Story 2.2
  - [ ] Ensure visual hierarchy: progress bar is most prominent element on card
  - [ ] Design for screenshot-worthiness: clean, professional, client-facing
- [ ] Task 3: Implement velocity-based completion date estimation (AC: 6)
  - [ ] Create src/utils/projectVelocity.ts utility
  - [ ] Calculate tasks completed per day: query tasks with updated_at in last 30 days where progress_percentage changed to 100
  - [ ] Formula: velocity = completed_tasks / days_active
  - [ ] Estimate completion: remaining_tasks / velocity = days_until_done
  - [ ] Add to current date to get estimated completion date
  - [ ] Handle edge cases: velocity = 0 (show "No recent progress"), remaining tasks = 0 (show "Complete")
  - [ ] Format date with date-fns: format(estimatedDate, 'MMM d, yyyy')
  - [ ] Display in ProjectCard: "Est. completion: Dec 15, 2025"
- [ ] Task 4: Add stalled project detection and warning (AC: 7)
  - [ ] Create src/utils/projectActivity.ts utility
  - [ ] Query most recent task update for project: MAX(updated_at) from tasks where progress_percentage changed
  - [ ] Calculate days since last activity: daysSince = (today - lastActivityDate) / (1000 * 60 * 60 * 24)
  - [ ] If daysSince > 7, mark as stalled
  - [ ] Display warning badge in ProjectCard: "⚠️ No recent activity" with orange/red background
  - [ ] Show specific message: "Last activity 12 days ago"
  - [ ] Use Lucide AlertTriangle icon with text-orange-500
- [ ] Task 5: Update useProjects hook to include progress data (AC: all)
  - [ ] Update src/hooks/useProjects.ts to fetch phases and tasks
  - [ ] Query: `.select('*, phases(*, tasks(id, progress_percentage, updated_at)), tasks(id, progress_percentage, updated_at)')`
  - [ ] Calculate project progress in hook for caching efficiency
  - [ ] Include velocity calculation in query result
  - [ ] Include last activity timestamp
  - [ ] Return projects with: { id, name, progress, velocity, lastActivity, isStalled }
- [ ] Task 6: Add milestone markers to project header (AC: 4, optional)
  - [ ] Create src/components/business/MilestoneMarkers.tsx component
  - [ ] Display visual markers for key milestones (if defined in project metadata)
  - [ ] Show milestone name, target date, completion status
  - [ ] Use vertical timeline or horizontal progress markers
  - [ ] Make this feature optional: only display if project has milestones defined
  - [ ] Use Lucide Flag or CheckCircle icons for completed milestones
  - [ ] NOTE: This is non-blocking. Implement basic structure only if time permits
- [ ] Task 7: Add project progress sorting and filtering (AC: all)
  - [ ] Add "Sort by Progress" option in Business Dashboard filters
  - [ ] Allow sorting projects by %: ascending (least complete first), descending
  - [ ] Filter projects by progress range: Not Started, In Progress, Completed
  - [ ] Filter by stalled status: show only stalled projects
  - [ ] Highlight at-risk projects (low progress + approaching deadline)
  - [ ] Add "Needs Attention" view: stalled OR overdue OR <33% progress
- [ ] Task 8: Ensure real-time progress updates across all project views (AC: all)
  - [ ] Verify useRealtimeSync triggers project progress recalculation on task/phase changes
  - [ ] Test: update task in phase → verify project progress updates in real-time
  - [ ] Verify optimistic updates work for project-level progress
  - [ ] Test multi-tab sync: update in Business page → verify in Tasks Hub project filter
  - [ ] Measure sync latency: must be <500ms for project progress updates

## Dev Notes

### Previous Story Insights
**From Story 2.1:** [Source: docs/stories/2.1.task-level-progress-calculation.md]
- progress_percentage field on tasks table (INTEGER 0-100)
- ProgressIndicator component for task-level visualization
- Real-time sync via useRealtimeSync hook functional

**From Story 2.2:** [Source: docs/stories/2.2.phase-level-progress-calculation.md]
- usePhaseProgress hook calculates phase completion from tasks
- ProgressBar component with red/yellow/green color gradient
- Phase progress updates in real-time when tasks change
- Progress color utility functions in src/utils/progressColors.ts

**From Story 1.1-1.2:** [Source: docs/stories/1.1-1.2]
- ProjectCard.tsx exists in src/components/business/ProjectCard.tsx
- Projects table has phases relationship
- useProjects.ts hook handles project data fetching
- Business Dashboard page displays projects in card layout

**Key Technical Decisions:**
- Project progress uses phase-based calculation when phases exist, otherwise falls back to task-based
- Velocity calculation based on 30-day rolling average for stability
- Stalled detection threshold: 7 days (1 week) without task progress updates
- Estimated completion date shown only when velocity > 0 and remaining tasks > 0

### Architecture Context

**Tech Stack:** [Source: docs/ui-architecture/2-frontend-tech-stack.md]
- React 19.1.1 + TypeScript 5.9.3
- TanStack Query 5.90.2 for server state
- date-fns 4.1.0 for date calculations
- Lucide React 0.544.0 for icons

**Project Progress Calculation Pattern:**
```typescript
// src/hooks/useProjectProgress.ts
interface ProjectProgress {
  progress: number | null;
  hasPhases: boolean;
  phaseCount: number;
  taskCount: number;
  velocity: number; // tasks per day
  estimatedCompletion: Date | null;
  isStalled: boolean;
  lastActivity: Date | null;
}

export const useProjectProgress = (projectId: string): ProjectProgress => {
  const { data: project } = useQuery({
    queryKey: ['projects', projectId, 'progress'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('projects')
        .select(`
          *,
          phases(id, tasks(progress_percentage, updated_at)),
          tasks(id, progress_percentage, updated_at, created_at)
        `)
        .eq('id', projectId)
        .single();

      if (error) throw error;
      return data;
    },
  });

  return useMemo(() => {
    if (!project) return defaultProgressState;

    const hasPhases = project.phases && project.phases.length > 0;

    let progress: number;
    if (hasPhases) {
      // Phase-based calculation
      const phaseProgresses = project.phases.map(phase => {
        const tasks = phase.tasks || [];
        if (tasks.length === 0) return 0;
        return tasks.reduce((sum, t) => sum + t.progress_percentage, 0) / tasks.length;
      });
      progress = phaseProgresses.reduce((sum, p) => sum + p, 0) / phaseProgresses.length;
    } else {
      // Task-based calculation
      const tasks = project.tasks || [];
      if (tasks.length === 0) return { ...defaultProgressState, hasPhases: false };
      progress = (tasks.reduce((sum, t) => sum + t.progress_percentage, 0) / tasks.length);
    }

    // Velocity calculation (last 30 days)
    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
    const allTasks = hasPhases
      ? project.phases.flatMap(p => p.tasks || [])
      : project.tasks || [];

    const recentlyCompleted = allTasks.filter(t =>
      t.progress_percentage === 100 &&
      new Date(t.updated_at) > thirtyDaysAgo
    );
    const velocity = recentlyCompleted.length / 30;

    // Estimated completion
    const remainingTasks = allTasks.filter(t => t.progress_percentage < 100).length;
    const estimatedCompletion = velocity > 0 && remainingTasks > 0
      ? new Date(Date.now() + (remainingTasks / velocity) * 24 * 60 * 60 * 1000)
      : null;

    // Stalled detection
    const lastActivity = allTasks.length > 0
      ? new Date(Math.max(...allTasks.map(t => new Date(t.updated_at).getTime())))
      : null;
    const daysSinceActivity = lastActivity
      ? (Date.now() - lastActivity.getTime()) / (1000 * 60 * 60 * 24)
      : Infinity;
    const isStalled = daysSinceActivity > 7;

    return {
      progress: Math.round(progress * 10) / 10,
      hasPhases,
      phaseCount: hasPhases ? project.phases.length : 0,
      taskCount: allTasks.length,
      velocity,
      estimatedCompletion,
      isStalled,
      lastActivity,
    };
  }, [project]);
};
```

**Velocity Utility:**
```typescript
// src/utils/projectVelocity.ts
import { differenceInDays } from 'date-fns';

export interface VelocityData {
  velocity: number; // tasks per day
  completedLast30Days: number;
  estimatedDaysRemaining: number | null;
}

export const calculateVelocity = (tasks: Task[]): VelocityData => {
  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);

  const recentlyCompleted = tasks.filter(t =>
    t.progress_percentage === 100 &&
    new Date(t.updated_at) > thirtyDaysAgo
  );

  const velocity = recentlyCompleted.length / 30;
  const remainingTasks = tasks.filter(t => t.progress_percentage < 100).length;
  const estimatedDaysRemaining = velocity > 0 ? remainingTasks / velocity : null;

  return {
    velocity,
    completedLast30Days: recentlyCompleted.length,
    estimatedDaysRemaining,
  };
};
```

**Stalled Project Detection:**
```typescript
// src/utils/projectActivity.ts
import { differenceInDays } from 'date-fns';

export interface ActivityStatus {
  isStalled: boolean;
  daysSinceActivity: number;
  lastActivityDate: Date | null;
  message: string;
}

export const checkProjectActivity = (tasks: Task[]): ActivityStatus => {
  if (tasks.length === 0) {
    return {
      isStalled: true,
      daysSinceActivity: Infinity,
      lastActivityDate: null,
      message: 'No tasks in project',
    };
  }

  const lastActivity = new Date(
    Math.max(...tasks.map(t => new Date(t.updated_at).getTime()))
  );

  const daysSinceActivity = differenceInDays(new Date(), lastActivity);
  const isStalled = daysSinceActivity > 7;

  return {
    isStalled,
    daysSinceActivity,
    lastActivityDate: lastActivity,
    message: isStalled
      ? `Last activity ${daysSinceActivity} days ago`
      : 'Active',
  };
};
```

**File Locations:**
- Create: src/hooks/useProjectProgress.ts
- Create: src/utils/projectVelocity.ts
- Create: src/utils/projectActivity.ts
- Create: src/components/business/MilestoneMarkers.tsx (optional)
- Update: src/components/business/ProjectCard.tsx
- Update: src/hooks/useProjects.ts
- Reuse: src/components/shared/ProgressBar.tsx (from Story 2.2)
- Reuse: src/utils/progressColors.ts (from Story 2.2)

### Testing

**Testing Requirements:**
1. Verify all 8 acceptance criteria
2. Test phase-based progress: create project with 3 phases at 100%, 50%, 0% → verify shows 50%
3. Test task-based progress: create project without phases, 5 tasks, 3 complete → verify shows 60%
4. Test color gradient: verify red at 25%, yellow at 50%, green at 80%
5. Test velocity calculation: complete 3 tasks in last 30 days → verify velocity = 0.1 tasks/day
6. Test estimated completion: 10 remaining tasks, velocity 0.5/day → verify shows "Est. completion in 20 days"
7. Test stalled detection: create project with no updates in 8 days → verify "⚠️ No recent activity" badge
8. Test real-time updates: update task progress → verify project progress recalculates in <500ms
9. Test screenshot-worthiness: verify progress visualization is clean and professional
10. Test edge cases: 0 phases + 0 tasks, all tasks complete, very low velocity (<0.01)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | v1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
