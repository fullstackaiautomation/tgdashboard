# Story 5.3: Business Area Summary Card

## Status
Ready for Development

## Story
**As a** consultant managing 5 businesses,
**I want** the Business area card to show aggregate status across all 5 businesses,
**so that** I can identify which businesses need attention without checking each individually.

## Acceptance Criteria
1. Business card displays aggregate across all 5 businesses:
   - Total active projects count
   - Overall completion % (average across all business projects)
   - Total active tasks across all businesses
   - Total hours invested this week across all businesses
2. Business card expands to show 5 individual business mini-cards with color coding:
   - Full Stack AI (green): "2 projects, 65% complete, 12h this week"
   - Service SaaS (varies): "1 project, 30% complete, 0h this week" (warning)
   - Huge Capital (purple): "3 projects, 80% complete, 15h this week"
   - S4 (blue): "1 project, 90% complete, 8h this week"
   - 808 (orange): "1 project, 45% complete, 5h this week"
3. Businesses with warnings are flagged: zero hours this week, stalled projects (no activity 7+ days), overdue tasks
4. Quick action: clicking business mini-card navigates to that specific Business page
5. Visual indicator shows which business has most active tasks (needs most attention)
6. Business card shows upcoming deadlines: "Next deadline: Huge Capital deliverable in 3 days"

## Tasks / Subtasks
- [ ] Task 1: Create aggregate business metrics query (AC: 1)
  - [ ] Create src/hooks/useBusinessAreaSummary.ts hook
  - [ ] Query all 5 businesses: Full Stack AI, Service SaaS, Huge Capital, S4, 808
  - [ ] Calculate total active projects: COUNT(projects WHERE status != 'completed')
  - [ ] Calculate overall completion: AVG(project.progress_percentage) across all businesses
  - [ ] Calculate total active tasks: COUNT(tasks WHERE business_id IN businesses AND progress < 100)
  - [ ] Join with deep_work_sessions for weekly hours per business
  - [ ] Aggregate weekly hours: SUM(duration_minutes) WHERE start_time >= NOW() - 7 days
  - [ ] Optimize with single query using CTEs and GROUP BY business_id
  - [ ] Return BusinessAreaSummary interface with all aggregated metrics

- [ ] Task 2: Build per-business drill-down query (AC: 2, 3)
  - [ ] Query individual business stats: projects, completion %, tasks, hours, warnings
  - [ ] Calculate per business:
    - Active projects count
    - Average project completion %
    - Active tasks count
    - Hours invested this week
    - Days since last activity (MAX(tasks.updated_at))
  - [ ] Detect warnings:
    - Zero hours: hours_this_week = 0
    - Stalled: days_since_activity > 7
    - Overdue tasks: COUNT(tasks WHERE due_date < NOW() AND progress < 100) > 0
  - [ ] Return BusinessDetail[] array with 5 businesses sorted by priority
  - [ ] Priority: businesses with warnings first, then by active task count

- [ ] Task 3: Create expandable BusinessAreaCard component (AC: 2, 4)
  - [ ] Create src/components/review/BusinessAreaCard.tsx
  - [ ] Extend ReviewAreaCard with expansion functionality
  - [ ] Add expand/collapse state using useState
  - [ ] Display aggregate metrics in collapsed state: total projects, avg %, tasks, hours
  - [ ] Add ChevronDown/ChevronUp icon indicating expandable state
  - [ ] Click header ‚Üí toggle expansion (don't navigate)
  - [ ] Expanded state shows 5 business mini-cards below aggregate
  - [ ] Use AnimatePresence from framer-motion for smooth expand/collapse animation
  - [ ] Prevent card body click from collapsing when clicking mini-cards

- [ ] Task 4: Build BusinessMiniCard component (AC: 2, 4, 5)
  - [ ] Create src/components/review/BusinessMiniCard.tsx
  - [ ] Display business name with color-coded icon/badge
  - [ ] Show "X projects, Y% complete, Zh this week" in compact format
  - [ ] Use business-specific colors: Full Stack (blue), Service SaaS (purple), Huge Capital (green), S4 (teal), 808 (orange)
  - [ ] Add small progress bar showing completion %
  - [ ] Make entire mini-card clickable ‚Üí navigate to /business/:businessId
  - [ ] Highlight business with most active tasks: larger size or bold border
  - [ ] Show warning icons for zero hours, stalled, overdue conditions
  - [ ] Add hover effect: background color matching business color

- [ ] Task 5: Implement warning detection system (AC: 3)
  - [ ] Create src/utils/businessWarnings.ts utility
  - [ ] Warning types:
    - NO_HOURS: hours_this_week = 0 ‚Üí "No time invested this week ‚ö†Ô∏è"
    - STALLED: days_since_activity > 7 ‚Üí "Stalled X days üïê"
    - OVERDUE: overdue_task_count > 0 ‚Üí "Y overdue tasks üî¥"
    - LOW_PROGRESS: completion < 20% AND active_projects > 0 ‚Üí "Low progress ‚ö°"
  - [ ] Calculate warning severity: critical (3+ warnings), warning (1-2), normal (0)
  - [ ] Display warning badges on mini-cards with appropriate icons
  - [ ] Aggregate warning count in collapsed view: "2 businesses need attention"
  - [ ] Color-code mini-cards: red border for critical, yellow for warning
  - [ ] Sort businesses by warning severity in expanded view

- [ ] Task 6: Create upcoming deadlines widget (AC: 6)
  - [ ] Query nearest deadline across all business projects
  - [ ] SQL: SELECT project, deadline FROM projects WHERE business_id IN (...) AND deadline >= NOW() ORDER BY deadline LIMIT 1
  - [ ] Display format: "Next deadline: Huge Capital deliverable in 3 days"
  - [ ] Color code urgency:
    - <3 days: red text and icon
    - 3-7 days: yellow text
    - >7 days: gray text
  - [ ] Show project name and business name
  - [ ] Add countdown: "in X days" or "tomorrow" or "today!"
  - [ ] Link to project detail page on click
  - [ ] If no upcoming deadlines: "No upcoming deadlines ‚úÖ"

- [ ] Task 7: Highlight most active business (AC: 5)
  - [ ] Calculate active task count per business
  - [ ] Identify business with MAX(active_tasks)
  - [ ] Visual differentiation in mini-card:
    - Larger card size (110% scale)
    - Bold border with business color
    - "Most Active" badge in corner
    - Pulsing animation to draw attention
  - [ ] Display stat: "Huge Capital has 15 active tasks (most)"
  - [ ] Update highlight when task counts change
  - [ ] Handle ties: if multiple businesses tied, show all with badge

- [ ] Task 8: Build aggregate progress visualization (AC: 1)
  - [ ] Display overall business completion % prominently
  - [ ] Use horizontal stacked bar showing 5 businesses proportionally
  - [ ] Each segment colored by business color
  - [ ] Hover over segment ‚Üí tooltip shows business name and %
  - [ ] Overall % = weighted average by project count
  - [ ] Display total hours this week across all businesses
  - [ ] Show week-over-week comparison: "‚Üë 5h more than last week"
  - [ ] Add mini trend sparkline showing last 4 weeks of hours

- [ ] Task 9: Implement business navigation (AC: 4)
  - [ ] Each business mini-card navigates to /business/:businessId
  - [ ] Pass business context: businessId, businessName, businessColor
  - [ ] Use React Router Link with prefetching for instant navigation
  - [ ] Add keyboard navigation: Tab through mini-cards, Enter to navigate
  - [ ] Show cursor pointer on hover
  - [ ] Add "View Business Dashboard" secondary action for overview
  - [ ] Track analytics: log which businesses users view most frequently
  - [ ] Prevent navigation when clicking warning badges (show details instead)

- [ ] Task 10: Integrate real-time updates (AC: 2, 3)
  - [ ] Subscribe to projects table changes WHERE business_id IN (5 businesses)
  - [ ] Subscribe to tasks table changes for business tasks
  - [ ] Subscribe to deep_work_sessions for weekly hours updates
  - [ ] Update aggregate metrics when any business data changes
  - [ ] Update warning badges when conditions change
  - [ ] Recalculate "most active" highlight when task counts change
  - [ ] Invalidate query cache on project/task completion
  - [ ] Optimistic updates: update mini-card immediately on action
  - [ ] Test: complete project in Tab 1 ‚Üí verify mini-card updates Tab 2 <500ms

## Dev Notes

### Previous Story Insights

**From Story 5.1:** [Source: docs/stories/5.1.review-dashboard-page-structure.md]
- ReviewAreaCard base component with expandable capability
- Priority sorting and visual hierarchy patterns
- Navigation patterns with one-click drill-down

**From Story 5.2:** [Source: docs/stories/5.2.daily-area-summary-card.md]
- Warning badge patterns and color coding
- Real-time update integration
- Progress visualization with color gradients

**From Epic 2 Stories:** [Source: docs/stories/2.1-2.6]
- Story 2.4: Business Area Progress Dashboard (foundational)
- useBusinessProgress hook for multi-business aggregation
- Business comparison patterns and visual design
- Project-level progress calculations

**From Epic 4 Stories:** [Source: docs/stories/4.1-4.6]
- Story 4.2: Business Time Investment Dashboard
- Weekly hours calculation per business
- Time allocation across businesses
- deep_work_sessions with business_id linkage

**From Epic 1 Stories:** [Source: docs/stories/1.1-1.6]
- tasks table with business_id foreign key
- projects table with business_id and progress_percentage
- Bidirectional sync between Business and Tasks pages

**Key Technical Context:**
- Business card is ONLY expandable card (others are static summary cards)
- 5 businesses are fixed: Full Stack AI, Service SaaS, Huge Capital, S4, 808
- Each business has distinct color coding for visual differentiation
- Warning system is critical: helps identify neglected businesses
- Weekly hours metric is key business health indicator

### Architecture Context

**Tech Stack:** [Source: docs/ui-architecture/2-frontend-tech-stack.md]
- React 19.1.1 + TypeScript 5.9.3
- TanStack Query 5.90.2 for state management
- Framer Motion for expand/collapse animations
- Recharts for progress visualization
- Lucide React 0.544.0 for icons

**Database Query: Business Area Summary**
```sql
-- Aggregate metrics across all 5 businesses with per-business drill-down
CREATE OR REPLACE FUNCTION get_business_area_summary(p_user_id UUID)
RETURNS TABLE (
  -- Aggregate metrics
  total_active_projects INTEGER,
  overall_completion_percentage NUMERIC,
  total_active_tasks INTEGER,
  total_hours_this_week NUMERIC,
  businesses_needing_attention INTEGER,
  next_deadline_project TEXT,
  next_deadline_business TEXT,
  next_deadline_date DATE,
  -- Per-business details (returned as JSONB array)
  business_details JSONB
) AS $$
BEGIN
  RETURN QUERY
  WITH business_stats AS (
    SELECT
      b.id,
      b.name,
      b.color,
      COUNT(DISTINCT p.id) FILTER (WHERE p.status != 'completed') as active_projects,
      ROUND(AVG(p.progress_percentage), 1) as avg_completion,
      COUNT(t.id) FILTER (WHERE t.progress_percentage < 100) as active_tasks,
      COUNT(t.id) FILTER (WHERE t.due_date < NOW() AND t.progress_percentage < 100) as overdue_tasks,
      COALESCE(
        (SELECT SUM(dws.duration_minutes) / 60.0
         FROM deep_work_sessions dws
         WHERE dws.business_id = b.id
           AND dws.start_time >= NOW() - INTERVAL '7 days'
           AND dws.user_id = p_user_id),
        0
      ) as hours_this_week,
      EXTRACT(DAY FROM (NOW() - MAX(t.updated_at))) as days_since_activity,
      MIN(p.deadline) FILTER (WHERE p.deadline >= NOW()) as next_deadline
    FROM businesses b
    LEFT JOIN projects p ON p.business_id = b.id
    LEFT JOIN tasks t ON t.business_id = b.id AND t.user_id = p_user_id
    WHERE b.user_id = p_user_id
      AND b.name IN ('Full Stack AI', 'Service SaaS', 'Huge Capital', 'S4', '808')
    GROUP BY b.id, b.name, b.color
  ),
  warnings AS (
    SELECT
      bs.*,
      CASE
        WHEN bs.hours_this_week = 0 THEN 1 ELSE 0
      END +
      CASE
        WHEN bs.days_since_activity > 7 THEN 1 ELSE 0
      END +
      CASE
        WHEN bs.overdue_tasks > 0 THEN 1 ELSE 0
      END as warning_count
    FROM business_stats bs
  ),
  next_deadline_info AS (
    SELECT
      p.project_name,
      b.name as business_name,
      p.deadline
    FROM projects p
    JOIN businesses b ON p.business_id = b.id
    WHERE p.user_id = p_user_id
      AND p.deadline >= NOW()
    ORDER BY p.deadline
    LIMIT 1
  )
  SELECT
    SUM(w.active_projects)::INTEGER as total_active_projects,
    ROUND(AVG(w.avg_completion), 1) as overall_completion_percentage,
    SUM(w.active_tasks)::INTEGER as total_active_tasks,
    SUM(w.hours_this_week)::NUMERIC as total_hours_this_week,
    COUNT(*) FILTER (WHERE w.warning_count > 0)::INTEGER as businesses_needing_attention,
    ndi.project_name as next_deadline_project,
    ndi.business_name as next_deadline_business,
    ndi.deadline::DATE as next_deadline_date,
    jsonb_agg(
      jsonb_build_object(
        'id', w.id,
        'name', w.name,
        'color', w.color,
        'activeProjects', w.active_projects,
        'completionPercentage', w.avg_completion,
        'activeTasks', w.active_tasks,
        'overdueTasks', w.overdue_tasks,
        'hoursThisWeek', w.hours_this_week,
        'daysSinceActivity', w.days_since_activity,
        'warningCount', w.warning_count,
        'warnings', jsonb_build_object(
          'noHours', w.hours_this_week = 0,
          'stalled', w.days_since_activity > 7,
          'overdue', w.overdue_tasks > 0
        )
      )
      ORDER BY w.warning_count DESC, w.active_tasks DESC
    ) as business_details
  FROM warnings w
  CROSS JOIN LATERAL (SELECT * FROM next_deadline_info) ndi
  GROUP BY ndi.project_name, ndi.business_name, ndi.deadline;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**React Hook: useBusinessAreaSummary**
```typescript
// src/hooks/useBusinessAreaSummary.ts
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase';
import { formatDistanceToNow, differenceInDays } from 'date-fns';

export interface BusinessDetail {
  id: string;
  name: string;
  color: string;
  activeProjects: number;
  completionPercentage: number;
  activeTasks: number;
  overdueTasks: number;
  hoursThisWeek: number;
  daysSinceActivity: number;
  warningCount: number;
  warnings: {
    noHours: boolean;
    stalled: boolean;
    overdue: boolean;
  };
  isMostActive: boolean;
}

export interface BusinessAreaSummary {
  totalActiveProjects: number;
  overallCompletionPercentage: number;
  totalActiveTasks: number;
  totalHoursThisWeek: number;
  businessesNeedingAttention: number;
  nextDeadlineProject: string | null;
  nextDeadlineBusiness: string | null;
  nextDeadlineDate: Date | null;
  nextDeadlineFormatted: string;
  businesses: BusinessDetail[];
}

export const useBusinessAreaSummary = () => {
  return useQuery({
    queryKey: ['business', 'area-summary'],
    queryFn: async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase.rpc('get_business_area_summary', {
        p_user_id: user.id,
      });

      if (error) throw error;

      const summary = data[0];

      // Parse business details from JSONB
      const businesses: BusinessDetail[] = summary.business_details.map((b: any) => ({
        id: b.id,
        name: b.name,
        color: b.color,
        activeProjects: b.activeProjects,
        completionPercentage: b.completionPercentage,
        activeTasks: b.activeTasks,
        overdueTasks: b.overdueTasks,
        hoursThisWeek: b.hoursThisWeek,
        daysSinceActivity: b.daysSinceActivity,
        warningCount: b.warningCount,
        warnings: b.warnings,
        isMostActive: false, // Will set below
      }));

      // Mark most active business
      const maxActiveTasks = Math.max(...businesses.map(b => b.activeTasks));
      businesses.forEach(b => {
        if (b.activeTasks === maxActiveTasks && maxActiveTasks > 0) {
          b.isMostActive = true;
        }
      });

      return {
        totalActiveProjects: summary.total_active_projects,
        overallCompletionPercentage: summary.overall_completion_percentage,
        totalActiveTasks: summary.total_active_tasks,
        totalHoursThisWeek: summary.total_hours_this_week,
        businessesNeedingAttention: summary.businesses_needing_attention,
        nextDeadlineProject: summary.next_deadline_project,
        nextDeadlineBusiness: summary.next_deadline_business,
        nextDeadlineDate: summary.next_deadline_date ? new Date(summary.next_deadline_date) : null,
        nextDeadlineFormatted: summary.next_deadline_date
          ? `${summary.next_deadline_project} (${summary.next_deadline_business}) in ${differenceInDays(
              new Date(summary.next_deadline_date),
              new Date()
            )} days`
          : 'No upcoming deadlines',
        businesses,
      } as BusinessAreaSummary;
    },
    staleTime: 60000, // 1 minute
    refetchInterval: 120000, // Auto-refetch every 2 minutes
  });
};
```

**BusinessAreaCard Component:**
```typescript
// src/components/review/BusinessAreaCard.tsx
import { FC, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Briefcase, ChevronDown, ChevronUp, AlertTriangle } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { useBusinessAreaSummary } from '@/hooks/useBusinessAreaSummary';
import { BusinessMiniCard } from './BusinessMiniCard';
import { ProgressBar } from '@/components/shared/ProgressBar';

export const BusinessAreaCard: FC = () => {
  const navigate = useNavigate();
  const { data: summary, isLoading } = useBusinessAreaSummary();
  const [isExpanded, setIsExpanded] = useState(false);

  if (isLoading || !summary) return <BusinessAreaCardSkeleton />;

  const hasWarnings = summary.businessesNeedingAttention > 0;
  const borderColor = hasWarnings ? 'border-orange-500' : 'border-gray-700';

  return (
    <div
      className={`bg-gray-800 rounded-lg p-6 border-2 ${borderColor}
                  hover:border-purple-500 transition-all duration-300`}
    >
      {/* Header - Expandable */}
      <div
        className="flex items-center justify-between mb-4 cursor-pointer"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center gap-3">
          <Briefcase className="text-purple-500" size={32} />
          <div>
            <h3 className="text-xl font-bold text-white">BUSINESS</h3>
            <p className="text-sm text-gray-400">
              {summary.totalActiveProjects} projects, {summary.totalActiveTasks} tasks
            </p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          {hasWarnings && (
            <div className="flex items-center gap-1 text-orange-400">
              <AlertTriangle size={18} />
              <span className="text-sm">{summary.businessesNeedingAttention}</span>
            </div>
          )}
          {isExpanded ? (
            <ChevronUp className="text-gray-400" size={24} />
          ) : (
            <ChevronDown className="text-gray-400" size={24} />
          )}
        </div>
      </div>

      {/* Aggregate Progress */}
      <div className="mb-4">
        <div className="flex items-center justify-between mb-2">
          <span className="text-2xl font-bold text-white">
            {summary.overallCompletionPercentage.toFixed(0)}%
          </span>
          <span className="text-sm text-gray-400">Overall completion</span>
        </div>
        <ProgressBar progress={summary.overallCompletionPercentage} size="lg" showLabel={false} />
      </div>

      {/* Hours This Week */}
      <div className="mb-4 p-3 bg-gray-900 rounded border border-gray-700">
        <div className="flex items-center justify-between">
          <span className="text-sm text-gray-400">Hours This Week</span>
          <span className="text-xl font-bold text-white">
            {summary.totalHoursThisWeek.toFixed(1)}h
          </span>
        </div>
      </div>

      {/* Next Deadline */}
      {summary.nextDeadlineDate && (
        <div className="mb-4 p-2 bg-blue-950/30 border border-blue-500 rounded">
          <p className="text-sm text-blue-200">
            Next deadline: {summary.nextDeadlineFormatted}
          </p>
        </div>
      )}

      {/* Expanded Business Details */}
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="overflow-hidden"
          >
            <div className="mt-4 pt-4 border-t border-gray-700 space-y-3">
              {summary.businesses.map((business) => (
                <BusinessMiniCard
                  key={business.id}
                  business={business}
                  onClick={(e) => {
                    e.stopPropagation();
                    navigate(`/business/${business.id}`);
                  }}
                />
              ))}
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* View All Link */}
      {!isExpanded && (
        <button
          className="w-full mt-4 py-2 text-center text-sm text-purple-400 hover:text-purple-300
                     border border-purple-500 rounded-lg hover:bg-purple-950/30 transition-colors"
          onClick={(e) => {
            e.stopPropagation();
            setIsExpanded(true);
          }}
        >
          View All Businesses
        </button>
      )}
    </div>
  );
};
```

**BusinessMiniCard Component:**
```typescript
// src/components/review/BusinessMiniCard.tsx
import { FC } from 'react';
import { AlertCircle, Clock, AlertTriangle } from 'lucide-react';
import type { BusinessDetail } from '@/hooks/useBusinessAreaSummary';

interface BusinessMiniCardProps {
  business: BusinessDetail;
  onClick: (e: React.MouseEvent) => void;
}

export const BusinessMiniCard: FC<BusinessMiniCardProps> = ({ business, onClick }) => {
  const hasWarnings = business.warningCount > 0;
  const borderColor = hasWarnings ? 'border-orange-400' : 'border-gray-700';

  return (
    <div
      className={`p-4 rounded-lg border-2 ${borderColor} bg-gray-900
                  hover:bg-gray-850 transition-all cursor-pointer
                  ${business.isMostActive ? 'scale-105 border-purple-500' : ''}`}
      onClick={onClick}
      style={{
        borderLeftWidth: '4px',
        borderLeftColor: business.color,
      }}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-2">
        <h4 className="font-semibold text-white">{business.name}</h4>
        {business.isMostActive && (
          <span className="text-xs bg-purple-500 text-white px-2 py-1 rounded-full">
            Most Active
          </span>
        )}
      </div>

      {/* Stats */}
      <div className="grid grid-cols-3 gap-2 mb-2">
        <div>
          <p className="text-xs text-gray-500">Projects</p>
          <p className="text-sm font-semibold text-white">{business.activeProjects}</p>
        </div>
        <div>
          <p className="text-xs text-gray-500">Complete</p>
          <p className="text-sm font-semibold text-white">{business.completionPercentage.toFixed(0)}%</p>
        </div>
        <div>
          <p className="text-xs text-gray-500">Hours</p>
          <p className="text-sm font-semibold text-white">{business.hoursThisWeek.toFixed(1)}h</p>
        </div>
      </div>

      {/* Progress Bar */}
      <div className="w-full bg-gray-700 rounded-full h-1.5 mb-2">
        <div
          className="h-1.5 rounded-full transition-all"
          style={{
            width: `${business.completionPercentage}%`,
            backgroundColor: business.color,
          }}
        />
      </div>

      {/* Warnings */}
      {hasWarnings && (
        <div className="flex items-center gap-2 text-xs">
          {business.warnings.noHours && (
            <span className="text-orange-400 flex items-center gap-1">
              <AlertCircle size={12} />
              No hours this week
            </span>
          )}
          {business.warnings.stalled && (
            <span className="text-yellow-400 flex items-center gap-1">
              <Clock size={12} />
              Stalled {business.daysSinceActivity}d
            </span>
          )}
          {business.warnings.overdue && (
            <span className="text-red-400 flex items-center gap-1">
              <AlertTriangle size={12} />
              {business.overdueTasks} overdue
            </span>
          )}
        </div>
      )}
    </div>
  );
};
```

**File Locations:**
- Create: supabase/migrations/create-business-area-summary-function.sql
- Create: src/hooks/useBusinessAreaSummary.ts
- Create: src/components/review/BusinessAreaCard.tsx
- Create: src/components/review/BusinessMiniCard.tsx
- Create: src/utils/businessWarnings.ts
- Update: src/pages/ReviewDashboard.tsx (integrate BusinessAreaCard)
- Reuse: src/components/shared/ProgressBar.tsx (from Epic 2)

### Testing

**Testing Requirements:** [Source: docs/prd/technical-assumptions.md]
Manual testing with systematic verification

**Business Area Card Testing Workflow:**
1. **Aggregate Metrics Accuracy:**
   - Create 2 projects in Full Stack AI, 3 in Huge Capital, 1 each in others
   - Verify card shows "7 total active projects"
   - Set projects to: 65%, 80%, 30%, 90%, 45%
   - Verify overall completion = weighted average (~62%)
   - Create 15 tasks across all businesses
   - Verify shows "15 total active tasks"

2. **Weekly Hours Aggregation:**
   - Log 12h on Full Stack AI this week
   - Log 15h on Huge Capital this week
   - Log 8h on S4, 5h on 808, 0h on Service SaaS
   - Verify card shows "40.0h this week" total
   - Verify individual mini-cards show correct per-business hours

3. **Expand/Collapse Functionality:**
   - Card starts collapsed showing aggregate only
   - Click header ‚Üí verify expands smoothly with animation
   - Verify shows 5 business mini-cards
   - Click header again ‚Üí verify collapses smoothly
   - Click "View All Businesses" button ‚Üí verify expands
   - Verify ChevronDown changes to ChevronUp when expanded

4. **Business Mini-Card Display:**
   - Verify Full Stack AI shows: "2 projects, 65% complete, 12h this week"
   - Verify Service SaaS shows: "1 project, 30% complete, 0h this week"
   - Verify each mini-card has correct color-coded left border
   - Verify progress bar fill matches completion %
   - Click mini-card ‚Üí verify navigates to /business/:businessId
   - Verify mini-card click doesn't collapse parent card

5. **Warning Detection:**
   - Service SaaS: 0h this week ‚Üí verify "No hours this week ‚ö†Ô∏è" badge
   - Create project in 808 with no activity 10 days ‚Üí verify "Stalled 10d üïê"
   - Create 3 overdue tasks in Full Stack AI ‚Üí verify "3 overdue tasks üî¥"
   - Verify orange border on mini-cards with warnings
   - Verify aggregate shows "2 businesses need attention" (if 2 have warnings)

6. **Most Active Business Highlighting:**
   - Create 15 tasks in Huge Capital (most of any business)
   - Verify Huge Capital mini-card has "Most Active" badge
   - Verify scaled up slightly (110%)
   - Verify purple border instead of normal gray
   - Complete tasks to make S4 most active ‚Üí verify highlight moves

7. **Next Deadline Widget:**
   - Create project deadline in Huge Capital for 3 days from now
   - Verify shows "Next deadline: Project X (Huge Capital) in 3 days"
   - Create earlier deadline in Full Stack AI (tomorrow)
   - Verify switches to show earliest deadline
   - Set deadline to today ‚Üí verify red color urgency
   - No deadlines ‚Üí verify "No upcoming deadlines ‚úÖ"

8. **Color Coding Per Business:**
   - Full Stack AI: blue left border
   - Service SaaS: purple left border
   - Huge Capital: green left border
   - S4: teal left border
   - 808: orange left border
   - Verify hover on mini-card intensifies business color

9. **Real-Time Updates:**
   - Open Review Dashboard in Tab 1 and Tab 2
   - Complete project in Huge Capital in Tab 1
   - Verify overall completion % updates in Tab 2 within 500ms
   - Log Deep Work session on Full Stack AI in Tab 1
   - Verify mini-card hours update in Tab 2
   - Create overdue task in Service SaaS in Tab 1
   - Verify warning badge appears in Tab 2

10. **Edge Cases:**
    - No active projects in any business ‚Üí verify shows "0 projects" gracefully
    - All businesses 100% complete ‚Üí verify shows green "All complete ‚úÖ"
    - Tie for most active (2 businesses with 10 tasks each) ‚Üí verify both get badge
    - Expand card with 0 projects ‚Üí verify mini-cards still display with zero stats
    - Delete business ‚Üí verify aggregate recalculates and mini-card removed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | v1.0 | Initial story creation for Business Area Summary Card | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
