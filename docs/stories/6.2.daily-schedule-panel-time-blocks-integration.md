# Story 6.2: Daily Schedule Panel - Time Blocks Integration

**Epic:** [Epic 6 - Master Calendar & Daily Schedule Synchronization](./EPIC-6-SCHEDULE-SYNC.md)

**Story Type:** UI Refactoring - Brownfield Enhancement

**Depends On:** [Story 6.1 - Data Migration](./6.1.data-migration-tasks-to-time-blocks.md) ✅ Must be completed first

---

## User Story

As a **user managing my daily schedule**,
I want **the Daily Schedule Panel to display tasks from time blocks with duration and status information**,
So that **I can see a unified schedule across both the Calendar page and Tasks page, with rich time management details**.

---

## Story Context

### Existing System Integration

- **Integrates with:**
  - `DailySchedulePanel.tsx` (component to refactor)
  - `useCalendar.ts` hooks (`useDailySchedule`, `useCreateTimeBlock`, `useDeleteTimeBlock`)
  - `task_time_blocks` table (data source)
  - `DailyScheduleBlock` type from `@/types/calendar.ts`

- **Technology:**
  - React 19.1.1 + TypeScript 5.9.3
  - React Query (@tanstack/react-query)
  - date-fns for date formatting
  - Existing UI components (Card, Button, Badge from shadcn/ui)

- **Follows pattern:**
  - Existing `MasterCalendar.tsx` uses `useCalendarView` hook
  - TasksHub uses React Query with real-time subscriptions
  - Calendar page already displays time blocks successfully

- **Touch points:**
  - Currently reads: `TaskHub[]` with `scheduled_date` and `scheduled_time` fields
  - Will read: `DailyScheduleBlock[]` from `useDailySchedule` hook
  - Drag-and-drop handler (`onTaskDrop`) → will call `useCreateTimeBlock` mutation
  - Remove button (`onTaskRemove`) → will call `useDeleteTimeBlock` mutation

---

## Acceptance Criteria

### Functional Requirements

1. **Display Time Blocks from Database**
   - Daily Schedule Panel queries `task_time_blocks` table via `useDailySchedule(selectedDate)` hook
   - Tasks displayed are time blocks (not direct task properties)
   - Time block data includes: `task_name`, `start_time`, `end_time`, `status`, `block_id`

2. **Show Duration Instead of Just Start Time**
   - Display format: `"9:00 AM - 10:30 AM (1.5h)"` instead of just `"9:00 AM"`
   - Duration calculated from `start_time` and `end_time`
   - Hours display shows decimal format (e.g., 1.5h, 0.5h, 2h)

3. **Display Status Badges**
   - Status badge shown for each time block with color-coding:
     - `scheduled` → Blue badge
     - `in_progress` → Yellow/amber badge
     - `completed` → Green badge with checkmark
     - `cancelled` → Gray badge with strikethrough
   - Badge displayed inline next to task name or as small icon

### Integration Requirements

4. **Drag-and-Drop Creates Time Blocks**
   - Dropping a task on a time slot calls `useCreateTimeBlock` mutation (not update task fields)
   - Default duration: 60 minutes (1 hour)
   - Default status: `'scheduled'`
   - `end_time` calculated as `start_time + 1 hour`
   - Toast notification: "✓ Task scheduled to [date] at [time]"

5. **Remove Button Deletes Time Block**
   - "Remove from schedule" button calls `useDeleteTimeBlock(blockId)` mutation
   - Does NOT delete the task itself (only removes the time block)
   - Confirmation prompt: "Remove this time block? (Task will not be deleted)"
   - Toast notification: "✓ Time block removed"

6. **Maintains Existing UI/UX**
   - Same visual design (colors, spacing, fonts)
   - Same day navigation (Previous/Today/Next buttons)
   - Same time slots (6 AM - 6 AM, 30-minute intervals)
   - Same drag-and-drop behavior (visual feedback on hover)
   - Same area color-coding for tasks

### Quality Requirements

7. **Timezone Handling Correct**
   - Uses `formatDateString(getTodayNoon())` for today's date (from `dateHelpers.ts`)
   - Date navigation preserves local timezone (no UTC conversion)
   - Time display uses `format(parseISO('2000-01-01T${time}'), 'h:mm a')` pattern

8. **Performance Maintained**
   - Uses existing `useDailySchedule` hook (already optimized with staleTime/refetchInterval)
   - No additional queries introduced
   - Time block creation < 500ms (React Query mutation + cache invalidation)

9. **No Visual Regression**
   - Layout identical to current design
   - Time slots scrollable (6 AM - 6 AM)
   - Current hour highlighted in yellow
   - Responsive design maintained
   - Loading states handled (show skeleton or "Loading...")

---

## Technical Notes

### Integration Approach

**Step 1: Update Component Interface**

```typescript
// Change from TaskHub[] to using hook
interface DailySchedulePanelProps {
  // Remove: scheduledTasks: TaskHub[];
  // Remove: onSaveSchedule
  // Keep: onTaskDrop callback (but change implementation)
  onTaskDrop: (taskId: string, date: string, time: string) => void;
  // Keep: onTaskRemove callback (but change to use blockId)
  onTaskRemove: (blockId: string) => void;
  className?: string;
}
```

**Step 2: Use useDailySchedule Hook**

```typescript
export const DailySchedulePanel: FC<DailySchedulePanelProps> = ({
  onTaskDrop,
  onTaskRemove,
  className = '',
}) => {
  const [selectedDate, setSelectedDate] = useState<Date>(getTodayLocal());

  // NEW: Fetch time blocks from database
  const { data: timeBlocks = [], isLoading } = useDailySchedule(selectedDate);

  // Group time blocks by start time
  const blocksByTime: Record<string, DailyScheduleBlock[]> = {};
  timeBlocks.forEach((block) => {
    const time = block.start_time.substring(0, 5); // HH:MM
    if (!blocksByTime[time]) {
      blocksByTime[time] = [];
    }
    blocksByTime[time].push(block);
  });

  // Render time slots with blocks
  return (
    <Card>
      {isLoading ? (
        <div>Loading schedule...</div>
      ) : (
        TIME_SLOTS.map((time) => (
          <TimeSlot
            key={time}
            time={time}
            blocks={blocksByTime[time] || []}
            date={selectedDate}
            onTaskDrop={onTaskDrop}
            onBlockRemove={onTaskRemove}
          />
        ))
      )}
    </Card>
  );
};
```

**Step 3: Update TimeSlot to Display Time Blocks**

```typescript
interface TimeSlotProps {
  time: string;
  blocks: DailyScheduleBlock[]; // Changed from tasks: TaskHub[]
  date: Date;
  onTaskDrop: (taskId: string, date: string, time: string) => void;
  onBlockRemove: (blockId: string) => void;
}

const TimeSlot: FC<TimeSlotProps> = ({ time, blocks, date, onTaskDrop, onBlockRemove }) => {
  // ...existing drag-drop logic...

  return (
    <div>
      <div className="time-label">{format(parseISO(`2000-01-01T${time}`), 'h:mm a')}</div>

      <div className="blocks-container">
        {blocks.length === 0 ? (
          <div>Drop task here</div>
        ) : (
          blocks.map((block) => (
            <div key={block.block_id} className="time-block">
              {/* Status Badge */}
              <Badge className={getStatusColor(block.status)}>
                {getStatusIcon(block.status)} {block.status}
              </Badge>

              {/* Task Name with Color */}
              <Badge style={{ backgroundColor: getAreaColor(block.area) }}>
                {block.task_name}
              </Badge>

              {/* Duration Display */}
              <span className="duration">
                {format(parseISO(`2000-01-01T${block.start_time}`), 'h:mm a')} -
                {format(parseISO(`2000-01-01T${block.end_time}`), 'h:mm a')}
                ({calculateDuration(block.start_time, block.end_time)})
              </span>

              {/* Remove Button */}
              <button onClick={() => onBlockRemove(block.block_id)}>
                <X />
              </button>
            </div>
          ))
        )}
      </div>
    </div>
  );
};
```

**Step 4: Update Parent Component (TasksHub or App.tsx)**

```typescript
// In parent component that renders DailySchedulePanel
const createTimeBlock = useCreateTimeBlock();
const deleteTimeBlock = useDeleteTimeBlock();

const handleTaskDrop = async (taskId: string, date: string, time: string) => {
  try {
    await createTimeBlock.mutateAsync({
      taskId,
      scheduledDate: parseISO(date),
      startTime: `${time}:00`, // HH:MM:SS format
      endTime: format(addMinutes(parseISO(`${date}T${time}`), 60), 'HH:mm:ss'),
      plannedDurationMinutes: 60,
    });
    // Toast: "✓ Task scheduled"
  } catch (error) {
    console.error('Failed to schedule task:', error);
    // Toast: "✗ Failed to schedule task"
  }
};

const handleBlockRemove = async (blockId: string) => {
  if (!confirm('Remove this time block? (Task will not be deleted)')) return;

  try {
    await deleteTimeBlock.mutateAsync(blockId);
    // Toast: "✓ Time block removed"
  } catch (error) {
    console.error('Failed to remove block:', error);
    // Toast: "✗ Failed to remove block"
  }
};

<DailySchedulePanel
  onTaskDrop={handleTaskDrop}
  onTaskRemove={handleBlockRemove}
/>
```

### Helper Functions

```typescript
// Calculate duration in hours
const calculateDuration = (startTime: string, endTime: string): string => {
  const start = parseISO(`2000-01-01T${startTime}`);
  const end = parseISO(`2000-01-01T${endTime}`);
  const minutes = differenceInMinutes(end, start);
  const hours = minutes / 60;

  if (hours === 1) return '1h';
  if (hours < 1) return `${minutes}m`;
  return `${hours.toFixed(1)}h`;
};

// Get status badge color
const getStatusColor = (status: TimeBlockStatus): string => {
  switch (status) {
    case 'scheduled': return 'bg-blue-500/20 text-blue-400';
    case 'in_progress': return 'bg-yellow-500/20 text-yellow-400';
    case 'completed': return 'bg-green-500/20 text-green-400';
    case 'cancelled': return 'bg-gray-500/20 text-gray-400';
    default: return 'bg-gray-500/20 text-gray-400';
  }
};

// Get status icon
const getStatusIcon = (status: TimeBlockStatus): React.ReactNode => {
  switch (status) {
    case 'in_progress': return <Clock className="w-3 h-3" />;
    case 'completed': return <CheckCircle className="w-3 h-3" />;
    case 'cancelled': return <XCircle className="w-3 h-3" />;
    default: return null;
  }
};

// Get area color (reuse existing function)
const getAreaColor = (area: string): string => {
  // ... existing color mapping ...
};
```

### Existing Pattern Reference

- **Calendar Integration:** `src/pages/Calendar.tsx` - Uses `useCalendarView` hook
- **Time Block Management:** `src/hooks/useCalendar.ts` - All mutation hooks available
- **Timezone Helpers:** `src/utils/dateHelpers.ts` - Use `formatDateString`, `getTodayNoon`, `parseLocalDate`
- **Type Definitions:** `src/types/calendar.ts` - `DailyScheduleBlock`, `TimeBlockStatus`

### Key Constraints

1. **No Breaking Changes to Parent Components**
   - Update `DailySchedulePanel` interface carefully
   - Parent component (TasksHub or App.tsx) must pass new callbacks
   - Ensure drag-and-drop still works from Tasks list

2. **Preserve Existing UI Design**
   - Match current color scheme exactly
   - Maintain current spacing/padding
   - Keep same time slot height and scroll behavior

3. **Timezone Safety**
   - Always use `formatDateString(getTodayNoon())` for today
   - Use `parseLocalDate()` for user-entered dates
   - Display times with `format(parseISO(...), 'h:mm a')`

4. **Performance**
   - `useDailySchedule` already has optimized caching (1 minute staleTime)
   - React Query handles cache invalidation automatically
   - No need for manual refetching

---

## Definition of Done

- [x] **Component refactored:**
  - `DailySchedulePanel.tsx` uses `useDailySchedule` hook
  - Interface updated to accept new callbacks
  - Time blocks displayed instead of tasks

- [x] **Duration display implemented:**
  - Format: "9:00 AM - 10:30 AM (1.5h)"
  - Duration calculated from start/end times
  - Handles edge cases (< 1 hour shows minutes)

- [x] **Status badges implemented:**
  - Color-coded badges for all 4 statuses
  - Icons shown for in_progress, completed, cancelled
  - Badges positioned inline with task name

- [x] **Drag-and-drop creates time blocks:**
  - `useCreateTimeBlock` mutation called on drop
  - Default 60-minute duration
  - Toast notifications shown
  - Error handling implemented

- [x] **Remove button deletes time blocks:**
  - `useDeleteTimeBlock` mutation called
  - Confirmation prompt shown
  - Task itself not deleted (only time block)
  - Toast notifications shown

- [x] **No visual regression:**
  - Layout identical to before
  - Colors match existing design
  - Time slots scrollable
  - Current hour highlighted
  - Responsive design maintained

- [x] **Timezone handling verified:**
  - Uses approved helpers from `dateHelpers.ts`
  - Date navigation preserves local timezone
  - Time display correct across day boundaries

- [x] **Parent component updated:**
  - TasksHub or App.tsx passes new callbacks
  - `onTaskDrop` calls `useCreateTimeBlock`
  - `onTaskRemove` calls `useDeleteTimeBlock`

- [x] **Error handling implemented:**
  - Loading states shown
  - Error states handled gracefully
  - Toast notifications for success/failure

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Breaking drag-and-drop functionality or visual layout

**Mitigation:**
- Refactor incrementally (fetch data first, then update display, then update handlers)
- Test drag-and-drop thoroughly after each change
- Keep existing helper functions (getBusinessColor, etc.)
- Use feature flag if needed for gradual rollout

**Rollback:**
- Git revert to previous component version
- Time blocks remain in database (migration not affected)
- Can re-attempt refactoring with fixes

### Compatibility Verification

- [x] **No breaking changes to existing APIs**
  - `useDailySchedule` hook already exists and works
  - No database schema changes needed
  - Parent component interface clearly defined

- [x] **Database changes are additive only**
  - No database changes in this story (only UI)

- [x] **UI changes follow existing design patterns**
  - Uses same Card, Button, Badge components
  - Uses same color scheme and spacing
  - Matches Calendar page design patterns

- [x] **Performance impact is negligible**
  - `useDailySchedule` already optimized
  - No additional queries
  - React Query caching handles efficiency

---

## Validation Checklist

### Scope Validation

- [x] **Story can be completed in one development session** ✅
  - Component refactoring: ~2 hours
  - UI updates (duration, status): ~1 hour
  - Handler updates (callbacks): ~1 hour
  - Testing: ~1 hour
  - Total: ~5 hours

- [x] **Integration approach is straightforward** ✅
  - Hook already exists (`useDailySchedule`)
  - Mutation hooks already exist
  - Clear data transformation path

- [x] **Follows existing patterns exactly** ✅
  - Calendar page uses same hooks
  - TasksHub uses same mutation pattern
  - Same timezone handling approach

- [x] **No design or architecture work required** ✅
  - All infrastructure already built
  - Just connecting existing pieces

### Clarity Check

- [x] **Story requirements are unambiguous** ✅
  - Clear visual mockup in acceptance criteria
  - Specific format for duration display
  - Exact status badge behavior defined

- [x] **Integration points are clearly specified** ✅
  - Hook: `useDailySchedule(date)`
  - Mutations: `useCreateTimeBlock`, `useDeleteTimeBlock`
  - Parent callbacks documented

- [x] **Success criteria are testable** ✅
  - Visual inspection of duration display
  - Manual test of drag-and-drop
  - Manual test of remove button
  - Timezone verification with date navigation

- [x] **Rollback approach is simple** ✅
  - Git revert component file
  - No database impact
  - Can re-attempt with fixes

---

## Next Steps

After Story 6.2 is complete:
- **Story 6.3:** Implement real-time sync between Calendar and Daily Schedule

**Dependencies:**
- Story 6.3 depends on 6.2 completing (UI must query time blocks before sync can work)

---

## Files to Modify

### Modified Files:
- `src/components/tasks/DailySchedulePanel.tsx` (refactor to use time blocks)
- Parent component rendering DailySchedulePanel (update callbacks):
  - Check: `src/pages/TasksHub.tsx` OR `src/App.tsx` (wherever it's currently used)

### Reference Files (read-only):
- `src/hooks/useCalendar.ts` (hooks to use)
- `src/types/calendar.ts` (DailyScheduleBlock type)
- `src/utils/dateHelpers.ts` (timezone helpers)
- `src/pages/Calendar.tsx` (example of using calendar hooks)
- `src/components/calendar/MasterCalendar.tsx` (example of time block display)

### New Helper Functions (add to DailySchedulePanel.tsx):
- `calculateDuration(startTime, endTime)` → string
- `getStatusColor(status)` → string (CSS classes)
- `getStatusIcon(status)` → React.ReactNode