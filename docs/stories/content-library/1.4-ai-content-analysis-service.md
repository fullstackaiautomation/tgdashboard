# Story 1.4: AI Content Analysis Service Layer

**Epic**: AI-Powered Content Library Enhancement
**Story ID**: 1.4
**Priority**: High
**Estimated Effort**: Large (6-8 hours)

---

## User Story

**As a** developer,
**I want** a reliable AI service layer for extracting content metadata from URLs,
**so that** the system can auto-populate content details accurately and efficiently.

---

## Acceptance Criteria

1. ✅ Create Supabase Edge Function `analyze-content` for AI processing
2. ✅ Function accepts URL as input parameter
3. ✅ Function uses Jina AI Reader API to fetch clean content from URL
4. ✅ Function uses OpenAI GPT-4o-mini to generate:
   - Title (extract or generate)
   - AI summary (2-3 sentences)
   - Creator/author name
   - Estimated time to consume (in minutes)
   - Content source/platform detection
5. ✅ Function extracts thumbnail image URL (og:image, twitter:image, or first large image)
6. ✅ Function returns structured JSON with all extracted fields
7. ✅ Implement timeout (10 seconds max) and error handling
8. ✅ Function handles failures gracefully, returns partial data or error message
9. ✅ API keys stored securely in Supabase Edge Function secrets

---

## Integration Verification

**IV1**: Edge Function deployment doesn't affect existing Supabase queries or auth
**IV2**: Function respects Supabase RLS - only processes requests for authenticated users
**IV3**: Error responses from Edge Function don't break frontend UX

---

## Technical Implementation Details

### Supabase Edge Function Structure

**File**: `supabase/functions/analyze-content/index.ts`

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const JINA_API_URL = 'https://r.jina.ai/'
const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions'

interface AnalyzeRequest {
  url: string
}

interface AnalyzeResponse {
  success: boolean
  data?: {
    title: string
    ai_summary: string
    creator?: string
    time_to_consume?: number
    source: string
    thumbnail_url?: string
  }
  error?: string
}

serve(async (req) => {
  try {
    // Verify authentication
    const authHeader = req.headers.get('Authorization')!
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: authHeader } } }
    )

    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
      return new Response(JSON.stringify({ success: false, error: 'Unauthorized' }), {
        status: 401,
        headers: { 'Content-Type': 'application/json' }
      })
    }

    // Parse request
    const { url }: AnalyzeRequest = await req.json()

    if (!url) {
      return new Response(JSON.stringify({ success: false, error: 'URL is required' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' }
      })
    }

    // Step 1: Fetch content with Jina AI Reader
    const jinaResponse = await fetch(`${JINA_API_URL}${url}`, {
      signal: AbortSignal.timeout(8000) // 8 second timeout for fetching
    })

    if (!jinaResponse.ok) {
      throw new Error(`Jina AI failed: ${jinaResponse.statusText}`)
    }

    const contentMarkdown = await jinaResponse.text()

    // Step 2: Extract metadata with OpenAI
    const openaiResponse = await fetch(OPENAI_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${Deno.env.get('OPENAI_API_KEY')}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [{
          role: 'system',
          content: 'You are a content analyzer. Extract metadata from the provided content and return ONLY valid JSON with no markdown formatting.'
        }, {
          role: 'user',
          content: `Analyze this content and return JSON with:
- title (string): The article/video title
- summary (string): 2-3 sentence summary of the main points
- creator (string|null): Author or creator name
- timeToConsume (number|null): Estimated reading/watching time in minutes
- source (string): Platform type (Twitter, YouTube, Article, Instagram, LinkedIn, Podcast, Video, Book, Other)
- thumbnailUrl (string|null): Main image URL if found in content

Content to analyze (first 3000 chars):
${contentMarkdown.slice(0, 3000)}

Return ONLY valid JSON, no markdown code blocks.`
        }],
        temperature: 0.3,
        max_tokens: 500
      }),
      signal: AbortSignal.timeout(5000) // 5 second timeout for OpenAI
    })

    if (!openaiResponse.ok) {
      throw new Error(`OpenAI failed: ${openaiResponse.statusText}`)
    }

    const openaiData = await openaiResponse.json()
    const aiResult = JSON.parse(openaiData.choices[0].message.content)

    // Step 3: Return structured response
    const result: AnalyzeResponse = {
      success: true,
      data: {
        title: aiResult.title || 'Untitled Content',
        ai_summary: aiResult.summary || '',
        creator: aiResult.creator || undefined,
        time_to_consume: aiResult.timeToConsume || undefined,
        source: aiResult.source || 'Other',
        thumbnail_url: aiResult.thumbnailUrl || undefined
      }
    }

    return new Response(JSON.stringify(result), {
      headers: { 'Content-Type': 'application/json' }
    })

  } catch (error) {
    console.error('Error analyzing content:', error)

    return new Response(JSON.stringify({
      success: false,
      error: error.message || 'Failed to analyze content'
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    })
  }
})
```

---

### Frontend Hook

**File**: `src/hooks/useAIAnalysis.ts`

```typescript
import { useState } from 'react'
import { supabase } from '../lib/supabase'

interface AIAnalysisResult {
  title: string
  ai_summary: string
  creator?: string
  time_to_consume?: number
  source: string
  thumbnail_url?: string
}

export const useAIAnalysis = () => {
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const analyzeURL = async (url: string): Promise<AIAnalysisResult | null> => {
    setLoading(true)
    setError(null)

    try {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) throw new Error('Not authenticated')

      const response = await fetch(
        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/analyze-content`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({ url })
        }
      )

      const result = await response.json()

      if (!result.success) {
        throw new Error(result.error || 'Analysis failed')
      }

      return result.data
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Failed to analyze URL'
      setError(errorMessage)
      return null
    } finally {
      setLoading(false)
    }
  }

  return { analyzeURL, loading, error }
}
```

---

## Environment Setup

### Supabase Edge Function Secrets
```bash
# Set OpenAI API key
supabase secrets set OPENAI_API_KEY=sk-...

# Verify secrets
supabase secrets list
```

### Frontend Environment Variables
```env
# .env.local
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
```

---

## Deployment

### Deploy Edge Function
```bash
# Login to Supabase
supabase login

# Link project
supabase link --project-ref your-project-ref

# Deploy function
supabase functions deploy analyze-content
```

---

## Testing Checklist

- [ ] Edge Function deploys successfully
- [ ] Function authenticates users correctly
- [ ] Jina AI Reader fetches content from various URL types
- [ ] OpenAI extracts metadata accurately
- [ ] Function returns structured JSON response
- [ ] Timeout handling works (10 second max)
- [ ] Error responses are user-friendly
- [ ] Partial data returned when some extraction fails
- [ ] Frontend hook calls Edge Function correctly
- [ ] Loading state displays during analysis
- [ ] Error state displays on failure
- [ ] Success state populates form with AI data

### Test URLs
- YouTube video
- Twitter/X post
- Medium article
- Instagram post
- LinkedIn article
- General blog post

---

## Cost Estimation

### Per Analysis
- **Jina AI**: Free tier (100 requests/day, unlimited with account)
- **OpenAI GPT-4o-mini**: ~$0.0001 per request (~300 tokens)

### Monthly Estimate (100 analyses)
- **Total**: ~$0.01/month (negligible)

---

## Error Handling

### Common Errors
1. **Invalid URL**: Return error message "Invalid URL provided"
2. **URL unreachable**: Return error "Unable to fetch content from URL"
3. **AI timeout**: Return partial data with warning
4. **OpenAI rate limit**: Return error "Analysis service temporarily unavailable"
5. **Missing API key**: Return error "Service configuration error"

---

## Dependencies

- Supabase CLI (for deployment)
- OpenAI API account and key
- Jina AI (no key required for basic usage)

---

## Files to Create

**New Files**:
- `supabase/functions/analyze-content/index.ts`
- `src/hooks/useAIAnalysis.ts`

---

## Definition of Done

- [ ] Edge Function created and tested locally
- [ ] Edge Function deployed to Supabase
- [ ] OpenAI API key configured in secrets
- [ ] Frontend hook created and tested
- [ ] Authentication verification working
- [ ] Timeout handling implemented
- [ ] Error handling comprehensive
- [ ] Test coverage for various URL types
- [ ] All integration verification tests pass
- [ ] Documentation updated with setup instructions
- [ ] Code reviewed and merged

---

**Story Status**: Ready for Development
**Assigned To**: TBD
**Started**: TBD
**Completed**: TBD
