# Story 2.4: Business Area Progress Dashboard

## Status
Draft

## Story
**As a** consultant managing 5 businesses simultaneously,
**I want** each Business page to show aggregate progress across all projects,
**so that** I can see business-level health and identify which businesses need attention.

## Acceptance Criteria
1. Each Business page (Full Stack AI, Service SaaS, Huge Capital, S4, 808) displays aggregate metrics at top:
   - Total projects count
   - Overall completion % (average of all project %)
   - Active tasks count vs. completed tasks count
   - Hours invested (from Deep Work log)
2. Business page shows list of projects sorted by % complete (least complete first to highlight what needs attention)
3. Business area cards in Tasks Hub and Daily pages display mini progress indicator showing business health
4. Business filter buttons in Daily To-Do List show completion % next to task count (e.g., "Huge Capital (7) - 45%")
5. Stalled businesses (no task activity in 14+ days) are flagged prominently
6. Business comparison view shows all 5 businesses side-by-side with progress bars for relative comparison
7. Color coding remains consistent: business-specific colors with progress gradient overlay

## Tasks / Subtasks
- [ ] Task 1: Create useBusinessProgress hook for aggregate metrics (AC: 1, 2, 5)
  - [ ] Create src/hooks/useBusinessProgress.ts hook
  - [ ] Calculate total projects count for business
  - [ ] Calculate overall completion: average of all project progress percentages
  - [ ] Calculate active tasks: count where progress_percentage < 100
  - [ ] Calculate completed tasks: count where progress_percentage = 100
  - [ ] Query Deep Work log for hours invested (sum duration_minutes / 60)
  - [ ] Detect stalled business: no task updates in 14+ days across ALL projects
  - [ ] Return { projectCount, overallProgress, activeTasks, completedTasks, hoursInvested, isStalled, daysSinceActivity }
- [ ] Task 2: Build BusinessMetrics component for aggregate display (AC: 1)
  - [ ] Create src/components/business/BusinessMetrics.tsx component
  - [ ] Display 4 metric cards in grid layout: Projects, Completion %, Tasks, Hours
  - [ ] Projects card: show total count with icon (e.g., "12 Projects")
  - [ ] Completion card: large ProgressBar (from Story 2.2) with % label
  - [ ] Tasks card: show "X active / Y completed" split
  - [ ] Hours card: show total hours invested from Deep Work log
  - [ ] Use Lucide icons: Briefcase (projects), CheckCircle (tasks), Clock (hours)
  - [ ] Style as prominent dashboard section at top of Business page
- [ ] Task 3: Update Business page to display metrics and sorted projects (AC: 1, 2)
  - [ ] Update src/components/business/BusinessDashboard.tsx to include BusinessMetrics
  - [ ] Call useBusinessProgress(businessId) to get aggregate data
  - [ ] Display BusinessMetrics component at top of page
  - [ ] Sort projects by progress percentage: ascending (least complete first)
  - [ ] Add sort toggle: "Show most complete first" option
  - [ ] Highlight projects needing attention (<33% progress) with warning color
- [ ] Task 4: Add mini progress indicators to business cards (AC: 3)
  - [ ] Update business area cards in Tasks Hub filters (src/components/tasks/TaskFilters.tsx)
  - [ ] Update business area cards in Daily page (src/components/daily/DailyPage.tsx)
  - [ ] Add small ProgressBar (size='sm') to each business filter button
  - [ ] Show business completion % next to business name
  - [ ] Use business-specific color with progress gradient overlay
  - [ ] Example display: "Huge Capital - 67%" with small green progress bar
- [ ] Task 5: Update Daily To-Do List business filters with progress (AC: 4)
  - [ ] Update src/components/daily/TodoList.tsx business filter buttons
  - [ ] Display format: "Business Name (task_count) - progress%"
  - [ ] Example: "Huge Capital (7) - 45%" with yellow progress indicator
  - [ ] Calculate progress for business tasks in Daily view specifically
  - [ ] Use same color coding: business color + progress gradient
  - [ ] Make filter buttons slightly larger to accommodate progress display
- [ ] Task 6: Implement stalled business detection and warning (AC: 5)
  - [ ] In useBusinessProgress hook, check if daysSinceActivity > 14
  - [ ] Add warning banner at top of Business page if stalled
  - [ ] Display message: "⚠️ No activity in X days - This business needs attention"
  - [ ] Use orange/red background with AlertTriangle icon
  - [ ] Show last activity date: "Last task update: Oct 1, 2025"
  - [ ] Add quick action button: "Add New Task" to jumpstart activity
- [ ] Task 7: Build Business Comparison View (AC: 6)
  - [ ] Create src/components/business/BusinessComparison.tsx component
  - [ ] Add route for /business/compare path
  - [ ] Fetch progress data for all 5 businesses: Full Stack AI, Service SaaS, Huge Capital, S4, 808
  - [ ] Display businesses in side-by-side cards with progress bars
  - [ ] Show key metrics for each: project count, completion %, active tasks
  - [ ] Sort by completion % (least to most) to highlight which need attention
  - [ ] Add link from each business card to individual Business Dashboard
  - [ ] Use consistent color coding with business-specific colors
- [ ] Task 8: Ensure color consistency across all business displays (AC: 7)
  - [ ] Verify business colors from Story 1.1 applied everywhere
  - [ ] Full Stack AI: green (#10b981)
  - [ ] Service SaaS: (define color if not exists)
  - [ ] Huge Capital: purple (#a855f7)
  - [ ] S4: blue (#3b82f6)
  - [ ] 808: orange (#f97316)
  - [ ] Apply progress gradient overlay: use business color as base, overlay red/yellow/green based on progress
  - [ ] Test color accessibility: ensure text readable on all background combinations
  - [ ] Update CSS theme variables if needed (src/styles/theme.css)

## Dev Notes

### Previous Story Insights
**From Story 2.1:** [Source: docs/stories/2.1.task-level-progress-calculation.md]
- progress_percentage field on tasks table
- Task-level progress indicators functional
- Real-time sync established

**From Story 2.2:** [Source: docs/stories/2.2.phase-level-progress-calculation.md]
- usePhaseProgress hook calculates phase completion
- ProgressBar component with size variants (sm, md, lg)
- Progress color utilities in src/utils/progressColors.ts

**From Story 2.3:** [Source: docs/stories/2.3.project-level-progress-visualization.md]
- useProjectProgress hook calculates project completion
- Velocity and stalled project detection implemented
- ProjectCard displays progress prominently

**From Story 1.1:** [Source: docs/stories/1.1.tasks-hub-page-structure.md]
- Business colors defined in src/styles/theme.css
- TaskFilters component has business filter buttons
- Business Dashboard page exists

**Key Technical Decisions:**
- Business progress is average of all project progress percentages (not simple task ratio)
- Stalled threshold for businesses is 14 days (longer than 7-day project threshold) since businesses span multiple projects
- Deep Work hours integration requires querying separate deep_work_sessions table
- Sort by least complete first (ascending) to surface what needs attention

### Architecture Context

**Tech Stack:** [Source: docs/ui-architecture/2-frontend-tech-stack.md]
- React 19.1.1 + TypeScript 5.9.3
- TanStack Query 5.90.2
- Tailwind CSS 3.4.1
- Lucide React 0.544.0

**Business Progress Calculation Pattern:**
```typescript
// src/hooks/useBusinessProgress.ts
interface BusinessProgress {
  businessId: string;
  projectCount: number;
  overallProgress: number;
  activeTasks: number;
  completedTasks: number;
  hoursInvested: number;
  isStalled: boolean;
  daysSinceActivity: number;
  lastActivityDate: Date | null;
}

export const useBusinessProgress = (businessId: string): BusinessProgress => {
  const { data: businessData } = useQuery({
    queryKey: ['business', businessId, 'progress'],
    queryFn: async () => {
      // Fetch all projects for this business with nested phases and tasks
      const { data: projects, error: projectsError } = await supabase
        .from('projects')
        .select(`
          id,
          phases(
            id,
            tasks(id, progress_percentage, updated_at)
          ),
          tasks(id, progress_percentage, updated_at)
        `)
        .eq('business_id', businessId);

      if (projectsError) throw projectsError;

      // Fetch Deep Work hours
      const { data: deepWork, error: deepWorkError } = await supabase
        .from('deep_work_sessions')
        .select('duration_minutes')
        .eq('business_id', businessId);

      if (deepWorkError) throw deepWorkError;

      return { projects, deepWork };
    },
  });

  return useMemo(() => {
    if (!businessData) return defaultBusinessProgress;

    const { projects, deepWork } = businessData;

    // Calculate project progress for each project
    const projectProgresses = projects.map(project => {
      const hasPhases = project.phases && project.phases.length > 0;
      if (hasPhases) {
        const phaseProgresses = project.phases.map(phase => {
          const tasks = phase.tasks || [];
          return tasks.length > 0
            ? tasks.reduce((sum, t) => sum + t.progress_percentage, 0) / tasks.length
            : 0;
        });
        return phaseProgresses.reduce((sum, p) => sum + p, 0) / phaseProgresses.length;
      } else {
        const tasks = project.tasks || [];
        return tasks.length > 0
          ? tasks.reduce((sum, t) => sum + t.progress_percentage, 0) / tasks.length
          : 0;
      }
    });

    const overallProgress = projectProgresses.length > 0
      ? projectProgresses.reduce((sum, p) => sum + p, 0) / projectProgresses.length
      : 0;

    // Aggregate all tasks
    const allTasks = projects.flatMap(p =>
      p.phases?.length > 0
        ? p.phases.flatMap(ph => ph.tasks || [])
        : p.tasks || []
    );

    const activeTasks = allTasks.filter(t => t.progress_percentage < 100).length;
    const completedTasks = allTasks.filter(t => t.progress_percentage === 100).length;

    // Calculate hours invested
    const hoursInvested = deepWork.reduce((sum, session) => sum + session.duration_minutes, 0) / 60;

    // Stalled detection (14+ days)
    const lastActivity = allTasks.length > 0
      ? new Date(Math.max(...allTasks.map(t => new Date(t.updated_at).getTime())))
      : null;
    const daysSinceActivity = lastActivity
      ? (Date.now() - lastActivity.getTime()) / (1000 * 60 * 60 * 24)
      : Infinity;
    const isStalled = daysSinceActivity > 14;

    return {
      businessId,
      projectCount: projects.length,
      overallProgress: Math.round(overallProgress * 10) / 10,
      activeTasks,
      completedTasks,
      hoursInvested: Math.round(hoursInvested * 10) / 10,
      isStalled,
      daysSinceActivity: Math.round(daysSinceActivity),
      lastActivityDate: lastActivity,
    };
  }, [businessData, businessId]);
};
```

**BusinessMetrics Component:**
```typescript
// src/components/business/BusinessMetrics.tsx
import { FC } from 'react';
import { Briefcase, CheckCircle, Clock, TrendingUp } from 'lucide-react';
import { ProgressBar } from '@/components/shared/ProgressBar';

interface BusinessMetricsProps {
  projectCount: number;
  overallProgress: number;
  activeTasks: number;
  completedTasks: number;
  hoursInvested: number;
}

export const BusinessMetrics: FC<BusinessMetricsProps> = ({
  projectCount,
  overallProgress,
  activeTasks,
  completedTasks,
  hoursInvested,
}) => {
  return (
    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      {/* Projects */}
      <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div className="flex items-center gap-3 mb-2">
          <Briefcase className="text-blue-500" size={24} />
          <span className="text-gray-400 text-sm">Projects</span>
        </div>
        <div className="text-3xl font-bold text-white">{projectCount}</div>
      </div>

      {/* Overall Progress */}
      <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div className="flex items-center gap-3 mb-2">
          <TrendingUp className="text-green-500" size={24} />
          <span className="text-gray-400 text-sm">Completion</span>
        </div>
        <div className="text-3xl font-bold text-white mb-2">{overallProgress.toFixed(1)}%</div>
        <ProgressBar progress={overallProgress} size="sm" showLabel={false} />
      </div>

      {/* Tasks */}
      <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div className="flex items-center gap-3 mb-2">
          <CheckCircle className="text-purple-500" size={24} />
          <span className="text-gray-400 text-sm">Tasks</span>
        </div>
        <div className="text-xl font-bold text-white">
          {activeTasks} active / {completedTasks} done
        </div>
      </div>

      {/* Hours Invested */}
      <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div className="flex items-center gap-3 mb-2">
          <Clock className="text-orange-500" size={24} />
          <span className="text-gray-400 text-sm">Hours Invested</span>
        </div>
        <div className="text-3xl font-bold text-white">{hoursInvested.toFixed(1)}</div>
      </div>
    </div>
  );
};
```

**Database Schema Note:**
Story assumes deep_work_sessions table exists with: id, user_id, business_id, duration_minutes, created_at. If this table doesn't exist yet, create migration or stub out hours calculation to return 0 for now.

**File Locations:**
- Create: src/hooks/useBusinessProgress.ts
- Create: src/components/business/BusinessMetrics.tsx
- Create: src/components/business/BusinessComparison.tsx
- Update: src/components/business/BusinessDashboard.tsx
- Update: src/components/tasks/TaskFilters.tsx (add mini progress to business filters)
- Update: src/components/daily/DailyPage.tsx (add progress to business cards)
- Update: src/components/daily/TodoList.tsx (update business filter button format)
- Reuse: src/components/shared/ProgressBar.tsx (from Story 2.2)
- Reuse: src/utils/progressColors.ts (from Story 2.2)

### Testing

**Testing Requirements:**
1. Verify all 7 acceptance criteria
2. Test aggregate metrics: create business with 3 projects at 100%, 50%, 0% → verify shows 50% overall
3. Test active vs completed tasks: create 10 tasks (6 complete, 4 active) → verify displays "4 active / 6 done"
4. Test Deep Work hours: add 5 sessions at 60 min each → verify shows "5.0 hours"
5. Test project sorting: verify projects sorted by progress % (least complete first)
6. Test mini progress indicators: verify business filters in Tasks Hub show progress bars
7. Test Daily filter buttons: verify format "Business (7) - 45%"
8. Test stalled detection: create business with no updates in 15 days → verify warning banner
9. Test Business Comparison view: verify all 5 businesses display side-by-side with correct progress
10. Test color consistency: verify business colors applied correctly everywhere
11. Test real-time updates: update task → verify business progress recalculates in <500ms

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | v1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
