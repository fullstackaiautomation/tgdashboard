# Story 5.6: Review Dashboard Intelligence & Alerts

## Status
Ready for Development

## Story
**As a** busy operator with limited attention,
**I want** the Review dashboard to highlight what needs attention most urgently,
**so that** I can focus on critical items without analyzing every metric.

## Acceptance Criteria
1. "Needs Attention" section at top of Review dashboard showing prioritized alerts:
   - Overdue tasks (sorted by days overdue)
   - Stalled projects (no activity 7+ days)
   - Health neglect warnings (below target for 2+ weeks)
   - Budget overruns or financial anomalies
   - Businesses with zero hours this week
2. Alert severity levels: Critical (immediate action), Warning (review soon), Info (FYI)
3. Each alert is actionable: click to navigate directly to the item needing attention
4. "All Clear" state: if no alerts, display positive message: "Everything on track - no urgent items"
5. Alert dismissal: ability to acknowledge alerts that are expected/acceptable (e.g., "808 has zero hours this week - intentional")
6. Weekly summary: collapsible section showing week-over-week changes:
   - Completion % change: "65% this week (up from 58% last week)"
   - Time allocation shifts: "15% more hours on Huge Capital this week"
   - Progress velocity: "Completed 12 more tasks than last week"
7. Smart recommendations: "Based on current progress, you'll complete Huge Capital project by Friday - on track for deadline"
8. Morning briefing mode: Review dashboard shows different view in morning vs. evening (morning: today's focus, evening: tomorrow's plan)
9. Customizable alerts: ability to set custom thresholds for warnings (e.g., "Alert me if any business gets <2h per week")

## Tasks / Subtasks
- [ ] Task 1: Create intelligent alert detection system (AC: 1, 2)
  - [ ] Create src/hooks/useReviewAlerts.ts hook
  - [ ] Query overdue tasks across all areas: WHERE due_date < NOW() AND progress < 100
  - [ ] Calculate days overdue: EXTRACT(DAY FROM (NOW() - due_date))
  - [ ] Query stalled projects: WHERE MAX(task.updated_at) < NOW() - 7 days
  - [ ] Query health neglect: WHERE health_hours < target × 0.8 for 14+ days
  - [ ] Query budget overruns: WHERE expenses > budget
  - [ ] Query zero-hour businesses: WHERE business.hours_this_week = 0
  - [ ] Classify alert severity:
    - Critical: overdue >7 days, budget >110%, health <50% target for 2+ weeks
    - Warning: overdue 3-7 days, stalled projects, zero hours, budget 90-110%
    - Info: overdue <3 days, low progress but active
  - [ ] Return Alert[] sorted by severity then urgency

- [ ] Task 2: Build NeedsAttentionSection component (AC: 1, 3, 4)
  - [ ] Create src/components/review/NeedsAttentionSection.tsx
  - [ ] Display at top of Review dashboard above area cards
  - [ ] Show alert count: "5 items need attention"
  - [ ] List alerts grouped by severity: Critical first, then Warning, then Info
  - [ ] Each alert shows: icon, severity badge, description, action link
  - [ ] Make alerts clickable: navigate to specific task/project/area
  - [ ] "All Clear" state: green banner "Everything on track - no urgent items"
  - [ ] Collapsible: allow hiding section if user wants to focus on overview
  - [ ] Animate entrance: slide down when alerts detected

- [ ] Task 3: Create AlertCard component with actions (AC: 3)
  - [ ] Create src/components/review/AlertCard.tsx
  - [ ] Display alert icon: AlertTriangle (critical), AlertCircle (warning), Info (info)
  - [ ] Color coding: red (critical), yellow (warning), blue (info)
  - [ ] Alert format: "Client deliverable - 5 days overdue"
  - [ ] Action button: "View Task" → navigate to task detail
  - [ ] Show context: which area/business the alert belongs to
  - [ ] Hover effect: highlight border and show quick preview
  - [ ] Accessibility: keyboard navigation, screen reader labels

- [ ] Task 4: Implement alert dismissal system (AC: 5)
  - [ ] Create dismissed_alerts table in database
  - [ ] Add "Dismiss" button on each alert
  - [ ] Dismissal dialog: "Why dismiss? [Expected/Intentional] [Acknowledged] [Not Important]"
  - [ ] Store dismissal: alert_id, reason, dismissed_at, expires_at
  - [ ] Filter dismissed alerts from main list
  - [ ] Dismissal expiry: auto-show again after 7 days
  - [ ] "Show Dismissed" toggle to view acknowledged alerts
  - [ ] Undo dismissal: "This alert was dismissed - Undo?"

- [ ] Task 5: Build weekly summary analytics (AC: 6)
  - [ ] Create src/hooks/useWeeklySummary.ts hook
  - [ ] Query completion % this week vs last week
  - [ ] Calculate week-over-week change: this_week - last_week
  - [ ] Query time allocation per business this week vs last week
  - [ ] Calculate allocation shifts: percentage point changes
  - [ ] Query tasks completed: COUNT(*) FILTER (WHERE completed_at >= week_start)
  - [ ] Calculate progress velocity: tasks_this_week - tasks_last_week
  - [ ] Query Deep Work hours: this week vs last week
  - [ ] Return WeeklySummary interface with all metrics and trends

- [ ] Task 6: Create WeeklySummarySection component (AC: 6)
  - [ ] Create src/components/review/WeeklySummarySection.tsx
  - [ ] Display as collapsible section below Needs Attention
  - [ ] Show completion % trend: "65% this week (↑ from 58% last week)" with arrow
  - [ ] Display time allocation shifts: bar chart comparing this week vs last
  - [ ] Show progress velocity: "Completed 12 more tasks than last week"
  - [ ] Use green for improvements, red for declines
  - [ ] Add context: "You're on a 3-week improvement streak!"
  - [ ] Mini charts: sparklines showing 4-week trends
  - [ ] Expand/collapse with smooth animation

- [ ] Task 7: Build smart recommendations engine (AC: 7)
  - [ ] Create src/utils/smartRecommendations.ts utility
  - [ ] Analyze project progress velocity: tasks_completed / days_elapsed
  - [ ] Project completion date: remaining_tasks / velocity + today
  - [ ] Compare projected vs deadline: on track, ahead, behind
  - [ ] Recommendation format: "Based on current progress, you'll complete [Project] by [Date] - [Status]"
  - [ ] Generate recommendations:
    - "Focus on [Business] - behind schedule by 2 weeks"
    - "Great momentum on [Project] - maintain current pace"
    - "Consider delegating [Task] to meet deadline"
    - "Health hours trending down - schedule workout"
  - [ ] Show top 3 recommendations sorted by impact
  - [ ] Add "Why?" tooltip explaining recommendation logic

- [ ] Task 8: Implement morning vs evening briefing modes (AC: 8)
  - [ ] Create src/utils/briefingMode.ts utility
  - [ ] Detect time of day: morning (6am-12pm), afternoon (12pm-6pm), evening (6pm-12am)
  - [ ] Morning briefing: focus on today's tasks, immediate priorities, schedule
  - [ ] Evening briefing: focus on tomorrow's plan, next week preview, reflections
  - [ ] Adjust alert priorities: morning shows urgent/blocking, evening shows planning
  - [ ] Customize recommendations: morning="tackle high-priority", evening="plan tomorrow"
  - [ ] Change header: "Good morning" vs "Evening review" vs "Good afternoon"
  - [ ] Toggle mode manually: "Switch to Evening Briefing" button

- [ ] Task 9: Create customizable alert thresholds (AC: 9)
  - [ ] Create alert_preferences table: user_id, preference_key, threshold_value
  - [ ] Add Settings page section: "Alert Preferences"
  - [ ] Configurable thresholds:
    - Business min hours/week (default 2h)
    - Health min hours/week (default 4h)
    - Budget warning % (default 90%)
    - Stalled project days (default 7 days)
    - Overdue critical threshold (default 7 days)
  - [ ] UI: sliders or input fields for each threshold
  - [ ] Save preferences to database
  - [ ] Apply custom thresholds in alert detection queries
  - [ ] Reset to defaults button

- [ ] Task 10: Build alert notification system (AC: 1, 2)
  - [ ] Create src/hooks/useAlertNotifications.ts
  - [ ] Check for new critical alerts on dashboard load
  - [ ] Show toast notification: "3 new critical alerts"
  - [ ] Browser notification (if permission granted): "Client deliverable overdue"
  - [ ] Badge on Review nav item: red dot indicating alerts count
  - [ ] Alert sound (optional, user preference): subtle chime for critical
  - [ ] Daily email digest (optional): "Your daily briefing - 5 items need attention"
  - [ ] In-app notification center: bell icon with alert list

## Dev Notes

### Previous Story Insights

**From Story 5.1:** [Source: docs/stories/5.1.review-dashboard-page-structure.md]
- Review dashboard foundation and page structure
- Priority sorting and visual hierarchy
- useReviewDashboard hook for aggregation

**From Story 5.2:** [Source: docs/stories/5.2.daily-area-summary-card.md]
- Overdue task detection and warning systems
- Time-of-day adaptive logic
- Color-coded severity indicators

**From Story 5.3:** [Source: docs/stories/5.3.business-area-summary-card.md]
- Warning detection: zero hours, stalled, overdue
- Warning severity classification
- Business-specific alert patterns

**From Story 5.4:** [Source: docs/stories/5.4.health-content-life-golf-summary-cards.md]
- Health neglect detection: below target for extended periods
- "No recent activity" state detection
- Personal area warning patterns

**From Story 5.5:** [Source: docs/stories/5.5.finances-area-summary-card.md]
- Budget overrun detection and alerts
- Unusual spending anomaly detection
- Financial threshold warnings

**From Epic 2 Stories:** [Source: docs/stories/2.1-2.6]
- Progress calculation and velocity tracking
- Project completion projections
- Week-over-week trend analysis

**From Epic 4 Stories:** [Source: docs/stories/4.1-4.6]
- Time allocation tracking and comparison
- Weekly hours aggregation
- Deep Work session analytics

**Key Technical Context:**
- Intelligence layer is CULMINATION of entire Review Dashboard: synthesizes all alerts
- This is final story of Epic 5: brings everything together
- Alert prioritization is critical: prevents alert fatigue
- Dismissal system prevents false alarms and noise
- Smart recommendations provide actionable guidance, not just data
- Morning vs evening modes adapt to user's workflow rhythm

### Architecture Context

**Tech Stack:** [Source: docs/ui-architecture/2-frontend-tech-stack.md]
- React 19.1.1 + TypeScript 5.9.3
- TanStack Query 5.90.2 for state management
- Framer Motion for alert animations
- Recharts for trend sparklines
- Lucide React 0.544.0 for alert icons
- React Hot Toast for notifications

**Database Schema: Alerts and Preferences**
```sql
-- Dismissed alerts table
CREATE TABLE dismissed_alerts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  alert_type TEXT NOT NULL, -- 'overdue_task', 'stalled_project', 'health_neglect', etc.
  alert_reference_id UUID, -- ID of task/project/business causing alert
  dismissal_reason TEXT,
  dismissed_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '7 days')
);

-- Alert preferences table
CREATE TABLE alert_preferences (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  business_min_hours_week NUMERIC DEFAULT 2.0,
  health_min_hours_week NUMERIC DEFAULT 4.0,
  budget_warning_percentage NUMERIC DEFAULT 90.0,
  stalled_project_days INTEGER DEFAULT 7,
  overdue_critical_days INTEGER DEFAULT 7,
  enable_browser_notifications BOOLEAN DEFAULT false,
  enable_email_digest BOOLEAN DEFAULT false,
  enable_alert_sounds BOOLEAN DEFAULT false,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Weekly summary cache (for performance)
CREATE TABLE weekly_summary_cache (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  week_start_date DATE NOT NULL,
  completion_this_week NUMERIC,
  completion_last_week NUMERIC,
  tasks_completed_this_week INTEGER,
  tasks_completed_last_week INTEGER,
  deep_work_hours_this_week NUMERIC,
  deep_work_hours_last_week NUMERIC,
  time_allocation_shifts JSONB,
  cached_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_dismissed_alerts_user_expires ON dismissed_alerts(user_id, expires_at);
CREATE INDEX idx_weekly_summary_cache_user_date ON weekly_summary_cache(user_id, week_start_date);

-- RLS policies
ALTER TABLE dismissed_alerts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own dismissed alerts"
  ON dismissed_alerts FOR ALL
  USING (auth.uid() = user_id);

ALTER TABLE alert_preferences ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own alert preferences"
  ON alert_preferences FOR ALL
  USING (auth.uid() = user_id);

ALTER TABLE weekly_summary_cache ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can read their own summary cache"
  ON weekly_summary_cache FOR SELECT
  USING (auth.uid() = user_id);
```

**Database Function: Intelligent Alert Detection**
```sql
CREATE OR REPLACE FUNCTION get_review_alerts(p_user_id UUID)
RETURNS TABLE (
  alert_id UUID,
  alert_type TEXT,
  severity TEXT,
  title TEXT,
  description TEXT,
  reference_id UUID,
  reference_type TEXT,
  area TEXT,
  action_url TEXT,
  created_at TIMESTAMPTZ
) AS $$
BEGIN
  RETURN QUERY
  WITH user_prefs AS (
    SELECT * FROM alert_preferences WHERE user_id = p_user_id
  ),
  dismissed AS (
    SELECT alert_reference_id
    FROM dismissed_alerts
    WHERE user_id = p_user_id AND expires_at > NOW()
  ),
  overdue_alerts AS (
    SELECT
      gen_random_uuid() as id,
      'overdue_task'::TEXT as type,
      CASE
        WHEN EXTRACT(DAY FROM (NOW() - t.due_date)) > (SELECT overdue_critical_days FROM user_prefs)
          THEN 'critical'::TEXT
        WHEN EXTRACT(DAY FROM (NOW() - t.due_date)) > 3
          THEN 'warning'::TEXT
        ELSE 'info'::TEXT
      END as severity,
      'Overdue Task'::TEXT as title,
      t.task_name || ' - ' || EXTRACT(DAY FROM (NOW() - t.due_date))::TEXT || ' days overdue' as description,
      t.id as ref_id,
      'task'::TEXT as ref_type,
      t.area::TEXT,
      '/tasks/' || t.id::TEXT as action,
      t.due_date as created
    FROM tasks t
    WHERE t.user_id = p_user_id
      AND t.due_date < NOW()
      AND t.progress_percentage < 100
      AND t.id NOT IN (SELECT alert_reference_id FROM dismissed WHERE alert_reference_id IS NOT NULL)
  ),
  stalled_projects AS (
    SELECT
      gen_random_uuid() as id,
      'stalled_project'::TEXT as type,
      'warning'::TEXT as severity,
      'Stalled Project'::TEXT as title,
      p.project_name || ' - No activity for ' || EXTRACT(DAY FROM (NOW() - MAX(t.updated_at)))::TEXT || ' days' as description,
      p.id as ref_id,
      'project'::TEXT as ref_type,
      'BIZNESS'::TEXT as area,
      '/projects/' || p.id::TEXT as action,
      MAX(t.updated_at) as created
    FROM projects p
    LEFT JOIN tasks t ON t.project_id = p.id
    WHERE p.user_id = p_user_id
      AND p.status != 'completed'
      AND EXTRACT(DAY FROM (NOW() - MAX(t.updated_at))) > (SELECT stalled_project_days FROM user_prefs)
      AND p.id NOT IN (SELECT alert_reference_id FROM dismissed WHERE alert_reference_id IS NOT NULL)
    GROUP BY p.id, p.project_name
  ),
  health_neglect AS (
    SELECT
      gen_random_uuid() as id,
      'health_neglect'::TEXT as type,
      'critical'::TEXT as severity,
      'Health Neglect'::TEXT as title,
      'Health hours below target for 2+ weeks' as description,
      la.id as ref_id,
      'life_area'::TEXT as ref_type,
      'HEALTH'::TEXT as area,
      '/health'::TEXT as action,
      NOW() as created
    FROM life_areas la
    WHERE la.user_id = p_user_id
      AND la.name = 'Health'
      AND (
        SELECT SUM(dws.duration_minutes) / 60.0
        FROM deep_work_sessions dws
        WHERE dws.life_area_id = la.id
          AND dws.start_time >= NOW() - INTERVAL '14 days'
      ) < (SELECT health_min_hours_week FROM user_prefs) * 2 -- 2 weeks
      AND la.id NOT IN (SELECT alert_reference_id FROM dismissed WHERE alert_reference_id IS NOT NULL)
  ),
  budget_overruns AS (
    SELECT
      gen_random_uuid() as id,
      'budget_overrun'::TEXT as type,
      CASE
        WHEN (monthly_expenses / monthly_budget) > 1.1 THEN 'critical'::TEXT
        WHEN (monthly_expenses / monthly_budget) > 1.0 THEN 'warning'::TEXT
        ELSE 'info'::TEXT
      END as severity,
      'Budget Overrun'::TEXT as title,
      'Monthly expenses exceed budget by ' || ROUND(((monthly_expenses / monthly_budget - 1) * 100), 1)::TEXT || '%' as description,
      bs.user_id as ref_id,
      'budget'::TEXT as ref_type,
      'FINANCES'::TEXT as area,
      '/finances'::TEXT as action,
      NOW() as created
    FROM (
      SELECT
        t.user_id,
        SUM(t.amount) FILTER (WHERE t.transaction_type = 'expense') as monthly_expenses,
        bs.monthly_budget
      FROM transactions t
      JOIN budget_settings bs ON bs.user_id = t.user_id
      WHERE t.user_id = p_user_id
        AND t.transaction_date >= DATE_TRUNC('month', NOW())
      GROUP BY t.user_id, bs.monthly_budget
    ) bs
    WHERE monthly_expenses > monthly_budget * (SELECT budget_warning_percentage FROM user_prefs) / 100
  ),
  zero_hour_businesses AS (
    SELECT
      gen_random_uuid() as id,
      'zero_hours_business'::TEXT as type,
      'warning'::TEXT as severity,
      'No Hours Invested'::TEXT as title,
      b.name || ' has zero hours this week' as description,
      b.id as ref_id,
      'business'::TEXT as ref_type,
      'BIZNESS'::TEXT as area,
      '/business/' || b.id::TEXT as action,
      NOW() as created
    FROM businesses b
    WHERE b.user_id = p_user_id
      AND (
        SELECT COALESCE(SUM(dws.duration_minutes), 0)
        FROM deep_work_sessions dws
        WHERE dws.business_id = b.id
          AND dws.start_time >= NOW() - INTERVAL '7 days'
      ) < (SELECT business_min_hours_week FROM user_prefs)
      AND b.id NOT IN (SELECT alert_reference_id FROM dismissed WHERE alert_reference_id IS NOT NULL)
  )
  SELECT * FROM overdue_alerts
  UNION ALL
  SELECT * FROM stalled_projects
  UNION ALL
  SELECT * FROM health_neglect
  UNION ALL
  SELECT * FROM budget_overruns
  UNION ALL
  SELECT * FROM zero_hour_businesses
  ORDER BY
    CASE severity
      WHEN 'critical' THEN 1
      WHEN 'warning' THEN 2
      WHEN 'info' THEN 3
    END,
    created_at DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**React Hook: useReviewAlerts**
```typescript
// src/hooks/useReviewAlerts.ts
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase';

export interface ReviewAlert {
  alertId: string;
  alertType: 'overdue_task' | 'stalled_project' | 'health_neglect' | 'budget_overrun' | 'zero_hours_business';
  severity: 'critical' | 'warning' | 'info';
  title: string;
  description: string;
  referenceId: string;
  referenceType: 'task' | 'project' | 'life_area' | 'budget' | 'business';
  area: string;
  actionUrl: string;
  createdAt: Date;
}

export const useReviewAlerts = () => {
  return useQuery({
    queryKey: ['review', 'alerts'],
    queryFn: async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase.rpc('get_review_alerts', {
        p_user_id: user.id,
      });

      if (error) throw error;

      return (data || []).map((alert: any) => ({
        alertId: alert.alert_id,
        alertType: alert.alert_type,
        severity: alert.severity,
        title: alert.title,
        description: alert.description,
        referenceId: alert.reference_id,
        referenceType: alert.reference_type,
        area: alert.area,
        actionUrl: alert.action_url,
        createdAt: new Date(alert.created_at),
      })) as ReviewAlert[];
    },
    staleTime: 30000, // 30 seconds - alerts should refresh frequently
    refetchInterval: 60000, // Auto-refetch every minute
  });
};

export const useDismissAlert = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({
      alertType,
      referenceId,
      reason,
    }: {
      alertType: string;
      referenceId: string;
      reason: string;
    }) => {
      const { data, error } = await supabase
        .from('dismissed_alerts')
        .insert({
          alert_type: alertType,
          alert_reference_id: referenceId,
          dismissal_reason: reason,
        });

      if (error) throw error;
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['review', 'alerts'] });
    },
  });
};
```

**NeedsAttentionSection Component:**
```typescript
// src/components/review/NeedsAttentionSection.tsx
import { FC, useState } from 'react';
import { ChevronDown, ChevronUp, CheckCircle } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { useReviewAlerts } from '@/hooks/useReviewAlerts';
import { AlertCard } from './AlertCard';

export const NeedsAttentionSection: FC = () => {
  const { data: alerts, isLoading } = useReviewAlerts();
  const [isExpanded, setIsExpanded] = useState(true);

  if (isLoading) return <NeedsAttentionSkeleton />;

  const criticalAlerts = alerts?.filter(a => a.severity === 'critical') || [];
  const warningAlerts = alerts?.filter(a => a.severity === 'warning') || [];
  const infoAlerts = alerts?.filter(a => a.severity === 'info') || [];

  const totalAlerts = alerts?.length || 0;

  // All Clear state
  if (totalAlerts === 0) {
    return (
      <div className="mb-6 p-6 bg-green-950/30 border-2 border-green-500 rounded-lg">
        <div className="flex items-center gap-3">
          <CheckCircle className="text-green-500" size={32} />
          <div>
            <h2 className="text-2xl font-bold text-green-300">All Clear</h2>
            <p className="text-green-200">Everything on track - no urgent items</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="mb-6">
      {/* Header */}
      <div
        className="flex items-center justify-between p-4 bg-orange-950/30 border-2 border-orange-500 rounded-t-lg cursor-pointer"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center gap-3">
          <div className="flex items-center gap-2">
            {criticalAlerts.length > 0 && (
              <span className="px-3 py-1 bg-red-500 text-white rounded-full text-sm font-bold">
                {criticalAlerts.length} Critical
              </span>
            )}
            {warningAlerts.length > 0 && (
              <span className="px-3 py-1 bg-yellow-500 text-black rounded-full text-sm font-bold">
                {warningAlerts.length} Warning
              </span>
            )}
            {infoAlerts.length > 0 && (
              <span className="px-3 py-1 bg-blue-500 text-white rounded-full text-sm font-bold">
                {infoAlerts.length} Info
              </span>
            )}
          </div>
          <h2 className="text-xl font-bold text-orange-300">
            {totalAlerts} {totalAlerts === 1 ? 'item' : 'items'} need attention
          </h2>
        </div>
        {isExpanded ? (
          <ChevronUp className="text-orange-400" size={24} />
        ) : (
          <ChevronDown className="text-orange-400" size={24} />
        )}
      </div>

      {/* Alert List */}
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="bg-gray-900 border-2 border-orange-500 border-t-0 rounded-b-lg p-4 space-y-3"
          >
            {/* Critical Alerts */}
            {criticalAlerts.length > 0 && (
              <div>
                <h3 className="text-sm font-semibold text-red-400 uppercase mb-2">
                  Critical - Immediate Action
                </h3>
                {criticalAlerts.map((alert) => (
                  <AlertCard key={alert.alertId} alert={alert} />
                ))}
              </div>
            )}

            {/* Warning Alerts */}
            {warningAlerts.length > 0 && (
              <div>
                <h3 className="text-sm font-semibold text-yellow-400 uppercase mb-2">
                  Warning - Review Soon
                </h3>
                {warningAlerts.map((alert) => (
                  <AlertCard key={alert.alertId} alert={alert} />
                ))}
              </div>
            )}

            {/* Info Alerts */}
            {infoAlerts.length > 0 && (
              <div>
                <h3 className="text-sm font-semibold text-blue-400 uppercase mb-2">
                  Info - FYI
                </h3>
                {infoAlerts.map((alert) => (
                  <AlertCard key={alert.alertId} alert={alert} />
                ))}
              </div>
            )}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};
```

**AlertCard Component:**
```typescript
// src/components/review/AlertCard.tsx
import { FC, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { AlertTriangle, AlertCircle, Info, X } from 'lucide-react';
import { useDismissAlert } from '@/hooks/useReviewAlerts';
import type { ReviewAlert } from '@/hooks/useReviewAlerts';

interface AlertCardProps {
  alert: ReviewAlert;
}

export const AlertCard: FC<AlertCardProps> = ({ alert }) => {
  const navigate = useNavigate();
  const dismissAlert = useDismissAlert();
  const [showDismissDialog, setShowDismissDialog] = useState(false);

  const iconMap = {
    critical: AlertTriangle,
    warning: AlertCircle,
    info: Info,
  };

  const colorMap = {
    critical: 'red',
    warning: 'yellow',
    info: 'blue',
  };

  const Icon = iconMap[alert.severity];
  const color = colorMap[alert.severity];

  const handleDismiss = (reason: string) => {
    dismissAlert.mutate({
      alertType: alert.alertType,
      referenceId: alert.referenceId,
      reason,
    });
    setShowDismissDialog(false);
  };

  return (
    <div
      className={`p-4 rounded-lg border-2 border-${color}-500 bg-${color}-950/20
                  hover:bg-${color}-950/40 transition-all cursor-pointer
                  flex items-center justify-between group`}
      onClick={() => navigate(alert.actionUrl)}
    >
      <div className="flex items-center gap-3 flex-1">
        <Icon className={`text-${color}-500`} size={24} />
        <div>
          <h4 className="font-semibold text-white">{alert.title}</h4>
          <p className="text-sm text-gray-400">{alert.description}</p>
          <span className="text-xs text-gray-500">{alert.area}</span>
        </div>
      </div>

      <button
        className={`p-2 rounded hover:bg-${color}-700 transition-colors opacity-0 group-hover:opacity-100`}
        onClick={(e) => {
          e.stopPropagation();
          setShowDismissDialog(true);
        }}
        title="Dismiss alert"
      >
        <X size={16} className="text-gray-400" />
      </button>

      {/* Dismissal Dialog */}
      {showDismissDialog && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
             onClick={(e) => { e.stopPropagation(); setShowDismissDialog(false); }}>
          <div className="bg-gray-800 p-6 rounded-lg border-2 border-gray-700 max-w-md"
               onClick={(e) => e.stopPropagation()}>
            <h3 className="text-lg font-bold text-white mb-4">Dismiss Alert</h3>
            <p className="text-sm text-gray-400 mb-4">Why are you dismissing this alert?</p>
            <div className="space-y-2">
              <button
                className="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded"
                onClick={() => handleDismiss('Expected/Intentional')}
              >
                Expected/Intentional
              </button>
              <button
                className="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded"
                onClick={() => handleDismiss('Acknowledged')}
              >
                Acknowledged
              </button>
              <button
                className="w-full py-2 bg-gray-600 hover:bg-gray-700 text-white rounded"
                onClick={() => handleDismiss('Not Important')}
              >
                Not Important
              </button>
              <button
                className="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white rounded"
                onClick={() => setShowDismissDialog(false)}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};
```

**File Locations:**
- Create: supabase/migrations/create-alerts-tables.sql
- Create: supabase/migrations/create-review-alerts-function.sql
- Create: src/hooks/useReviewAlerts.ts
- Create: src/hooks/useWeeklySummary.ts
- Create: src/components/review/NeedsAttentionSection.tsx
- Create: src/components/review/AlertCard.tsx
- Create: src/components/review/WeeklySummarySection.tsx
- Create: src/components/review/SmartRecommendations.tsx
- Create: src/utils/smartRecommendations.ts
- Create: src/utils/briefingMode.ts
- Update: src/pages/ReviewDashboard.tsx (integrate intelligence sections)

### Testing

**Testing Requirements:** [Source: docs/prd/technical-assumptions.md]
Manual testing with systematic verification

**Review Dashboard Intelligence Testing Workflow:**
1. **Overdue Task Alerts:**
   - Create task due 10 days ago (critical)
   - Verify appears in Critical section: "Task name - 10 days overdue"
   - Create task due 5 days ago (warning)
   - Verify appears in Warning section
   - Create task due 1 day ago (info)
   - Verify appears in Info section
   - Verify sorted by days overdue within each severity

2. **Stalled Project Alerts:**
   - Create project with no task updates in 8 days
   - Verify warning alert: "Project name - No activity for 8 days"
   - Update task → verify alert disappears
   - Verify stalled threshold customizable in preferences

3. **Health Neglect Alerts:**
   - Log 1h health workout in last 14 days (below 8h target for 2 weeks)
   - Verify critical alert: "Health hours below target for 2+ weeks"
   - Log 4h more → verify alert disappears
   - No health activity 14 days → verify critical alert persists

4. **Budget Overrun Alerts:**
   - Set monthly budget $10,000
   - Add expenses totaling $9,500 (95%)
   - Verify warning alert: "Approaching budget limit"
   - Add $1,000 expense ($10,500 total, 105%)
   - Verify critical alert: "Monthly expenses exceed budget by 5%"

5. **Zero Hours Business Alerts:**
   - Business with 0h logged this week
   - Verify warning: "Business X has zero hours this week"
   - Log 1h Deep Work → verify alert disappears
   - Set custom threshold: 3h/week
   - Business with 2h → verify alert appears

6. **Alert Severity Levels:**
   - Critical: red icon, red border, "Critical - Immediate Action" header
   - Warning: yellow icon, yellow border, "Warning - Review Soon" header
   - Info: blue icon, blue border, "Info - FYI" header
   - Verify badge counts: "3 Critical, 5 Warning, 2 Info"

7. **Actionable Alerts:**
   - Click overdue task alert → verify navigates to /tasks/:taskId
   - Click stalled project alert → verify navigates to /projects/:projectId
   - Click health alert → verify navigates to /health
   - Click budget alert → verify navigates to /finances
   - Click business alert → verify navigates to /business/:businessId

8. **All Clear State:**
   - Complete all overdue tasks
   - Update all stalled projects
   - Meet health target
   - Stay under budget
   - Log hours on all businesses
   - Verify green banner: "All Clear - Everything on track - no urgent items"
   - Verify CheckCircle icon displayed

9. **Alert Dismissal:**
   - Click X button on alert → verify dismissal dialog appears
   - Select "Expected/Intentional" → verify alert removed from list
   - Refresh page → verify dismissed alert doesn't reappear
   - Wait 7 days → verify alert reappears (dismissal expired)
   - Click "Show Dismissed" → verify dismissed alerts shown with "Undo" option

10. **Weekly Summary:**
    - Complete 65% tasks this week vs 58% last week
    - Verify shows "65% this week (↑ from 58% last week)" with green arrow
    - Log 15% more hours on Huge Capital this week
    - Verify shows "15% more hours on Huge Capital" in time allocation shifts
    - Complete 12 more tasks than last week
    - Verify "Completed 12 more tasks than last week" with velocity metric

11. **Smart Recommendations:**
    - Project velocity: 5 tasks/week, 10 tasks remaining, deadline in 2 weeks
    - Verify recommendation: "Based on current progress, you'll complete Project by [Date] - on track"
    - Project behind: velocity 2 tasks/week, 20 remaining, deadline in 2 weeks
    - Verify: "Focus on Project X - behind schedule by 2 weeks"
    - Health declining: 2h this week vs 5h target
    - Verify: "Health hours trending down - schedule workout"

12. **Morning vs Evening Briefing:**
    - Load dashboard at 9am → verify "Good morning" header
    - Verify alerts prioritize today's tasks and urgent items
    - Load dashboard at 8pm → verify "Evening review" header
    - Verify alerts prioritize tomorrow's planning and next week preview
    - Click "Switch to Evening Briefing" → verify mode changes

13. **Customizable Alert Thresholds:**
    - Navigate to Settings > Alert Preferences
    - Set business min hours: 3h/week (instead of default 2h)
    - Business with 2.5h → verify alert appears (below custom threshold)
    - Set overdue critical: 14 days (instead of 7)
    - Task 10 days overdue → verify shows as Warning not Critical
    - Click "Reset to Defaults" → verify all thresholds reset

14. **Alert Notifications:**
    - New critical alert detected → verify toast notification: "3 new critical alerts"
    - Verify badge on Review nav item: red dot with count
    - Enable browser notifications → verify notification appears for critical
    - Enable alert sound → verify subtle chime plays for critical alert
    - Daily email digest (if enabled) → verify email sent with alert summary

15. **Real-Time Alert Updates:**
    - Open Review Dashboard in Tab 1 and Tab 2
    - Complete overdue task in Tab 1
    - Verify alert disappears in Tab 2 within 500ms
    - Add new overdue task in Tab 1
    - Verify alert appears in Tab 2 immediately
    - Dismiss alert in Tab 1
    - Verify removed from Tab 2

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | v1.0 | Initial story creation for Review Dashboard Intelligence & Alerts | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
