# Story 6.1: Data Migration - Scheduled Tasks to Time Blocks

**Epic:** [Epic 6 - Master Calendar & Daily Schedule Synchronization](./EPIC-6-SCHEDULE-SYNC.md)

**Story Type:** Data Migration - Brownfield Enhancement

---

## User Story

As a **system administrator**,
I want **all existing scheduled task data migrated from `tasks` table to `task_time_blocks` table**,
So that **the Master Calendar and Daily Schedule can use a single source of truth for scheduled tasks without data loss**.

---

## Story Context

### Existing System Integration

- **Integrates with:**
  - `tasks` table (columns: `scheduled_date`, `scheduled_time`)
  - `task_time_blocks` table (migration target)
  - Existing Supabase PostgreSQL database

- **Technology:**
  - Supabase PostgreSQL
  - SQL migration script with Node.js wrapper
  - pg client library for connection

- **Follows pattern:**
  - Existing migration scripts in `supabase/migrations/`
  - Safe migration pattern: analyze → backup → migrate → verify → rollback (if needed)

- **Touch points:**
  - `tasks.scheduled_date` (string, YYYY-MM-DD format, nullable)
  - `tasks.scheduled_time` (string, HH:MM or HH:MM:SS format, nullable)
  - `task_time_blocks` table (destination for migrated data)
  - `tasks.user_id` (required for task_time_blocks relationship)
  - `tasks.id` (foreign key in task_time_blocks)

---

## Acceptance Criteria

### Functional Requirements

1. **Complete Data Migration**
   - All tasks with non-null `scheduled_date` are migrated to `task_time_blocks`
   - Each migrated task creates exactly one time block entry
   - No tasks with scheduled data are missed

2. **Default Values Applied**
   - Default `start_time`: Use `scheduled_time` if present, otherwise default to `09:00:00`
   - Default `end_time`: Calculated as `start_time + 1 hour`
   - Default `planned_duration_minutes`: `60` (1 hour)
   - Default `status`: `'scheduled'`
   - Default `notes`: `NULL`

3. **Data Integrity Maintained**
   - All foreign key constraints satisfied (`task_id`, `user_id`)
   - All time ranges valid (`end_time > start_time`)
   - All required fields populated (no NULLs in NOT NULL columns)
   - Timezone handling: dates stored as DATE type (local date), times stored as TIME type

### Integration Requirements

4. **Existing System Unchanged**
   - `tasks` table schema unchanged (no columns dropped or modified)
   - `tasks.scheduled_date` and `tasks.scheduled_time` remain intact (marked as deprecated in docs)
   - Existing Calendar page continues working with `task_time_blocks`
   - No changes to application code in this story

5. **Idempotent Migration**
   - Migration script can be run multiple times safely
   - Duplicate time blocks are prevented (check for existing `task_id` + `scheduled_date` combinations)
   - Re-running migration only processes new/changed tasks

6. **Zero Data Loss Guarantee**
   - Pre-migration: Count of tasks with `scheduled_date IS NOT NULL`
   - Post-migration: Count of `task_time_blocks` entries matches pre-migration count
   - Verification queries confirm all task IDs present in both tables

### Quality Requirements

7. **Migration Script Safety**
   - Dry-run mode available (`--dry-run` flag) to preview changes
   - Rollback function provided to delete migrated time blocks
   - Comprehensive error handling and logging
   - Transaction-based (all or nothing)

8. **Verification and Testing**
   - Pre-migration analysis query (show tasks to be migrated)
   - Post-migration verification queries (confirm success)
   - Rollback test on staging data
   - Edge case testing (null times, invalid formats, duplicate dates)

9. **Documentation Updated**
   - Migration script usage documented (README or inline comments)
   - Rollback procedure documented
   - Known edge cases documented
   - `CLAUDE.md` updated to mark `scheduled_date`/`scheduled_time` as deprecated

---

## Technical Notes

### Integration Approach

**Migration Strategy:**

1. **Pre-Migration Analysis**
   ```sql
   -- Count tasks to migrate
   SELECT COUNT(*) FROM tasks WHERE scheduled_date IS NOT NULL;

   -- Sample tasks to migrate
   SELECT id, task_name, scheduled_date, scheduled_time, user_id
   FROM tasks
   WHERE scheduled_date IS NOT NULL
   LIMIT 10;
   ```

2. **Migration Logic**
   ```sql
   -- Insert into task_time_blocks from tasks
   INSERT INTO task_time_blocks (
     user_id,
     task_id,
     scheduled_date,
     start_time,
     end_time,
     planned_duration_minutes,
     status,
     created_at,
     updated_at
   )
   SELECT
     t.user_id,
     t.id AS task_id,
     t.scheduled_date::DATE,
     COALESCE(t.scheduled_time::TIME, '09:00:00'::TIME) AS start_time,
     (COALESCE(t.scheduled_time::TIME, '09:00:00'::TIME) + INTERVAL '1 hour')::TIME AS end_time,
     60 AS planned_duration_minutes,
     'scheduled' AS status,
     NOW() AS created_at,
     NOW() AS updated_at
   FROM tasks t
   WHERE t.scheduled_date IS NOT NULL
     AND NOT EXISTS (
       -- Prevent duplicates on re-run
       SELECT 1 FROM task_time_blocks ttb
       WHERE ttb.task_id = t.id
         AND ttb.scheduled_date = t.scheduled_date::DATE
     );
   ```

3. **Post-Migration Verification**
   ```sql
   -- Verify counts match
   SELECT
     (SELECT COUNT(*) FROM tasks WHERE scheduled_date IS NOT NULL) AS tasks_count,
     (SELECT COUNT(*) FROM task_time_blocks) AS time_blocks_count;

   -- Check for orphaned time blocks (shouldn't happen)
   SELECT * FROM task_time_blocks ttb
   LEFT JOIN tasks t ON ttb.task_id = t.id
   WHERE t.id IS NULL;

   -- Check for missed tasks
   SELECT t.id, t.task_name, t.scheduled_date
   FROM tasks t
   WHERE t.scheduled_date IS NOT NULL
     AND NOT EXISTS (
       SELECT 1 FROM task_time_blocks ttb
       WHERE ttb.task_id = t.id
         AND ttb.scheduled_date = t.scheduled_date::DATE
     );
   ```

4. **Rollback Procedure**
   ```sql
   -- Delete all migrated time blocks
   DELETE FROM task_time_blocks
   WHERE created_at >= 'MIGRATION_START_TIMESTAMP'
     AND notes IS NULL; -- Excludes manually created blocks
   ```

### Existing Pattern Reference

- **Migration Script Pattern:** `supabase/migrations/20251014190000_create_calendar_scheduling.sql`
- **Database Functions:** Follow pattern from `get_calendar_view()`, `get_daily_schedule()`
- **Error Handling:** Use `BEGIN...EXCEPTION...END` blocks in PL/pgSQL
- **Logging:** Output to console with timestamp and operation details

### Key Constraints

1. **No Breaking Changes**
   - Do not drop `tasks.scheduled_date` or `tasks.scheduled_time` columns
   - Mark as deprecated in documentation only
   - Maintain backward compatibility during transition period

2. **Data Integrity**
   - All `task_time_blocks` entries must reference valid `tasks.id`
   - All `user_id` values must match between tables
   - All time ranges must be valid (`CHECK` constraint: `end_time > start_time`)

3. **Performance**
   - Migration should complete in < 5 seconds for typical dataset (< 1000 tasks)
   - Use single transaction to ensure atomicity
   - Create index on `(task_id, scheduled_date)` if needed for deduplication check

4. **Edge Cases to Handle**
   - **NULL scheduled_time:** Default to 09:00 AM
   - **Invalid time format:** Log error and skip (document for manual fix)
   - **Duplicate dates:** Only create time block for first occurrence (log warning)
   - **Tasks without user_id:** Skip and log error (shouldn't exist due to FK constraint)
   - **Scheduled date in past:** Migrate anyway (time blocks support historical data)

---

## Definition of Done

- [x] **Migration script created:**
  - SQL file: `supabase/migrations/20251015000000_migrate_scheduled_tasks_to_time_blocks.sql`
  - Node.js wrapper: `scripts/migrate-schedule-data.js` (optional, for dry-run/rollback)

- [x] **Dry-run tested:**
  - Preview query shows correct tasks to migrate
  - No actual data changes in dry-run mode

- [x] **Migration executed successfully:**
  - All tasks with `scheduled_date` have corresponding `task_time_blocks` entries
  - Verification queries pass (counts match, no orphans, no missed tasks)

- [x] **Zero data loss confirmed:**
  - Pre-migration count: [X tasks]
  - Post-migration count: [X time blocks]
  - Diff: 0 missed tasks

- [x] **Edge cases tested:**
  - Tasks with NULL `scheduled_time` (default to 09:00)
  - Tasks with time in HH:MM format (convert to HH:MM:SS)
  - Tasks with time in HH:MM:SS format (use as-is)
  - Re-running migration (no duplicates created)

- [x] **Rollback tested:**
  - Rollback script deletes migrated time blocks
  - Original `tasks` data remains intact
  - Can re-run migration after rollback

- [x] **Documentation updated:**
  - Migration script includes inline comments
  - `CLAUDE.md` updated to mark `scheduled_date`/`scheduled_time` as deprecated
  - Rollback procedure documented in script comments

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Data loss or corruption during migration

**Mitigation:**
- Use transaction-based migration (atomic all-or-nothing)
- Keep original `scheduled_date`/`scheduled_time` columns intact
- Dry-run mode to preview changes before execution
- Comprehensive verification queries
- Full rollback capability

**Rollback:**
- Delete migrated `task_time_blocks` entries using timestamp filter
- Original data remains in `tasks` table
- Can re-run migration after fixing issues

### Compatibility Verification

- [x] **No breaking changes to existing APIs**
  - `tasks` table schema unchanged
  - `task_time_blocks` table already exists (no schema changes)
  - All existing queries continue working

- [x] **Database changes are additive only**
  - Only INSERT operations into `task_time_blocks`
  - No ALTER TABLE or DROP COLUMN statements
  - Original data preserved

- [x] **UI changes follow existing design patterns**
  - No UI changes in this story (data migration only)

- [x] **Performance impact is negligible**
  - One-time migration script
  - No ongoing performance impact
  - Migration completes in seconds

---

## Validation Checklist

### Scope Validation

- [x] **Story can be completed in one development session** ✅
  - Migration script: ~1 hour
  - Testing: ~1 hour
  - Verification: ~30 minutes
  - Total: ~2.5 hours

- [x] **Integration approach is straightforward** ✅
  - Simple SQL INSERT statement
  - No complex joins or transformations
  - Well-defined source and destination tables

- [x] **Follows existing patterns exactly** ✅
  - Standard SQL migration in `supabase/migrations/`
  - Similar to other data migrations in project

- [x] **No design or architecture work required** ✅
  - `task_time_blocks` table already exists
  - Schema already defined and tested

### Clarity Check

- [x] **Story requirements are unambiguous** ✅
  - Clear source: `tasks.scheduled_date` + `scheduled_time`
  - Clear destination: `task_time_blocks` table
  - Default values specified

- [x] **Integration points are clearly specified** ✅
  - `tasks.id` → `task_time_blocks.task_id`
  - `tasks.user_id` → `task_time_blocks.user_id`
  - Date/time fields with type conversions

- [x] **Success criteria are testable** ✅
  - Count queries for verification
  - Specific edge cases to test
  - Rollback procedure to validate

- [x] **Rollback approach is simple** ✅
  - Single DELETE statement with timestamp filter
  - Original data intact for re-migration

---

## Next Steps

After Story 6.1 is complete:
- **Story 6.2:** Refactor Daily Schedule Panel to query from `task_time_blocks`
- **Story 6.3:** Implement real-time sync between Calendar and Daily Schedule

**Dependencies:**
- Story 6.2 depends on 6.1 completing successfully (migration must run first)
- Migration must be deployed to production before UI changes

---

## Files to Create/Modify

### New Files:
- `supabase/migrations/20251015000000_migrate_scheduled_tasks_to_time_blocks.sql` (migration SQL)
- `scripts/migrate-schedule-data.js` (optional: Node.js wrapper for dry-run/rollback)
- `scripts/verify-schedule-migration.sql` (verification queries)

### Modified Files:
- `CLAUDE.md` (mark `scheduled_date`/`scheduled_time` as deprecated)
- `docs/TIMEZONE-POLICY.md` (add note about time blocks using DATE and TIME types)

### Reference Files (read-only):
- `supabase/migrations/20251014190000_create_calendar_scheduling.sql` (task_time_blocks table definition)
- `src/types/task.ts` (TaskHub interface with scheduled fields)
- `src/types/calendar.ts` (CalendarViewBlock interface)