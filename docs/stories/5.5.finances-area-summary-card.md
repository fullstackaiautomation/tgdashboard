# Story 5.5: Finances Area Summary Card

## Status
Draft

## Story
**As a** business owner tracking financial health,
**I want** the Finances area card to show high-level financial metrics,
**so that** I can monitor financial status alongside operational metrics.

## Acceptance Criteria
1. Finances card displays:
   - Current net worth value (if tracked)
   - Monthly revenue total (across all businesses)
   - Monthly expenses total
   - Budget status: spending vs. budget (e.g., "82% of monthly budget used")
2. Visual indicator: green if under budget, yellow if approaching limit (>90%), red if over budget
3. Recent transactions count: "15 new transactions this week"
4. Investment performance if tracked: "Portfolio: +5% this month"
5. Budget category breakdown: quick view of top 3 spending categories this month
6. Financial goals progress: if savings goals exist, show progress bar (e.g., "Emergency fund: $8K / $10K target")
7. Quick action: "Review Transactions" button navigates to Finances page
8. Alert for unusual spending: if any category exceeds typical spending by 50%+, show warning

## Tasks / Subtasks
- [ ] Task 1: Create Finances area summary query (AC: 1, 2, 3)
  - [ ] Create src/hooks/useFinancesAreaSummary.ts hook
  - [ ] Query net worth: SELECT SUM(assets) - SUM(liabilities) FROM accounts WHERE user_id = X
  - [ ] Calculate monthly revenue: SUM(transactions WHERE type='income' AND date >= start_of_month)
  - [ ] Calculate monthly expenses: SUM(transactions WHERE type='expense' AND date >= start_of_month)
  - [ ] Query monthly budget from budget_settings table
  - [ ] Calculate budget usage: (monthly_expenses / monthly_budget) × 100
  - [ ] Determine budget status: <80% green, 80-90% yellow, >90% red, >100% critical red
  - [ ] Count recent transactions: COUNT(*) WHERE date >= NOW() - 7 days
  - [ ] Optimize with single query using CTEs for all financial metrics

- [ ] Task 2: Build investment performance tracking (AC: 4)
  - [ ] Query investment accounts: SELECT * FROM accounts WHERE account_type = 'investment'
  - [ ] Calculate current portfolio value: SUM(current_balance)
  - [ ] Query portfolio value from start of month for comparison
  - [ ] Calculate monthly return: ((current - start_of_month) / start_of_month) × 100
  - [ ] Format performance: "+5.2%" with green for positive, red for negative
  - [ ] Handle case where no investment accounts exist: hide performance widget
  - [ ] Add trend indicator: ↑ gaining, ↓ losing, → flat
  - [ ] Include year-to-date (YTD) performance for context

- [ ] Task 3: Create budget category breakdown analysis (AC: 5)
  - [ ] Query spending by category for current month
  - [ ] SQL: SELECT category, SUM(amount) FROM transactions WHERE type='expense' AND date >= start_of_month GROUP BY category ORDER BY SUM(amount) DESC LIMIT 3
  - [ ] Calculate percentage of total spending per category
  - [ ] Display format: "Housing: $2,500 (40%), Food: $800 (13%), Transport: $600 (10%)"
  - [ ] Color-code categories: use consistent colors (Housing=blue, Food=green, etc.)
  - [ ] Show mini pie chart or horizontal bars for visual breakdown
  - [ ] Compare to budget per category: show if over/under budget
  - [ ] Link to full category breakdown on Finances page

- [ ] Task 4: Implement financial goals progress tracking (AC: 6)
  - [ ] Query financial goals: SELECT * FROM financial_goals WHERE user_id = X AND active = true
  - [ ] Calculate progress for each goal: (current_amount / target_amount) × 100
  - [ ] Display top 2-3 active goals with progress bars
  - [ ] Format: "Emergency fund: $8,000 / $10,000 (80%)"
  - [ ] Visual progress bar with green fill
  - [ ] Show goal deadline if exists: "Target: Dec 2025 (3 months)"
  - [ ] Celebrate completed goals: "✅ Vacation fund complete!"
  - [ ] Warning for stalled goals: "⚠️ No progress in 2 months"

- [ ] Task 5: Build unusual spending detection system (AC: 8)
  - [ ] Calculate typical monthly spending per category (avg last 3 months)
  - [ ] Compare current month spending to typical
  - [ ] Detect anomalies: current > typical × 1.5 (50% increase)
  - [ ] Alert format: "⚠️ Dining spending 60% above typical ($800 vs $500 usual)"
  - [ ] Show top 2 anomalies if multiple exist
  - [ ] Use orange/red warning color for alerts
  - [ ] Allow dismissal: "This is expected" to suppress alert
  - [ ] Track dismissed alerts to avoid repeat warnings

- [ ] Task 6: Create FinancesAreaCard component (AC: 1, 2, 7)
  - [ ] Create src/components/review/FinancesAreaCard.tsx
  - [ ] Display net worth prominently: "$125,000 net worth" at top
  - [ ] Show monthly revenue vs expenses: "Revenue: $15K, Expenses: $8K"
  - [ ] Use yellow color (#eab308) for Finances theme
  - [ ] Display budget usage with color-coded progress bar
  - [ ] Show budget status text: "Under budget" (green), "Approaching limit" (yellow), "Over budget" (red)
  - [ ] Add DollarSign icon from Lucide
  - [ ] Include "Review Transactions" button in footer
  - [ ] Make entire card clickable → navigate to /finances

- [ ] Task 7: Build budget status visualization (AC: 2)
  - [ ] Create horizontal progress bar showing budget usage %
  - [ ] Color segments: 0-80% green, 80-90% yellow, 90-100% orange, >100% red
  - [ ] Display percentage: "82% of monthly budget used"
  - [ ] Show remaining budget: "$1,800 remaining this month"
  - [ ] Add daily burn rate: "~$60/day average"
  - [ ] Project month-end: "At current rate, will end 5% under budget"
  - [ ] Warning zone: if projected to exceed, show alert
  - [ ] Visual indicator: traffic light icon (green/yellow/red)

- [ ] Task 8: Create recent transactions widget (AC: 3)
  - [ ] Display transaction count: "15 new transactions this week"
  - [ ] Show most recent transaction: "Last: Starbucks - $8.50 (2 hours ago)"
  - [ ] Include transaction type icon: shopping bag, dining, gas pump, etc.
  - [ ] Link to transactions page: click to view all
  - [ ] Highlight large transactions: >$500 in bold/color
  - [ ] Show pending transactions count if applicable
  - [ ] Add "Quick Add Transaction" button for manual entry
  - [ ] Auto-refresh when new transactions sync from bank

- [ ] Task 9: Build investment performance widget (AC: 4)
  - [ ] Display portfolio value: "$45,000"
  - [ ] Show monthly performance: "↑ +5.2% this month" in green
  - [ ] Include YTD performance: "+12.5% YTD"
  - [ ] Use TrendingUp/TrendingDown icons from Lucide
  - [ ] Show gain/loss amount: "+$2,350"
  - [ ] Add mini sparkline chart showing month trend
  - [ ] Color code: green for gains, red for losses
  - [ ] Hide widget if no investment accounts configured

- [ ] Task 10: Integrate real-time updates (AC: 3)
  - [ ] Subscribe to transactions table changes
  - [ ] Subscribe to accounts table for balance updates
  - [ ] Subscribe to financial_goals for progress updates
  - [ ] Update budget usage when new expense added
  - [ ] Recalculate unusual spending on transaction insert
  - [ ] Update investment performance on market data refresh
  - [ ] Invalidate query cache on financial mutations
  - [ ] Optimistic updates: add transaction → immediately update counts
  - [ ] Test: add transaction in Tab 1 → verify Finances card updates Tab 2 <500ms

## Dev Notes

### Previous Story Insights

**From Story 5.1:** [Source: docs/stories/5.1.review-dashboard-page-structure.md]
- ReviewAreaCard base component pattern
- Color-coded theming and visual hierarchy
- Quick action button patterns

**From Story 5.2:** [Source: docs/stories/5.2.daily-area-summary-card.md]
- Progress bar with target comparison and color coding
- Warning detection and alert systems
- Multiple metric display in compact format

**From Story 5.3:** [Source: docs/stories/5.3.business-area-summary-card.md]
- Multi-stat grid layout for displaying various metrics
- Warning badges with severity levels
- Aggregate calculations across multiple data sources

**From Story 5.4:** [Source: docs/stories/5.4.health-content-life-golf-summary-cards.md]
- Personal area card design patterns
- "No activity" state handling
- Color-coded visual indicators

**From Epic 3 Stories:** [Source: docs/stories/3.1-3.6]
- Story 3.4: Client Data Encryption Protocols
- Financial data requires special encryption
- Sensitive financial metrics must be protected
- Audit logging for financial data access

**From Epic 1 Stories:** [Source: docs/stories/1.1-1.6]
- Real-time sync infrastructure
- Optimistic update patterns

**Key Technical Context:**
- Finances card shows MOST SENSITIVE data: requires extra security
- Net worth calculation aggregates across multiple account types
- Budget tracking is critical for spending awareness
- Investment performance is optional feature (not all users track)
- Unusual spending detection prevents budget overruns
- Monthly revenue aggregates business income for holistic view

### Architecture Context

**Tech Stack:** [Source: docs/ui-architecture/2-frontend-tech-stack.md]
- React 19.1.1 + TypeScript 5.9.3
- TanStack Query 5.90.2 for state management
- Recharts for sparkline charts
- Lucide React 0.544.0 for financial icons (DollarSign, TrendingUp, TrendingDown)
- date-fns 4.1.0 for date calculations

**Database Schema: Finances Tables**
```sql
-- Accounts table (assets and liabilities)
CREATE TABLE accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  account_name TEXT NOT NULL,
  account_type TEXT CHECK (account_type IN ('checking', 'savings', 'credit', 'investment', 'loan', 'asset')),
  current_balance NUMERIC NOT NULL,
  is_asset BOOLEAN DEFAULT true, -- false for liabilities
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Transactions table
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  account_id UUID REFERENCES accounts(id) ON DELETE SET NULL,
  transaction_date DATE NOT NULL,
  amount NUMERIC NOT NULL,
  transaction_type TEXT CHECK (transaction_type IN ('income', 'expense', 'transfer')),
  category TEXT,
  merchant TEXT,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Budget settings
CREATE TABLE budget_settings (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  monthly_budget NUMERIC NOT NULL,
  category_budgets JSONB, -- { "Housing": 2000, "Food": 800, ... }
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Financial goals
CREATE TABLE financial_goals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  goal_name TEXT NOT NULL,
  target_amount NUMERIC NOT NULL,
  current_amount NUMERIC DEFAULT 0,
  deadline DATE,
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_accounts_user_type ON accounts(user_id, account_type);
CREATE INDEX idx_transactions_user_date ON transactions(user_id, transaction_date);
CREATE INDEX idx_transactions_user_category ON transactions(user_id, category);
CREATE INDEX idx_financial_goals_user_active ON financial_goals(user_id, active);

-- RLS policies
ALTER TABLE accounts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own accounts"
  ON accounts FOR ALL
  USING (auth.uid() = user_id);

ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own transactions"
  ON transactions FOR ALL
  USING (auth.uid() = user_id);

ALTER TABLE budget_settings ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own budget"
  ON budget_settings FOR ALL
  USING (auth.uid() = user_id);

ALTER TABLE financial_goals ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own goals"
  ON financial_goals FOR ALL
  USING (auth.uid() = user_id);
```

**Database Function: Finances Area Summary**
```sql
CREATE OR REPLACE FUNCTION get_finances_area_summary(p_user_id UUID)
RETURNS TABLE (
  net_worth NUMERIC,
  monthly_revenue NUMERIC,
  monthly_expenses NUMERIC,
  monthly_budget NUMERIC,
  budget_usage_percentage NUMERIC,
  budget_status TEXT,
  transactions_this_week INTEGER,
  portfolio_value NUMERIC,
  portfolio_monthly_return NUMERIC,
  top_categories JSONB,
  active_goals JSONB,
  unusual_spending JSONB
) AS $$
DECLARE
  month_start DATE := DATE_TRUNC('month', CURRENT_DATE);
  week_start DATE := CURRENT_DATE - INTERVAL '7 days';
BEGIN
  RETURN QUERY
  WITH net_worth_calc AS (
    SELECT
      SUM(CASE WHEN is_asset THEN current_balance ELSE -current_balance END) as nw
    FROM accounts
    WHERE user_id = p_user_id
  ),
  monthly_financials AS (
    SELECT
      SUM(amount) FILTER (WHERE transaction_type = 'income') as revenue,
      SUM(amount) FILTER (WHERE transaction_type = 'expense') as expenses,
      COUNT(*) FILTER (WHERE transaction_date >= week_start) as txn_count
    FROM transactions
    WHERE user_id = p_user_id
      AND transaction_date >= month_start
  ),
  budget AS (
    SELECT monthly_budget as budget
    FROM budget_settings
    WHERE user_id = p_user_id
  ),
  investment_perf AS (
    SELECT
      SUM(current_balance) as portfolio,
      -- Simplified calculation; real would query historical balances
      5.0 as monthly_return -- Placeholder
    FROM accounts
    WHERE user_id = p_user_id
      AND account_type = 'investment'
  ),
  top_spend AS (
    SELECT jsonb_agg(
      jsonb_build_object(
        'category', category,
        'amount', amount,
        'percentage', ROUND((amount / NULLIF(mf.expenses, 0)) * 100, 1)
      ) ORDER BY amount DESC
    ) as categories
    FROM (
      SELECT
        category,
        SUM(amount) as amount
      FROM transactions
      WHERE user_id = p_user_id
        AND transaction_type = 'expense'
        AND transaction_date >= month_start
      GROUP BY category
      ORDER BY SUM(amount) DESC
      LIMIT 3
    ) t
    CROSS JOIN monthly_financials mf
  ),
  goals AS (
    SELECT jsonb_agg(
      jsonb_build_object(
        'name', goal_name,
        'current', current_amount,
        'target', target_amount,
        'progress', ROUND((current_amount / NULLIF(target_amount, 0)) * 100, 1)
      )
    ) as goals_json
    FROM financial_goals
    WHERE user_id = p_user_id
      AND active = true
    LIMIT 3
  )
  SELECT
    nw.nw,
    mf.revenue,
    mf.expenses,
    b.budget,
    ROUND((mf.expenses / NULLIF(b.budget, 0)) * 100, 1) as usage_pct,
    CASE
      WHEN (mf.expenses / NULLIF(b.budget, 0)) < 0.8 THEN 'under'
      WHEN (mf.expenses / NULLIF(b.budget, 0)) < 0.9 THEN 'approaching'
      WHEN (mf.expenses / NULLIF(b.budget, 0)) <= 1.0 THEN 'caution'
      ELSE 'over'
    END as status,
    mf.txn_count::INTEGER,
    ip.portfolio,
    ip.monthly_return,
    ts.categories,
    g.goals_json,
    '{}'::JSONB as unusual -- Placeholder; would need historical comparison
  FROM net_worth_calc nw
  CROSS JOIN monthly_financials mf
  CROSS JOIN budget b
  CROSS JOIN investment_perf ip
  CROSS JOIN top_spend ts
  CROSS JOIN goals g;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**React Hook: useFinancesAreaSummary**
```typescript
// src/hooks/useFinancesAreaSummary.ts
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase';

export interface FinancialGoal {
  name: string;
  current: number;
  target: number;
  progress: number;
}

export interface TopCategory {
  category: string;
  amount: number;
  percentage: number;
}

export interface FinancesAreaSummary {
  netWorth: number;
  monthlyRevenue: number;
  monthlyExpenses: number;
  monthlyBudget: number;
  budgetUsagePercentage: number;
  budgetStatus: 'under' | 'approaching' | 'caution' | 'over';
  budgetStatusColor: 'green' | 'yellow' | 'orange' | 'red';
  transactionsThisWeek: number;
  portfolioValue: number | null;
  portfolioMonthlyReturn: number | null;
  topCategories: TopCategory[];
  activeGoals: FinancialGoal[];
  hasUnusualSpending: boolean;
}

export const useFinancesAreaSummary = () => {
  return useQuery({
    queryKey: ['finances', 'area-summary'],
    queryFn: async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase.rpc('get_finances_area_summary', {
        p_user_id: user.id,
      });

      if (error) throw error;

      const summary = data[0];

      const statusColorMap = {
        under: 'green',
        approaching: 'yellow',
        caution: 'orange',
        over: 'red',
      } as const;

      return {
        netWorth: summary.net_worth || 0,
        monthlyRevenue: summary.monthly_revenue || 0,
        monthlyExpenses: summary.monthly_expenses || 0,
        monthlyBudget: summary.monthly_budget || 0,
        budgetUsagePercentage: summary.budget_usage_percentage || 0,
        budgetStatus: summary.budget_status,
        budgetStatusColor: statusColorMap[summary.budget_status as keyof typeof statusColorMap],
        transactionsThisWeek: summary.transactions_this_week || 0,
        portfolioValue: summary.portfolio_value,
        portfolioMonthlyReturn: summary.portfolio_monthly_return,
        topCategories: summary.top_categories || [],
        activeGoals: summary.active_goals || [],
        hasUnusualSpending: Object.keys(summary.unusual_spending || {}).length > 0,
      } as FinancesAreaSummary;
    },
    staleTime: 120000, // 2 minutes (financial data updates less frequently)
  });
};
```

**FinancesAreaCard Component:**
```typescript
// src/components/review/FinancesAreaCard.tsx
import { FC } from 'react';
import { useNavigate } from 'react-router-dom';
import { DollarSign, TrendingUp, TrendingDown, ChevronRight, AlertTriangle } from 'lucide-react';
import { useFinancesAreaSummary } from '@/hooks/useFinancesAreaSummary';

export const FinancesAreaCard: FC = () => {
  const navigate = useNavigate();
  const { data: summary, isLoading } = useFinancesAreaSummary();

  if (isLoading || !summary) return <FinancesAreaCardSkeleton />;

  const borderColor = {
    green: 'border-green-500',
    yellow: 'border-yellow-500',
    orange: 'border-orange-500',
    red: 'border-red-500',
  }[summary.budgetStatusColor];

  const budgetStatusText = {
    under: 'Under budget',
    approaching: 'Approaching limit',
    caution: 'Budget caution',
    over: 'Over budget!',
  }[summary.budgetStatus];

  return (
    <div
      className={`bg-gray-800 rounded-lg p-6 border-2 ${borderColor}
                  hover:border-yellow-500 transition-all duration-300 cursor-pointer
                  transform hover:scale-105 hover:shadow-xl`}
      onClick={() => navigate('/finances')}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <DollarSign className="text-yellow-500" size={32} />
          <div>
            <h3 className="text-xl font-bold text-white">FINANCES</h3>
            <p className="text-sm text-gray-400">
              {summary.transactionsThisWeek} transactions this week
            </p>
          </div>
        </div>
        {summary.budgetStatus === 'over' && (
          <AlertTriangle className="text-red-500" size={24} />
        )}
      </div>

      {/* Net Worth */}
      <div className="mb-4 text-center">
        <p className="text-xs text-gray-500 uppercase mb-1">Net Worth</p>
        <p className="text-3xl font-bold text-white">
          ${summary.netWorth.toLocaleString()}
        </p>
      </div>

      {/* Revenue vs Expenses */}
      <div className="grid grid-cols-2 gap-4 mb-4">
        <div className="p-3 bg-green-950/30 border border-green-500 rounded">
          <p className="text-xs text-green-400 uppercase">Revenue</p>
          <p className="text-lg font-bold text-green-300">
            ${summary.monthlyRevenue.toLocaleString()}
          </p>
        </div>
        <div className="p-3 bg-red-950/30 border border-red-500 rounded">
          <p className="text-xs text-red-400 uppercase">Expenses</p>
          <p className="text-lg font-bold text-red-300">
            ${summary.monthlyExpenses.toLocaleString()}
          </p>
        </div>
      </div>

      {/* Budget Status */}
      <div className="mb-4">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm text-gray-400">{budgetStatusText}</span>
          <span className="text-sm font-semibold text-white">
            {summary.budgetUsagePercentage.toFixed(0)}%
          </span>
        </div>
        <div className="w-full bg-gray-700 rounded-full h-3">
          <div
            className={`h-3 rounded-full transition-all bg-${summary.budgetStatusColor}-500`}
            style={{ width: `${Math.min(summary.budgetUsagePercentage, 100)}%` }}
          />
        </div>
        <p className="text-xs text-gray-500 mt-1">
          ${(summary.monthlyBudget - summary.monthlyExpenses).toLocaleString()} remaining
        </p>
      </div>

      {/* Investment Performance */}
      {summary.portfolioValue && (
        <div className="mb-4 p-3 bg-gray-900 rounded border border-gray-700">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-gray-500 uppercase">Portfolio</p>
              <p className="text-lg font-semibold text-white">
                ${summary.portfolioValue.toLocaleString()}
              </p>
            </div>
            <div className="flex items-center gap-1">
              {summary.portfolioMonthlyReturn && summary.portfolioMonthlyReturn > 0 ? (
                <TrendingUp className="text-green-500" size={20} />
              ) : (
                <TrendingDown className="text-red-500" size={20} />
              )}
              <span className={`text-sm font-bold ${
                summary.portfolioMonthlyReturn && summary.portfolioMonthlyReturn > 0
                  ? 'text-green-400'
                  : 'text-red-400'
              }`}>
                {summary.portfolioMonthlyReturn > 0 ? '+' : ''}
                {summary.portfolioMonthlyReturn?.toFixed(1)}%
              </span>
            </div>
          </div>
        </div>
      )}

      {/* Financial Goals */}
      {summary.activeGoals.length > 0 && (
        <div className="mb-4">
          <p className="text-xs text-gray-500 uppercase mb-2">Active Goals</p>
          {summary.activeGoals.slice(0, 2).map((goal, idx) => (
            <div key={idx} className="mb-2">
              <div className="flex items-center justify-between text-xs mb-1">
                <span className="text-gray-400">{goal.name}</span>
                <span className="text-white">{goal.progress.toFixed(0)}%</span>
              </div>
              <div className="w-full bg-gray-700 rounded-full h-1.5">
                <div
                  className="h-1.5 rounded-full bg-green-500"
                  style={{ width: `${goal.progress}%` }}
                />
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Footer */}
      <div className="flex items-center justify-between border-t border-gray-700 pt-3">
        <button
          className="px-3 py-1.5 bg-yellow-600 hover:bg-yellow-700 text-white rounded
                     text-sm font-semibold transition-colors"
          onClick={(e) => {
            e.stopPropagation();
            navigate('/finances');
          }}
        >
          Review Transactions
        </button>
        <div className="flex items-center text-gray-400 hover:text-white transition-colors">
          <span className="text-sm">View Details</span>
          <ChevronRight size={16} className="ml-1" />
        </div>
      </div>
    </div>
  );
};
```

**File Locations:**
- Create: supabase/migrations/create-finances-tables.sql
- Create: supabase/migrations/create-finances-area-summary-function.sql
- Create: src/hooks/useFinancesAreaSummary.ts
- Create: src/components/review/FinancesAreaCard.tsx
- Create: src/utils/financialCalculations.ts (helpers for net worth, budget usage, etc.)
- Update: src/pages/ReviewDashboard.tsx (integrate FinancesAreaCard)

### Testing

**Testing Requirements:** [Source: docs/prd/technical-assumptions.md]
Manual testing with systematic verification

**Finances Area Card Testing Workflow:**
1. **Net Worth Calculation:**
   - Create checking account: $10,000 (asset)
   - Create savings account: $25,000 (asset)
   - Create credit card: -$3,000 (liability)
   - Create investment account: $50,000 (asset)
   - Verify net worth = $82,000 ($85,000 assets - $3,000 liabilities)
   - Update account balance → verify net worth recalculates

2. **Monthly Revenue and Expenses:**
   - Add income transactions totaling $15,000 this month
   - Verify card shows "Revenue: $15,000"
   - Add expense transactions totaling $8,000 this month
   - Verify card shows "Expenses: $8,000"
   - Add transaction → verify totals update immediately

3. **Budget Status Tracking:**
   - Set monthly budget to $10,000
   - Expenses at $8,200 (82%)
   - Verify shows "82% of budget used"
   - Verify green progress bar (under 80%)
   - Add expense to reach $9,500 (95%)
   - Verify turns orange "Budget caution"
   - Exceed budget: $10,500 (105%)
   - Verify turns red "Over budget!" with AlertTriangle icon

4. **Budget Status Color Coding:**
   - <80%: green border and progress bar
   - 80-90%: yellow "Approaching limit"
   - 90-100%: orange "Budget caution"
   - >100%: red "Over budget!" with alert icon
   - Verify remaining amount: "Budget - Expenses = Remaining"

5. **Recent Transactions Count:**
   - Add 15 transactions in last 7 days
   - Verify shows "15 transactions this week"
   - Add transaction today → verify increments to 16
   - Transaction from 8 days ago → verify not counted

6. **Investment Performance:**
   - Create investment account with $45,000 balance
   - Set monthly return to +5.2%
   - Verify shows "Portfolio: $45,000" with TrendingUp icon
   - Verify shows "+5.2%" in green
   - Set negative return: -2.3%
   - Verify TrendingDown icon and red color
   - No investment accounts → verify widget hidden

7. **Top Spending Categories:**
   - Add transactions: Housing $2,500, Food $800, Transport $600, Other $500
   - Verify shows top 3: "Housing: $2,500 (40%), Food: $800 (13%), Transport: $600 (10%)"
   - Verify percentages sum correctly relative to total spending
   - Add larger transaction in new category → verify top 3 updates

8. **Financial Goals Progress:**
   - Create goal: "Emergency fund" target $10,000, current $8,000
   - Verify shows progress bar at 80%
   - Create goal: "Vacation fund" target $5,000, current $2,500
   - Verify shows both goals (max 2-3 displayed)
   - Update current amount → verify progress bar updates
   - Complete goal (100%) → verify shows "✅ Complete"

9. **Unusual Spending Detection:**
   - Typical dining: $500/month avg last 3 months
   - Current month dining: $800 (60% increase)
   - Verify warning: "⚠️ Dining spending 60% above typical"
   - Multiple anomalies → verify shows top 2 warnings
   - Dismiss warning → verify doesn't reappear

10. **Real-Time Updates:**
    - Open Review Dashboard in Tab 1 and Tab 2
    - Add transaction in Finances page (Tab 1)
    - Verify transaction count updates in Tab 2 within 500ms
    - Update account balance in Tab 1
    - Verify net worth updates in Tab 2
    - Add goal progress in Tab 1
    - Verify goal progress bar updates in Tab 2

11. **Review Transactions Button:**
    - Click "Review Transactions" button
    - Verify navigates to /finances page
    - Verify button click doesn't trigger card onClick (event.stopPropagation)
    - Verify button style: yellow background, white text

12. **Edge Cases:**
    - No budget set → verify shows "No budget configured"
    - Zero transactions → verify shows "0 transactions this week"
    - No financial goals → verify goals section hidden
    - Negative net worth (more liabilities than assets) → verify displays correctly with warning
    - Month just started (few transactions) → verify percentages calculated correctly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | v1.0 | Initial story creation for Finances Area Summary Card | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
