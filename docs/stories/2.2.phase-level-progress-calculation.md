# Story 2.2: Phase-Level Progress Calculation

## Status
Complete

## Story
**As a** project manager tracking multi-phase projects,
**I want** phases to automatically calculate completion percentage based on their tasks,
**so that** I can see phase progress without manually tracking individual task counts.

## Acceptance Criteria
1. Phase completion % is calculated as: (Sum of completed task %) / (Total number of tasks in phase)
2. Example: Phase with 4 tasks at [100%, 100%, 50%, 0%] shows 62.5% complete
3. Phase cards display progress bar showing calculated % complete with numerical percentage label
4. Progress bar uses color gradient: red (0-33%), yellow (34-66%), green (67-100%)
5. Phases with no tasks show "No tasks" state (not 0% or 100%)
6. Phase progress updates in real-time when tasks are added, removed, or status changes
7. Phase cards show task count summary: "3 of 8 tasks complete" alongside % bar
8. Clicking phase progress bar drills down to show constituent task list with individual statuses

## Tasks / Subtasks
- [x] Task 1: Create usePhaseProgress hook for progress calculation (AC: 1, 2, 5)
  - [x] Create src/hooks/usePhaseProgress.ts hook
  - [x] Implement calculation: (sum of task progress_percentage) / task count
  - [x] Handle edge case: phases with 0 tasks return null (not 0%)
  - [x] Example: [100%, 100%, 50%, 0%] = (250 / 4) = 62.5%
  - [x] Memoize calculation with useMemo to prevent re-renders
  - [x] Return { progress: number | null, completedCount: number, totalCount: number }
- [x] Task 2: Build ProgressBar UI component (AC: 3, 4)
  - [x] Create src/components/shared/ProgressBar.tsx component
  - [x] Accept props: progress (0-100), size ('sm' | 'md' | 'lg'), showLabel (boolean)
  - [x] Render progress bar with gradient background based on percentage
  - [x] Apply color gradient: 0-33% = red (bg-red-500), 34-66% = yellow (bg-yellow-500), 67-100% = green (bg-green-500)
  - [x] Display numerical percentage label when showLabel=true (e.g., "62.5%")
  - [x] Add smooth transition animation when progress changes (transition-all duration-300)
  - [x] Use Tailwind width utility: `style={{ width: ${progress}% }}`
- [x] Task 3: Update PhaseCard to display progress (AC: 3, 4, 7)
  - [x] Update src/components/business/PhaseCard.tsx to use ProgressBar
  - [x] Call usePhaseProgress(phaseId) to get progress data
  - [x] Display ProgressBar with calculated phase completion %
  - [x] Show task count summary: "X of Y tasks complete" below progress bar
  - [x] Calculate completed tasks: tasks.filter(t => t.progress_percentage === 100).length
  - [x] Handle "No tasks" state with gray placeholder text
  - [x] Ensure consistent styling with existing PhaseCard design
- [x] Task 4: Implement real-time progress updates (AC: 6)
  - [x] Verify useRealtimeSync hook triggers progress recalculation on task changes
  - [x] Test: update task progress in one tab → verify phase progress updates in another tab
  - [x] Use React Query cache invalidation to trigger usePhaseProgress refetch
  - [x] Verify sync latency <500ms for phase progress updates
  - [x] Ensure optimistic updates work: local progress updates before server confirmation
- [x] Task 5: Add drill-down functionality to show task list (AC: 8)
  - [x] Make ProgressBar clickable with onClick handler
  - [x] Create src/components/business/PhaseTasksList.tsx modal/dropdown component
  - [x] Display all tasks in phase with individual progress indicators (from Story 2.1)
  - [x] Show task title, progress percentage, due date, overdue indicator
  - [x] Add close button or click-outside-to-close behavior
- [x] Task 6: Add progress color gradient CSS utilities (AC: 4)
  - [x] Create src/utils/progressColors.ts utility function
  - [x] Function: getProgressColor(progress: number): string
  - [x] Return 'red' for 0-33%, 'yellow' for 34-66%, 'green' for 67-100%
  - [x] Export Tailwind class names: getProgressClasses(progress) → 'bg-red-500', 'bg-yellow-500', 'bg-green-500'
  - [x] Use in ProgressBar component for dynamic styling
- [x] Task 7: Update useProjects hook to include phase progress (AC: all)
  - [x] Hook already fetches tasks with progress_percentage
  - [x] Phase progress calculated client-side via usePhaseProgress hook
- [ ] Task 8: Add progress sorting and filtering to Business pages (AC: all) - DEFERRED
  - [ ] Add "Sort by Progress" option in Business page filters
  - [ ] Allow sorting phases by completion %: ascending (least complete first), descending
  - [ ] Filter phases by progress range: Not Started (0%), In Progress (1-99%), Completed (100%)
  - [ ] Highlight stalled phases (no task updates in 7+ days) with warning indicator
  - [ ] Show "Needs Attention" badge on phases <33% complete

## Dev Notes

### Previous Story Insights
**From Story 2.1:** [Source: docs/stories/2.1.task-level-progress-calculation.md]
- progress_percentage field exists on tasks table (INTEGER 0-100)
- ProgressIndicator component built for task-level visualization
- Real-time sync pattern established via useRealtimeSync hook
- Optimistic updates pattern in place for instant UI feedback

**From Story 1.1-1.2:** [Source: docs/stories/1.1-1.2]
- PhaseCard.tsx exists in src/components/business/PhaseCard.tsx
- Tasks table has phase_id foreign key linking tasks to phases
- useProjects.ts hook handles project/phase data fetching
- Business Dashboard page structure complete

**Key Technical Decisions:**
- Phase progress is calculated dynamically from task progress (not stored in database)
- Calculation uses average of task percentages, not simple completed/total ratio
- "No tasks" state explicitly handled to avoid confusing 0% with truly empty phases
- Progress color gradient (red/yellow/green) matches universal UX patterns for status

### Architecture Context

**Tech Stack:** [Source: docs/ui-architecture/2-frontend-tech-stack.md]
- React 19.1.1 + TypeScript 5.9.3
- TanStack Query 5.90.2 for caching
- Tailwind CSS 3.4.1 for styling
- Lucide React 0.544.0 for icons

**Progress Calculation Pattern:**
```typescript
// src/hooks/usePhaseProgress.ts
interface PhaseProgress {
  progress: number | null; // null if no tasks
  completedCount: number;
  totalCount: number;
}

export const usePhaseProgress = (phaseId: string): PhaseProgress => {
  const { data: tasks = [] } = useQuery({
    queryKey: ['tasks', 'phase', phaseId],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('tasks')
        .select('progress_percentage')
        .eq('phase_id', phaseId);

      if (error) throw error;
      return data;
    },
  });

  return useMemo(() => {
    if (tasks.length === 0) {
      return { progress: null, completedCount: 0, totalCount: 0 };
    }

    const totalProgress = tasks.reduce((sum, task) => sum + task.progress_percentage, 0);
    const averageProgress = totalProgress / tasks.length;
    const completedCount = tasks.filter(t => t.progress_percentage === 100).length;

    return {
      progress: Math.round(averageProgress * 10) / 10, // Round to 1 decimal
      completedCount,
      totalCount: tasks.length,
    };
  }, [tasks]);
};
```

**ProgressBar Component Pattern:**
```typescript
// src/components/shared/ProgressBar.tsx
interface ProgressBarProps {
  progress: number; // 0-100
  size?: 'sm' | 'md' | 'lg';
  showLabel?: boolean;
  onClick?: () => void;
}

export const ProgressBar: FC<ProgressBarProps> = ({
  progress,
  size = 'md',
  showLabel = true,
  onClick
}) => {
  const getColorClass = (p: number) => {
    if (p < 33) return 'bg-red-500';
    if (p < 67) return 'bg-yellow-500';
    return 'bg-green-500';
  };

  const heightClass = {
    sm: 'h-2',
    md: 'h-4',
    lg: 'h-6',
  }[size];

  return (
    <div
      className={`relative w-full ${heightClass} bg-gray-700 rounded-full overflow-hidden ${onClick ? 'cursor-pointer' : ''}`}
      onClick={onClick}
    >
      <div
        className={`h-full ${getColorClass(progress)} transition-all duration-300`}
        style={{ width: `${progress}%` }}
      />
      {showLabel && (
        <span className="absolute inset-0 flex items-center justify-center text-xs font-semibold text-white">
          {progress.toFixed(1)}%
        </span>
      )}
    </div>
  );
};
```

**Progress Color Utility:**
```typescript
// src/utils/progressColors.ts
export const getProgressColor = (progress: number): 'red' | 'yellow' | 'green' => {
  if (progress < 33) return 'red';
  if (progress < 67) return 'yellow';
  return 'green';
};

export const getProgressClasses = (progress: number): string => {
  const color = getProgressColor(progress);
  return `bg-${color}-500`;
};

export const getProgressTextColor = (progress: number): string => {
  const color = getProgressColor(progress);
  return `text-${color}-500`;
};
```

**File Locations:**
- Create: src/hooks/usePhaseProgress.ts
- Create: src/components/shared/ProgressBar.tsx
- Create: src/components/business/PhaseTasksList.tsx (drill-down modal)
- Create: src/utils/progressColors.ts
- Update: src/components/business/PhaseCard.tsx
- Update: src/hooks/useProjects.ts (include task data for progress calculation)

### Testing

**Testing Requirements:**
1. Verify all 8 acceptance criteria
2. Test progress calculation: create phase with tasks at [100%, 100%, 50%, 0%] → verify shows 62.5%
3. Test color gradient: verify red at 25%, yellow at 50%, green at 80%
4. Test "No tasks" state: create empty phase → verify shows "No tasks" not 0%
5. Test real-time updates: update task progress in one tab → verify phase progress updates in another tab
6. Test task count summary: verify "X of Y tasks complete" matches actual completed tasks
7. Test drill-down: click progress bar → verify task list modal displays all phase tasks
8. Test with multiple phases: verify each calculates independently
9. Measure sync latency: must be <500ms for progress recalculation
10. Test edge cases: single task phase, all tasks complete, all tasks incomplete

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | v1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None - Implementation completed successfully

### Completion Notes List
1. **Hook Already Existed**: usePhaseProgress was already implemented, validated correctness
2. **ProgressBar Enhancement**: Updated to use progressColors utility for consistency
3. **PhaseTasksList Modal**: Created drill-down modal showing all phase tasks with progress indicators
4. **progressColors Utility**: Created comprehensive color utility with getProgressColor, getProgressClasses, getProgressTextColor functions
5. **PhaseCard Drill-Down**: Added clickable progress display that opens PhaseTasksList modal
6. **Real-time Sync**: Already functional via React Query cache invalidation
7. **Task 8 Deferred**: Sorting/filtering not blocking for core AC, deferred to future enhancement

### File List
**New Files:**
- [src/utils/progressColors.ts](../../src/utils/progressColors.ts) - Progress color utility functions
- [src/components/business/PhaseTasksList.tsx](../../src/components/business/PhaseTasksList.tsx) - Drill-down modal for phase tasks

**Modified Files:**
- [src/components/shared/ProgressBar.tsx](../../src/components/shared/ProgressBar.tsx) - Now imports and uses progressColors utility
- [src/components/business/PhaseCard.tsx](../../src/components/business/PhaseCard.tsx) - Added drill-down functionality and PhaseTasksList modal
- [src/hooks/usePhaseProgress.ts](../../src/hooks/usePhaseProgress.ts) - Already existed, no changes needed

## QA Results
_To be populated by QA agent_
