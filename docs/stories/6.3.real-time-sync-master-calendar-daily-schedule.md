# Story 6.3: Real-time Sync - Master Calendar & Daily Schedule

**Epic**: 6 - Master Calendar & Daily Schedule Synchronization
**Status**: In Progress
**Dependencies**: Story 6.1 (Data Migration), Story 6.2 (UI Refactoring)
**Estimate**: 2 hours

## User Story

**As a** user
**I want** the Master Calendar and Daily Schedule to automatically sync in real-time
**So that** changes in one view immediately appear in the other without page refresh

## Context

Now that:
- Story 6.1 has migrated all scheduled tasks to `task_time_blocks` (single source of truth)
- Story 6.2 has refactored Daily Schedule to use the new hooks

We need to ensure that both views (Master Calendar and Daily Schedule) update in real-time when time blocks are created, updated, or deleted in either location.

## Acceptance Criteria

### AC1: Master Calendar Real-time Updates
- [ ] When a time block is created in Daily Schedule, it appears immediately in Master Calendar
- [ ] When a time block is updated in Daily Schedule, changes appear immediately in Master Calendar
- [ ] When a time block is deleted in Daily Schedule, it disappears immediately from Master Calendar
- [ ] Updates occur within 500ms without page refresh

### AC2: Daily Schedule Real-time Updates
- [ ] When a time block is created in Master Calendar, it appears immediately in Daily Schedule
- [ ] When a time block is updated in Master Calendar, changes appear immediately in Daily Schedule
- [ ] When a time block is deleted in Master Calendar, it disappears immediately from Daily Schedule
- [ ] Updates occur within 500ms without page refresh

### AC3: Bidirectional Sync
- [ ] Multiple users can edit schedules simultaneously without conflicts
- [ ] Real-time subscriptions handle concurrent updates gracefully
- [ ] No duplicate entries appear during sync
- [ ] Data consistency maintained across both views

### AC4: Performance
- [ ] Real-time sync does not cause UI lag or flickering
- [ ] Subscriptions properly clean up when components unmount
- [ ] No memory leaks from subscription handlers
- [ ] Network traffic is optimized (only changed data transmitted)

## Technical Approach

### 1. Verify Existing Real-time Hook
Check if `useRealtimeSync` already handles `task_time_blocks`:
```typescript
// src/hooks/useRealtimeSync.ts
// Should already subscribe to task_time_blocks table
```

### 2. Update Master Calendar Component
Ensure Master Calendar uses `useDailySchedule` hook and subscribes to real-time updates:

**Files to modify:**
- `src/components/calendar/MasterCalendar.tsx` (or equivalent)
- Add `useDailySchedule` hook
- Add real-time subscription via `useRealtimeSync`

### 3. Test Real-time Sync Flow

**Test scenario:**
1. Open Master Calendar in browser window A
2. Open Daily Schedule (Tasks page) in browser window B
3. Create a time block in window A → should appear in window B
4. Update a time block in window B → should update in window A
5. Delete a time block in window A → should disappear in window B

### 4. Handle Edge Cases

**Concurrent updates:**
- Use Supabase's built-in conflict resolution (last-write-wins)
- Display optimistic updates with rollback on error

**Network interruptions:**
- Supabase automatically reconnects subscriptions
- Query refetch on reconnection

**Component unmount:**
- Ensure subscriptions properly clean up in `useEffect` return

## Implementation Plan

### Phase 1: Audit Current State
1. ✅ Verify `useRealtimeSync` subscribes to `task_time_blocks`
2. ✅ Check Master Calendar component structure
3. ✅ Identify where Master Calendar fetches time block data

### Phase 2: Integrate Real-time Hooks
1. Add `useDailySchedule` to Master Calendar component
2. Add `useRealtimeSync` subscription for `task_time_blocks`
3. Update Master Calendar to use time block data from hooks

### Phase 3: Testing
1. Test bidirectional sync in two browser windows
2. Test concurrent updates
3. Test subscription cleanup on component unmount
4. Performance testing (measure update latency)

### Phase 4: Cleanup
1. Remove any duplicate data fetching logic
2. Ensure no legacy code remains that uses `tasks.scheduled_date/scheduled_time`
3. Update documentation

## Files to Modify

```
src/
├── components/
│   ├── calendar/
│   │   └── MasterCalendar.tsx          # Add real-time sync
│   └── tasks/
│       ├── DailySchedulePanel.tsx      # Already updated in Story 6.2
│       └── TasksHub.tsx                # Already updated in Story 6.2
├── hooks/
│   ├── useRealtimeSync.ts              # Verify task_time_blocks subscription
│   └── useDailySchedule.ts             # Already created in Story 6.2
```

## Testing Checklist

### Manual Testing
- [ ] Create time block in Master Calendar → appears in Daily Schedule
- [ ] Create time block in Daily Schedule → appears in Master Calendar
- [ ] Update time block in Master Calendar → updates in Daily Schedule
- [ ] Update time block in Daily Schedule → updates in Master Calendar
- [ ] Delete time block in Master Calendar → disappears from Daily Schedule
- [ ] Delete time block in Daily Schedule → disappears from Master Calendar
- [ ] Open two browser windows, test concurrent updates
- [ ] Check browser console for subscription errors
- [ ] Verify no memory leaks (Chrome DevTools Memory tab)

### Performance Testing
- [ ] Measure update latency (should be < 500ms)
- [ ] Check network tab for unnecessary queries
- [ ] Monitor subscription count in Supabase dashboard

## Success Metrics

- Real-time updates occur within 500ms
- Zero data inconsistencies between views
- Zero subscription-related errors in console
- Build passes with no TypeScript errors
- All manual tests pass

## Rollback Plan

If issues arise:
1. Revert Master Calendar changes
2. Fall back to polling-based updates (query refetch every 5 seconds)
3. Story 6.1 and 6.2 remain intact and functional

## Notes

- Supabase real-time subscriptions are already proven to work in Tasks Hub ↔ Business Projects sync
- Reuse same patterns from existing real-time implementation
- Master Calendar location needs to be confirmed (might be in `src/components/daily/Schedule.tsx` or separate calendar component)

## Follow-up Stories (Future)

- Add conflict resolution UI for concurrent edits
- Add offline support with sync on reconnection
- Add animation/transition when items update in real-time
