# Story 4.1: Deep Work Log Time Allocation Calculation

## Status
✅ **Complete** - Reverted to simple `area` string approach per user request

## Story
**As someone** managing multiple life areas,
**I want** the Deep Work log to automatically calculate time invested per area,
**so that** I can see where my hours are actually going without manual time tracking.

## Acceptance Criteria
1. Each Deep Work session is tagged with: **Area** (one of 7: Full Stack, S4, 808, Personal, Huge Capital, Golf, Health), **Task Type** (optional), **Task** (if applicable), and **Labels** (e.g., "$$$ Printer $$$")
2. Time allocation calculation aggregates Deep Work sessions by area: Total hours per area per day/week/month
3. Time allocation displayed in multiple views:
   - Daily: "Today you spent 3h on Full Stack, 2h on Huge Capital, 1h on Health"
   - Weekly: Bar chart showing hours per area across the week
   - Monthly: Trend line showing time distribution over 30 days
4. "Unallocated time" category captures hours not tagged to specific area (should be minimized)
5. Time allocation data is filterable: view by date range, by area, by label
6. Calculations update in real-time as new Deep Work sessions are logged
7. Export functionality allows downloading time allocation report as CSV

## Implementation Approach

**SIMPLE APPROACH - No business_id/life_area_id complexity:**
- Use `area TEXT` column with 7 predefined values
- Use `task_type TEXT` column for effort level (optional)
- Use existing `deep_work_log` table (not deep_work_sessions)
- Client-side aggregation instead of complex stored procedures

## Database Schema

**Table:** `deep_work_log` (existing table, enhanced)

```sql
CREATE TABLE deep_work_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- Simple string-based categorization
  area TEXT,  -- 'Full Stack', 'S4', '808', 'Personal', 'Huge Capital', 'Golf', 'Health'
  task_type TEXT,  -- '$$$ Printer $$$', '$ Makes Money $', '-$ Save Dat $-', ':( No Money ):', '8) Vibing (8'
  task_id UUID REFERENCES tasks(id) ON DELETE SET NULL,

  -- Session details
  labels TEXT[] DEFAULT '{}',
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ,
  duration_minutes INTEGER GENERATED ALWAYS AS (
    CASE
      WHEN end_time IS NOT NULL
      THEN EXTRACT(EPOCH FROM (end_time - start_time)) / 60
      ELSE NULL
    END
  ) STORED,
  notes TEXT,
  status TEXT DEFAULT 'active',  -- 'active', 'paused', 'completed', 'cancelled'

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_deep_work_log_user_id ON deep_work_log(user_id);
CREATE INDEX idx_deep_work_log_area ON deep_work_log(area);
CREATE INDEX idx_deep_work_log_task_type ON deep_work_log(task_type);
CREATE INDEX idx_deep_work_log_start_time ON deep_work_log(start_time);
CREATE INDEX idx_deep_work_log_task_id ON deep_work_log(task_id);
CREATE INDEX idx_deep_work_log_status ON deep_work_log(status);

-- Foreign key
ALTER TABLE deep_work_log
ADD CONSTRAINT deep_work_log_task_id_fkey
FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE SET NULL;
```

## Hooks Implementation

**`src/hooks/useDeepWorkSessions.ts`** - CRUD operations
```typescript
// Queries deep_work_log table directly
// Filters: area, taskType, taskId, status, dateRange, labels
// No complex joins to businesses/life_areas tables
```

**`src/hooks/useTimeAllocation.ts`** - Analytics
```typescript
// Client-side aggregation of deep_work_log data
// useDailyTimeAllocation(date) - hours per area for specific date
// useWeeklyTimeAllocation(weekStart) - hours by area across 7 days
// useMonthlyTimeAllocation(monthStart) - 30-day trend data
// useTimeByLabel(startDate, endDate) - time spent per label
```

## Components

**Timer:**
- `src/components/deep-work/DeepWorkTimer.tsx` - Simple area/task_type dropdowns

**Analytics:**
- `src/components/analytics/DailyTimeAllocation.tsx` - Color-coded chips showing today's allocation
- `src/components/analytics/WeeklyTimeChart.tsx` - Stacked bar chart (Recharts)
- `src/components/analytics/MonthlyTimeTrend.tsx` - Line chart (Recharts)

**Shared:**
- `src/components/shared/LabelSelector.tsx` - Multi-select label input

**Display:**
- `src/components/tasks/DeepWorkSessions.tsx` - Session list with area badges

**Utilities:**
- `src/utils/exportTimeAllocation.ts` - CSV export functionality

## Types

**`src/types/deepWork.ts`**
```typescript
export interface DeepWorkSession {
  id: string;
  user_id: string;
  area: string | null;  // Simple string
  task_type: string | null;  // Simple string
  task_id: string | null;
  session_name: string | null;
  labels: string[];
  start_time: string;
  end_time: string | null;
  duration_minutes: number | null;
  notes: string | null;
  status: 'active' | 'paused' | 'completed' | 'cancelled';
  created_at: string;
  updated_at: string;
  tasks?: { id: string; task_name: string; };  // Joined from tasks table
}

export interface DeepWorkFilters {
  dateRange?: { start: Date; end: Date; };
  area?: string;
  taskType?: string;
  taskId?: string;
  labels?: string[];
  status?: SessionStatus;
}
```

## Migrations Applied

1. `20251014140000_revert_to_deep_work_log.sql` - Dropped deep_work_sessions, enhanced deep_work_log
2. `20251014140001_fix_deep_work_log_foreign_keys.sql` - Fixed task_id foreign key

## Testing Checklist

✅ Deep Work sessions load with all historical data
✅ Area field displays correctly (no more businesses?.name nonsense)
✅ Timer can create new sessions with simple area dropdown
✅ Labels array is properly handled (null check added)
✅ Task relationship works (foreign key constraint)
✅ Real-time updates work across tabs
✅ No errors related to business_id or life_area_id

## Files Modified

**Created:**
- `supabase/migrations/20251014140000_revert_to_deep_work_log.sql`
- `supabase/migrations/20251014140001_fix_deep_work_log_foreign_keys.sql`
- `src/components/analytics/DailyTimeAllocation.tsx`
- `src/components/analytics/WeeklyTimeChart.tsx`
- `src/components/analytics/MonthlyTimeTrend.tsx`
- `src/components/shared/LabelSelector.tsx`
- `src/components/deep-work/DeepWorkTimer.tsx`
- `src/utils/exportTimeAllocation.ts`
- `src/hooks/useTimeAllocation.ts`

**Modified:**
- `src/hooks/useDeepWorkSessions.ts` - Simplified to use area/task_type, removed business joins
- `src/components/tasks/DeepWorkSessions.tsx` - Use session.area directly (3 places)
- `src/types/deepWork.ts` - Removed business_id/life_area_id fields, simplified types
- `src/components/deep-work/DeepWorkTimer.tsx` - Simple area/task_type dropdowns

## Key Decisions

**Why we reverted to simple approach:**
1. User explicitly requested: "i dont want the business or life area id's i told you that.. please only use area"
2. Original `deep_work_log` table was working fine
3. Complex foreign key relationships were unnecessary
4. Simple string-based approach is more flexible and easier to maintain

**Areas (7 options):**
- 'Full Stack', 'S4', '808', 'Personal', 'Huge Capital', 'Golf', 'Health'

**Task Types (5 options):**
- '$$$ Printer $$$', '$ Makes Money $', '-$ Save Dat $-', ':( No Money ):', '8) Vibing (8'

## Completion Date
2025-10-14

## Dev Notes
- User wanted simple approach, not complex business_id/life_area_id foreign keys
- All historical data preserved from deep_work_log table
- No data loss during migration
- Client-side aggregation performs well with current data volume
