# Story 4.2: Area-Level Time Investment Analytics (New Page)

## Status
Draft

## Story
**As someone** balancing 7 life areas,
**I want** a dedicated analytics page showing time invested per area,
**so that** I can ensure balanced attention across work and life without modifying existing pages.

## Acceptance Criteria
1. NEW page at `/analytics` route displays area-level time investment dashboard (does NOT modify existing Business Projects page)
2. Each of 7 areas (Full Stack, S4, 808, Personal, Huge Capital, Golf, Health) shows "Time Invested" card with:
   - Total hours (all-time)
   - Hours this week
   - Hours this month
   - Average hours per week over last 4 weeks
3. Area-level time allocation breakdown by projects within that area (pie chart or bar chart)
4. Alert indicator if area has received zero hours for 7+ consecutive days: "⚠️ No time allocated this week"
5. Area comparison view shows all 7 areas side-by-side with time investment bars for relative comparison
6. "Time Budget" feature allows setting target hours per area per week, with visual indicator showing actual vs. target
7. Historical time trends: line graph showing hours invested in each area over last 3 months
8. Labels within area (e.g., "Internal Build", "Bug Fix", "Client Meeting") show time breakdown for internal analysis
9. Navigation: Add "Time Analytics" link to main navigation menu
10. All time calculations aggregate Deep Work sessions by area field from tasks table

## Tasks / Subtasks
- [ ] Task 1: Create new Analytics page route (AC: 1, 9)
  - [ ] Create src/pages/TimeAnalytics.tsx (new route: /analytics)
  - [ ] Add route to App.tsx: <Route path="/analytics" element={<TimeAnalytics />} />
  - [ ] Add "Time Analytics" link to main navigation/sidebar
  - [ ] Page layout: Header with title "Time Analytics" + grid of area cards
  - [ ] Responsive: 3 columns desktop, 2 columns tablet, 1 column mobile
  - [ ] Page does NOT modify existing Business Projects page

- [ ] Task 2: Create area-level time aggregation queries (AC: 2, 10)
  - [ ] Query Deep Work sessions via tasks.area field
  - [ ] SQL: SELECT tasks.area, SUM(duration_minutes) / 60.0 FROM deep_work_sessions JOIN tasks ON deep_work_sessions.task_id = tasks.id GROUP BY tasks.area
  - [ ] Calculate hours for each of 7 areas: Full Stack, S4, 808, Personal, Huge Capital, Golf, Health
  - [ ] Time periods: This week (last 7 days), This month (last 30 days), All-time
  - [ ] Average per week: SUM(last 4 weeks) / 4
  - [ ] Create src/hooks/useAreaTimeStats.ts with React Query
  - [ ] Cache with 5-minute staleTime

- [ ] Task 3: Build AreaTimeCard component (AC: 2)
  - [ ] Create src/components/analytics/AreaTimeCard.tsx
  - [ ] Display area name with color-coded header (match task area colors)
  - [ ] Show 4 metrics: All-Time | This Week | This Month | Avg/Week
  - [ ] Primary metric: This Week (larger font, highlighted)
  - [ ] Trend indicators: ↑ +2h vs last week (green) or ↓ -3h (red)
  - [ ] Loading skeleton while fetching
  - [ ] Click card → expand to show details

- [ ] Task 4: Implement zero-time alerts (AC: 4)
  - [ ] Check last Deep Work session per area
  - [ ] Query: MAX(dws.start_time) WHERE tasks.area = ?
  - [ ] If > 7 days ago, show warning badge on AreaTimeCard
  - [ ] Alert: "⚠️ No time this week (last: 10 days ago)"
  - [ ] Yellow border on card if zero hours in 7+ days

- [ ] Task 5: Build area comparison view (AC: 5)
  - [ ] Create src/components/analytics/AreaComparisonChart.tsx
  - [ ] Horizontal bar chart: Y-axis = 7 areas, X-axis = hours this week
  - [ ] Use Recharts BarChart component
  - [ ] Color-code bars by area (match task area colors)
  - [ ] Sort options: by most hours, by least hours, alphabetical
  - [ ] Highlight: top area (gold badge), bottom area (red indicator)
  - [ ] Total bar at bottom: sum of all areas

- [ ] Task 6: Implement time budget feature (AC: 6)
  - [ ] Add area_time_budgets table: id, user_id, area TEXT, target_hours_per_week INTEGER
  - [ ] Create src/components/analytics/TimeBudgetIndicator.tsx
  - [ ] Display: "Target: 10h/week, Actual: 8h (80%)" with progress bar
  - [ ] Progress bar colors: green (>=100%), yellow (75-99%), red (<75%)
  - [ ] Settings UI: Set budget per area (modal with numeric input)
  - [ ] Save to area_time_budgets table
  - [ ] Show on AreaTimeCard beneath hours

- [ ] Task 7: Build historical time trend visualization (AC: 7)
  - [ ] Create src/components/analytics/AreaTimeTrend.tsx using Recharts LineChart
  - [ ] Query: Hours per area per day for last 90 days
  - [ ] Multi-line chart: one line per area (7 lines total)
  - [ ] X-axis: dates, Y-axis: hours per day
  - [ ] Legend: area names with colors
  - [ ] Toggle: show/hide specific areas
  - [ ] Aggregate options: daily, weekly, monthly
  - [ ] Tooltip: shows all areas' hours for selected date

- [ ] Task 8: Implement label breakdown by area (AC: 8)
  - [ ] Create src/components/analytics/AreaLabelBreakdown.tsx
  - [ ] Query: SELECT tasks.area, dws.labels, SUM(duration_minutes) FROM deep_work_sessions JOIN tasks
  - [ ] Group by area and label
  - [ ] Stacked bar chart: areas on X-axis, labels as stacked segments
  - [ ] Common labels: "Internal Build", "$$$ Printer $$$", "Client Meeting", "Bug Fix"
  - [ ] Color-code: revenue ($$$) green, internal blue, maintenance gray
  - [ ] Filter by date range

- [ ] Task 9: Integrate all components into Analytics page (AC: all)
  - [ ] Layout: TimeAnalytics.tsx structure:
    - Section 1: Area Comparison Chart (full width)
    - Section 2: Grid of 7 AreaTimeCard components (3 columns)
    - Section 3: AreaTimeTrend (full width, collapsible)
    - Section 4: AreaLabelBreakdown (full width)
  - [ ] Add date range filter (this week, this month, last 3 months)
  - [ ] Export button: download CSV of area time stats
  - [ ] Loading states for all components
  - [ ] Empty state: "No Deep Work sessions logged yet"

- [ ] Task 10: Create area time budget settings UI (AC: 6)
  - [ ] Add "Time Budgets" section to Settings page
  - [ ] List all 7 areas with target input fields
  - [ ] Save button: updates area_time_budgets table
  - [ ] Default targets (optional): Full Stack 10h, S4 6h, 808 4h, Personal 5h, Huge Capital 8h, Golf 2h, Health 5h
  - [ ] Reset to defaults button

## Dev Notes

### Previous Story Insights
**From Story 4.1:** [Source: docs/stories/4.1.deep-work-time-allocation-calculation.md]
- deep_work_sessions table linked to tasks (task_id foreign key)
- Tasks have area field: 'Full Stack' | 'S4' | '808' | 'Personal' | 'Huge Capital' | 'Golf' | 'Health'
- Time aggregation queries by area
- useDeepWorkSessions hook with React Query
- Real-time sync infrastructure

### Architecture Context

**Tech Stack:**
- React 19.1.1 + TypeScript 5.9.3
- TanStack Query 5.90.2 for data fetching
- Recharts for visualizations
- date-fns 4.1.0 for date calculations

**Database Schema:**
```sql
-- Add area time budgets table
CREATE TABLE area_time_budgets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  area TEXT NOT NULL CHECK (area IN ('Full Stack', 'S4', '808', 'Personal', 'Huge Capital', 'Golf', 'Health')),
  target_hours_per_week INTEGER NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, area)
);

ALTER TABLE area_time_budgets ENABLE ROW LEVEL SECURITY;
CREATE POLICY area_time_budgets_policy ON area_time_budgets FOR ALL USING (user_id = auth.uid());
```

**Area Time Stats Query:**
```sql
CREATE OR REPLACE FUNCTION get_area_time_stats(p_user_id UUID, p_area TEXT)
RETURNS JSONB AS $$
  SELECT jsonb_build_object(
    'area', p_area,
    'total_hours', COALESCE(SUM(dws.duration_minutes) / 60.0, 0),
    'hours_this_week', COALESCE(SUM(
      CASE WHEN dws.start_time >= NOW() - INTERVAL '7 days'
      THEN dws.duration_minutes ELSE 0 END
    ) / 60.0, 0),
    'hours_this_month', COALESCE(SUM(
      CASE WHEN dws.start_time >= NOW() - INTERVAL '30 days'
      THEN dws.duration_minutes ELSE 0 END
    ) / 60.0, 0),
    'avg_hours_per_week', COALESCE(SUM(
      CASE WHEN dws.start_time >= NOW() - INTERVAL '28 days'
      THEN dws.duration_minutes ELSE 0 END
    ) / 60.0 / 4, 0),
    'last_session_date', MAX(dws.start_time),
    'days_since_last', EXTRACT(DAY FROM NOW() - MAX(dws.start_time))::INTEGER
  )
  FROM deep_work_sessions dws
  JOIN tasks t ON dws.task_id = t.id
  WHERE t.user_id = p_user_id AND t.area = p_area;
$$ LANGUAGE SQL STABLE;
```

**React Query Hook:**
```typescript
// src/hooks/useAreaTimeStats.ts
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase';

export const useAreaTimeStats = (area: string) => {
  return useQuery({
    queryKey: ['area-time-stats', area],
    queryFn: async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase.rpc('get_area_time_stats', {
        p_user_id: user.id,
        p_area: area,
      });

      if (error) throw error;
      return data as {
        area: string;
        total_hours: number;
        hours_this_week: number;
        hours_this_month: number;
        avg_hours_per_week: number;
        last_session_date: string;
        days_since_last: number;
      };
    },
    staleTime: 5 * 60 * 1000, // 5 minutes
  });
};

export const useAllAreasTimeStats = () => {
  const areas = ['Full Stack', 'S4', '808', 'Personal', 'Huge Capital', 'Golf', 'Health'];

  return useQueries({
    queries: areas.map(area => ({
      queryKey: ['area-time-stats', area],
      queryFn: async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        const { data, error } = await supabase.rpc('get_area_time_stats', {
          p_user_id: user.id,
          p_area: area,
        });

        if (error) throw error;
        return data;
      },
      staleTime: 5 * 60 * 1000,
    })),
  });
};
```

**Component Pattern:**
```typescript
// src/components/analytics/AreaTimeCard.tsx
import { TrendingUp, TrendingDown, AlertTriangle } from 'lucide-react';
import { useAreaTimeStats } from '@/hooks/useAreaTimeStats';

interface AreaTimeCardProps {
  area: 'Full Stack' | 'S4' | '808' | 'Personal' | 'Huge Capital' | 'Golf' | 'Health';
  color: string;
}

export const AreaTimeCard: React.FC<AreaTimeCardProps> = ({ area, color }) => {
  const { data: stats, isLoading } = useAreaTimeStats(area);

  if (isLoading) return <div className="animate-pulse bg-gray-200 h-48 rounded-lg"></div>;

  const showZeroTimeAlert = stats.days_since_last > 7;

  return (
    <div className={`bg-white rounded-lg shadow-md p-6 border-l-4`} style={{ borderColor: color }}>
      {showZeroTimeAlert && (
        <div className="flex items-center text-yellow-600 mb-3">
          <AlertTriangle className="w-4 h-4 mr-2" />
          <span className="text-sm">No time this week (last: {stats.days_since_last} days ago)</span>
        </div>
      )}

      <h3 className="text-xl font-bold mb-4" style={{ color }}>{area}</h3>

      <div className="grid grid-cols-2 gap-3">
        <div>
          <div className="text-sm text-gray-600">This Week</div>
          <div className="text-3xl font-bold text-blue-600">{stats.hours_this_week.toFixed(1)}h</div>
        </div>
        <div>
          <div className="text-sm text-gray-600">This Month</div>
          <div className="text-2xl font-semibold">{stats.hours_this_month.toFixed(1)}h</div>
        </div>
        <div>
          <div className="text-sm text-gray-600">All-Time</div>
          <div className="text-xl">{stats.total_hours.toFixed(1)}h</div>
        </div>
        <div>
          <div className="text-sm text-gray-600">Avg/Week</div>
          <div className="text-xl">{stats.avg_hours_per_week.toFixed(1)}h</div>
        </div>
      </div>
    </div>
  );
};
```

**File Locations:**
- Create: src/pages/TimeAnalytics.tsx (NEW page)
- Create: src/components/analytics/AreaTimeCard.tsx
- Create: src/components/analytics/AreaComparisonChart.tsx
- Create: src/components/analytics/AreaTimeTrend.tsx
- Create: src/components/analytics/AreaLabelBreakdown.tsx
- Create: src/components/analytics/TimeBudgetIndicator.tsx
- Create: src/hooks/useAreaTimeStats.ts
- Create: src/hooks/useAreaTimeBudgets.ts
- Create: supabase/migrations/area_time_budgets.sql
- Update: src/App.tsx (add /analytics route)
- Update: src/components/Sidebar.tsx (add Time Analytics link)

### Testing

**Testing Requirements:**
Manual testing with systematic verification

**Area Time Analytics Validation Workflow:**

1. **New Page Creation:**
   - Navigate to /analytics
   - Verify page loads with "Time Analytics" title
   - Verify page does NOT modify Business Projects page
   - Verify responsive layout (3 cols desktop, 2 tablet, 1 mobile)

2. **Area Time Cards:**
   - Create 10h of Deep Work sessions tagged to "Full Stack" area this week
   - Navigate to /analytics
   - Verify Full Stack card shows: This Week = 10h
   - Create 5h more sessions → verify card updates to 15h
   - Verify other time periods calculate correctly

3. **Zero-Time Alerts:**
   - Ensure "Golf" area has no sessions in 10 days
   - Verify Golf card shows warning: "No time this week (last: 10 days ago)"
   - Verify yellow alert icon
   - Add session to Golf → verify alert disappears

4. **Area Comparison Chart:**
   - Verify bar chart shows all 7 areas
   - Verify bars sized relative to hours (Full Stack longest if most hours)
   - Sort by "Most Hours" → verify correct ordering
   - Verify colors match area colors from tasks

5. **Time Budget Feature:**
   - Set budget for Health: 5h/week
   - Create 3h of Health sessions
   - Verify shows "Target: 5h, Actual: 3h (60%)" with red progress bar
   - Add 3h more → verify turns green (120%)

6. **Historical Trend:**
   - Create sessions across 90 days with varying amounts
   - Verify 7 lines shown (one per area)
   - Toggle off "Personal" → verify line hidden
   - Hover over line → verify tooltip shows date and hours

7. **End-to-End:**
   - Start Deep Work timer on task with area "Huge Capital"
   - Work 2h → stop timer
   - Navigate to /analytics immediately
   - Verify Huge Capital card shows +2h this week (real-time)
   - Open second tab → verify updates within 500ms

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | v1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-14 | v2.0 | Major rewrite: area-based analytics, new /analytics page | John (Product Manager) |

## Dev Agent Record
### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
