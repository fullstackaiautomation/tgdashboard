# Story 6.2: Tasks Hub Page Cleanup & Enhancements

**Epic**: [Epic 6: Dashboard Cleanup](../../prd/epic-6-dashboard-cleanup.md)
**Status**: Ready for Implementation
**Created**: 2025-10-26

---

## User Story

As a **dashboard user**,
I want **a streamlined Tasks Hub with improved recurring task generation, reorganized task card dropdown, and a more compact add task modal**,
So that **I can efficiently manage my tasks with better time tracking visibility and a cleaner interface**.

---

## Story Context

### Existing System Integration

- **Component**: [AddTaskModal.tsx](../../../src/components/tasks/AddTaskModal.tsx)
- **Component**: [EnhancedTaskCard.tsx](../../../src/components/tasks/EnhancedTaskCard.tsx)
- **Database Table**: `tasks` (see [DATABASE.md](../../DATABASE.md))
- **Technology**: React, TypeScript, Tailwind CSS
- **Patterns**: Modal forms, dropdown menus, recurring task creation

### Current State

The Tasks Hub currently has:
1. Recurring task functionality that creates tasks with dates in the name
2. A task card dropdown (three dots menu) with automation/status columns
3. An Add Task modal with a multi-row layout including Status and Priority fields

### Required Changes

This story implements three major cleanup improvements:

**1. Recurring Task Setup Functionality**
- Fix recurring task generation system
- Generate all recurring tasks for the week on the Sunday before
- Ensure robust week-ahead population

**2. Task Card Dropdown Reorganization**
- Move "Time Tracking Log" to middle column
- Move current middle column (automation/status info) to right column
- Improve visibility of time tracking features

**3. Add Task Modal Restructure**
- Remove Status and Priority fields entirely
- Reorganize layout into more compact 3-row structure
- Reduce modal height while maintaining all essential fields

---

## Acceptance Criteria

### Functional Requirements

#### 1. Recurring Task Weekly Generation
- [ ] Recurring tasks generate for the entire upcoming week
- [ ] Generation occurs on Sunday before the target week starts
- [ ] Support for all recurring types: Weekdays (M-F), Weekly, Bi-Weekly, Monthly
- [ ] Generated tasks have proper date formatting in task name (MM/DD/YY)
- [ ] Database correctly stores `recurring_type` and `recurring_interval`
- [ ] No duplicate tasks are created for existing weeks
- [ ] Generation is triggered automatically or via scheduled job

#### 2. Task Card Dropdown Column Reorganization
- [ ] Three-dot dropdown menu opens with three-column layout
- [ ] **Left Column**: (Unchanged) Existing functionality
- [ ] **Middle Column**: Time Tracking Log (moved from previous position)
- [ ] **Right Column**: Created date, Automation status (moved from middle)
- [ ] All dropdown functionality remains intact
- [ ] Proper alignment and spacing maintained

#### 3. Add Task Modal Layout Restructure
- [ ] **Row 1**: Task Name (full width)
- [ ] **Row 2**: Description (full width, textarea)
- [ ] **Row 3**: Business | Project | Phase (3-column grid)
- [ ] **Row 4**: Due Date | Effort Level | Automation (3-column grid)
- [ ] **Row 5**: Hours Projected | Make Recurring checkbox (2-column)
- [ ] **Row 6**: (Conditional) Recurring Type buttons (Weekdays, Weekly, Bi-Weekly, Monthly)
- [ ] Status and Priority fields completely removed from form
- [ ] Default values set in backend: Status = "Not started", Priority = "Medium"
- [ ] Modal height reduced by ~30% compared to current layout
- [ ] All field validations remain functional

### Integration Requirements

#### 4. Existing Functionality Preserved
- [ ] Task creation continues to work for both standalone and linked tasks
- [ ] Task editing in EnhancedTaskCard remains unchanged
- [ ] Real-time sync with Business Projects maintained
- [ ] Undo functionality (30-second window) preserved
- [ ] Filtering and search in Tasks Hub unaffected

#### 5. Database Compatibility
- [ ] New tasks default to `status='Not started'` and `priority='Medium'`
- [ ] Recurring task fields (`recurring_type`, `recurring_interval`) properly populated
- [ ] No breaking changes to existing task records
- [ ] Migration script (if needed) for recurring task generation logic

### Quality Requirements

#### 6. Testing & Validation
- [ ] Create recurring task for each type (Weekdays, Weekly, Bi-Weekly, Monthly)
- [ ] Verify weekly generation on Sunday creates all tasks for following week
- [ ] Test task card dropdown shows time tracking in middle column
- [ ] Create tasks with and without business/project/phase linking
- [ ] Verify compact modal layout on different screen sizes
- [ ] Test that removed Status/Priority fields don't cause errors
- [ ] Confirm real-time sync still works across Tasks Hub and Business Projects

#### 7. UI/UX Quality
- [ ] Modal is visually balanced and compact
- [ ] Dropdown columns are clearly organized and readable
- [ ] Recurring task creation is intuitive
- [ ] No visual regressions in task cards or task list
- [ ] Proper loading states and error handling

---

## Technical Implementation Plan

### Phase 1: Recurring Task Weekly Generation System

**Files to Modify/Create:**
- `src/hooks/useTasks.ts` - Add weekly generation logic
- `src/utils/recurringTaskGenerator.ts` (NEW) - Core generation logic
- `supabase/functions/generate-recurring-tasks/index.ts` (NEW) - Edge Function for automation
- `src/components/tasks/AddTaskModal.tsx` - Update recurring task creation

**Implementation Details:**

1. **Create Recurring Task Generator Utility**
   ```typescript
   // src/utils/recurringTaskGenerator.ts

   interface RecurringTaskConfig {
     baseName: string;
     recurringType: 'weekdays' | 'weekly' | 'biweekly' | 'monthly';
     startDate: Date; // Sunday of target week
     taskTemplate: CreateTaskDTO;
   }

   export function generateWeekTasks(config: RecurringTaskConfig): CreateTaskDTO[] {
     const tasks: CreateTaskDTO[] = [];
     const { baseName, recurringType, startDate, taskTemplate } = config;

     // Logic to generate tasks for the week based on recurringType
     // - Weekdays: M-F (5 tasks)
     // - Weekly: Same day of week (1 task)
     // - Bi-weekly: Same day every 2 weeks (1 task if applicable)
     // - Monthly: Same date of month (1 task if applicable)

     // Each task name: "{baseName} MM/DD/YY"
     // Each task gets proper due_date, recurring_type, recurring_interval

     return tasks;
   }
   ```

2. **Add Supabase Edge Function for Scheduled Generation**
   ```typescript
   // supabase/functions/generate-recurring-tasks/index.ts

   // Runs every Sunday at midnight
   // Queries all recurring tasks (where recurring_type != 'none')
   // For each recurring task, generates instances for upcoming week
   // Checks for duplicates before inserting
   ```

3. **Update AddTaskModal to Use New Generation Logic**
   - When user creates recurring task, store as template in database
   - Generate first instance immediately
   - Edge function handles future generations

**Database Changes:**
- Add `is_recurring_template` boolean to `tasks` table
- Add `recurring_base_name` text to store original name without date
- Create index on `recurring_type` for efficient querying

### Phase 2: Task Card Dropdown Reorganization

**Files to Modify:**
- `src/components/tasks/EnhancedTaskCard.tsx`

**Current Dropdown Structure Analysis:**
```tsx
// Current: Need to identify exact dropdown implementation
// Look for three-dot menu button and its associated dropdown/popover
```

**Implementation Steps:**

1. Locate the dropdown menu code in EnhancedTaskCard.tsx
2. Identify Time Tracking Log component/button
3. Reorganize dropdown columns:
   ```tsx
   <DropdownMenu>
     <DropdownColumns>
       <LeftColumn>
         {/* Existing left column content */}
       </LeftColumn>
       <MiddleColumn>
         {/* Move Time Tracking Log here */}
         <TimeTrackingLogButton />
       </MiddleColumn>
       <RightColumn>
         {/* Move automation/created info here */}
         <CreatedDate />
         <AutomationStatus />
       </RightColumn>
     </DropdownColumns>
   </DropdownMenu>
   ```

**Note**: Need to read full EnhancedTaskCard.tsx to identify dropdown implementation details.

### Phase 3: Add Task Modal Restructure

**Files to Modify:**
- `src/components/tasks/AddTaskModal.tsx`

**Current Layout (Lines 220-400):**
- Row 1: Status | Priority | Due Date (grid-cols-3)
- Row 2: Business | Project | Phase (grid-cols-3)
- Row 3: Effort Level | Automation (grid-cols-2)
- Row 4: Hours Projected
- Row 5: Recurring checkbox + type buttons

**New Layout:**
```tsx
<form onSubmit={handleSubmit} className="space-y-4">
  {/* Row 1: Task Name - UNCHANGED */}
  <div>
    <label>Task Name *</label>
    <input type="text" value={taskName} ... />
  </div>

  {/* Row 2: Description - UNCHANGED */}
  <div>
    <label>Description</label>
    <textarea value={description} ... />
  </div>

  {/* Row 3: Business | Project | Phase - MOVED UP */}
  <div className="grid grid-cols-3 gap-4">
    <div>
      <label>Business</label>
      <select value={selectedBusinessId} ... />
    </div>
    <div>
      <label>Project</label>
      <select value={selectedProjectId} ... />
    </div>
    <div>
      <label>Phase</label>
      <select value={selectedPhaseId} ... />
    </div>
  </div>

  {/* Row 4: Due Date | Effort Level | Automation - NEW */}
  <div className="grid grid-cols-3 gap-4">
    <div>
      <label>Due Date</label>
      <DateTimePicker ... />
    </div>
    <div>
      <label>Effort Level</label>
      <select value={effortLevel} ... />
    </div>
    <div>
      <label>Automation</label>
      <select value={automation} ... />
    </div>
  </div>

  {/* Row 5: Hours Projected | Make Recurring - NEW */}
  <div className="grid grid-cols-2 gap-4">
    <div>
      <label>Hours Projected</label>
      <input type="number" value={hoursProjected} ... />
    </div>
    <div className="flex items-center gap-2">
      <input type="checkbox" checked={isRecurring} ... />
      <label>Make this a recurring task</label>
    </div>
  </div>

  {/* Row 6: Recurring Type Buttons (Conditional) - UNCHANGED */}
  {isRecurring && (
    <div className="grid grid-cols-4 gap-3">
      <button>Weekdays (M-F)</button>
      <button>Weekly</button>
      <button>Bi-Weekly</button>
      <button>Monthly</button>
    </div>
  )}

  {/* Form Actions - UNCHANGED */}
  <div className="flex justify-end gap-2">
    <button type="button" onClick={onClose}>Cancel</button>
    <button type="submit">Create Task</button>
  </div>
</form>
```

**Changes to Make:**
1. Remove Status field (lines 222-236)
2. Remove Priority field (lines 238-252)
3. Move Business/Project/Phase section up (currently lines 278-341)
4. Create new Row 4 with Due Date, Effort Level, Automation
5. Create new Row 5 with Hours Projected and Recurring checkbox inline
6. Update handleSubmit to set default status="Not started" and priority="Medium"

**Code Changes:**
```typescript
// Remove state for status and priority
// const [status, setStatus] = useState<TaskStatus>('Not started'); // REMOVE
// const [priority, setPriority] = useState<Priority>('Medium'); // REMOVE

// In handleSubmit, set defaults:
const newTask: CreateTaskDTO = {
  task_name: taskName.trim(),
  description: description.trim() || undefined,
  status: 'Not started', // HARDCODED DEFAULT
  priority: 'Medium',    // HARDCODED DEFAULT
  due_date: dueDateISO,
  // ... rest of fields
};
```

---

## Definition of Done

- [ ] Recurring tasks generate for entire week on Sunday before
- [ ] Time Tracking Log appears in middle column of task card dropdown
- [ ] Add Task modal uses new compact layout without Status/Priority
- [ ] All existing task functionality works (creation, editing, deletion, undo)
- [ ] Real-time sync between Tasks Hub and Business Projects maintained
- [ ] No visual regressions in Tasks Hub, task cards, or modals
- [ ] Code follows existing patterns in [IMPLEMENTATION-GUIDE.md](../../IMPLEMENTATION-GUIDE.md)
- [ ] Manual testing completed for all recurring types and modal layouts
- [ ] Edge Function (if created) scheduled and tested on staging
- [ ] Database migration (if needed) applied successfully
- [ ] Progress documented in [progress.md](../../../progress.md)

---

## Risk Assessment & Mitigation

### Primary Risks

**Risk 1: Recurring Task Generation Complexity**
- **Impact**: High - Core feature for weekly task management
- **Mitigation**:
  - Start with simple weekly generation logic
  - Thoroughly test duplicate prevention
  - Add comprehensive logging for debugging
  - Create manual trigger endpoint for testing

**Risk 2: Modal Layout Responsiveness**
- **Impact**: Medium - Compact layout may not work on small screens
- **Mitigation**:
  - Test on mobile viewports (375px, 768px, 1024px)
  - Use Tailwind responsive utilities (sm:, md:, lg:)
  - Ensure modal remains scrollable if content overflows

**Risk 3: Dropdown Column Alignment**
- **Impact**: Low - Visual inconsistency in task card dropdown
- **Mitigation**:
  - Use CSS Grid for precise column control
  - Test with varying content lengths
  - Maintain existing dropdown trigger behavior

### Rollback Plan

- Git commit after each phase (Phase 1, Phase 2, Phase 3)
- Feature flags for recurring task generation (if using Edge Function)
- Preserve old modal layout in commented code for quick revert
- Database migrations are additive only (no destructive changes)

---

## Implementation Notes

### Recurring Task Strategy

**Option A: Supabase Edge Function + Cron**
- **Pros**: Automated, runs server-side, no client dependency
- **Cons**: Requires Supabase function deployment, cron setup
- **Recommended**: ✅ Best for production

**Option B: Client-side Generation on App Load**
- **Pros**: No backend changes, immediate testing
- **Cons**: Only runs when user opens app, less reliable
- **Recommended**: ⚠️ Good for MVP/testing phase

**Recommendation**: Start with Option B for immediate functionality, migrate to Option A for production robustness.

### Database Migration

```sql
-- Add recurring task template fields (if needed)
ALTER TABLE tasks ADD COLUMN is_recurring_template BOOLEAN DEFAULT FALSE;
ALTER TABLE tasks ADD COLUMN recurring_base_name TEXT;
CREATE INDEX idx_tasks_recurring_type ON tasks(recurring_type) WHERE recurring_type != 'none';
```

### Testing Checklist

- [ ] Create Weekdays recurring task on Thursday → Verify 5 tasks generated for next week
- [ ] Create Weekly recurring task on Saturday → Verify 1 task generated for next week
- [ ] Create Bi-Weekly recurring task → Verify correct week selection
- [ ] Create Monthly recurring task → Verify correct date handling
- [ ] Open task card dropdown → Verify Time Tracking Log in middle column
- [ ] Create task via new modal → Verify all fields save correctly
- [ ] Create task without business → Verify standalone task creation
- [ ] Edit existing task → Verify no regressions in EnhancedTaskCard
- [ ] Delete recurring task → Verify template and instances handled correctly

---

## Related Documentation

- [Epic 6: Dashboard Cleanup](../../prd/epic-6-dashboard-cleanup.md)
- [ARCHITECTURE.md](../../ARCHITECTURE.md) - Tasks Hub component structure
- [DATABASE.md](../../DATABASE.md) - Tasks table schema
- [IMPLEMENTATION-GUIDE.md](../../IMPLEMENTATION-GUIDE.md) - Development patterns

---

## Story Handoff for Developer

### Quick Start

1. **Read this entire story** to understand all requirements
2. **Review current implementation**:
   - [AddTaskModal.tsx](../../../src/components/tasks/AddTaskModal.tsx) - Focus on lines 40-42 (recurring), 220-276 (layout)
   - [EnhancedTaskCard.tsx](../../../src/components/tasks/EnhancedTaskCard.tsx) - Locate dropdown menu code
3. **Implement in order**: Phase 1 → Phase 2 → Phase 3
4. **Test after each phase** using Testing Checklist above
5. **Update [progress.md](../../../progress.md)** when complete

### Key Files to Modify

| File | Changes | Lines to Focus |
|------|---------|----------------|
| `AddTaskModal.tsx` | Remove Status/Priority, restructure layout | 33-34, 220-400 |
| `EnhancedTaskCard.tsx` | Reorganize dropdown columns | TBD (locate dropdown) |
| `useTasks.ts` | Add recurring generation hook | New functionality |
| `recurringTaskGenerator.ts` | Create utility | New file |

### Questions for Clarification

Before starting implementation, developer should clarify:
1. Should recurring task generation be automatic (Edge Function) or manual trigger?
2. What should happen to existing recurring tasks created before this story?
3. Should Status/Priority be hidden or removed entirely from database writes?
4. Are there any existing Edge Functions to reference for recurring task pattern?

---

**Story Created By**: PM Agent (John)
**Ready for**: Development Team
**Estimated Effort**: 8-12 hours (split across 3 phases)
