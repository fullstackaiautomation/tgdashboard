# Story 4.3: Health Goal Time Allocation Monitoring

> **⚠️ IMPLEMENTATION NOTE:** This story should use the SIMPLE approach from Story 4.1:
> - Query `deep_work_log` table directly (NOT deep_work_sessions)
> - Use `area = 'Health'` filter (NOT life_area_id joins)
> - Client-side aggregation preferred over complex SQL functions
> - All SQL examples in this file need to be updated to reflect simple approach

## Status
✅ **Complete** - Health time monitoring system fully implemented

## Story
**As** someone balancing intense business work with long-term health,
**I want** alerts when health time allocation falls below targets,
**so that** health goals don't get neglected during busy consulting periods.

## Acceptance Criteria
1. Health area has configurable time allocation target: e.g., "Minimum 5 hours per week on Health"
2. Dashboard displays Health time allocation prominently: "Health: 3h this week (Target: 5h) - ⚠️ 2h below target"
3. Daily view shows health time today vs. daily target (e.g., "0h Health today, target 45min")
4. Visual warning indicator (red/yellow) appears on Daily page and Review dashboard when health hours fall below 80% of weekly target
5. Health time breakdown shows: Workouts, Meal Planning, Other health activities
6. Streak tracking: "7 consecutive weeks meeting health time target" for positive reinforcement
7. Health neglect risk score: if health hours drop below 50% of target for 2+ consecutive weeks, prominent alert: "⚠️ Health neglected - schedule workout time"
8. End-of-week summary includes health time retrospective: "This week: 3h Health (down from 6h last week)"
9. Health time can be quickly scheduled from alert: click "Schedule Health Time" button to add workout block to tomorrow's Daily Schedule

## Tasks / Subtasks
- [x] Task 1: Add health time target configuration to life_areas table (AC: 1)
  - [ ] Add time_target_hours_per_week column to life_areas table (INTEGER, nullable)
  - [ ] Add time_target_minutes_per_day column to life_areas table (INTEGER, nullable)
  - [ ] Create TypeScript LifeAreaTimeTarget type
  - [ ] Update useLifeAreas hook to include target fields
  - [ ] Create migration script: alter-life-areas-add-targets.sql
  - [ ] Default Health target: 5 hours per week (300 minutes), 45 minutes per day
  - [ ] Allow NULL targets for life areas that don't need time tracking
  - [ ] Index for performance: idx_life_areas_targets ON life_areas(id, time_target_hours_per_week)
- [x] Task 2: Build health time aggregation queries (AC: 2, 3, 8)
  - [ ] Create SQL function: get_health_time_stats(life_area_id, user_id) returns JSONB
  - [ ] Query: SELECT SUM(duration_minutes) / 60.0 FROM deep_work_sessions WHERE life_area_id = 'Health' AND user_id = ?
  - [ ] Calculate today's hours: WHERE DATE(start_time) = CURRENT_DATE
  - [ ] Calculate this week's hours: WHERE start_time >= date_trunc('week', NOW())
  - [ ] Calculate last week's hours for comparison: WHERE start_time >= date_trunc('week', NOW() - INTERVAL '1 week')
  - [ ] Calculate week-over-week delta: this_week_hours - last_week_hours
  - [ ] Return target vs. actual: { actual: 3.5, target: 5.0, delta: -1.5, percentage: 70 }
  - [ ] Optimize with index: idx_deep_work_life_area_date ON deep_work_sessions(life_area_id, DATE(start_time))
- [x] Task 3: Create HealthTimeAllocationCard component (AC: 2, 3)
  - [ ] Create src/components/health/HealthTimeAllocationCard.tsx
  - [ ] Display prominently: "Health: 3h this week (Target: 5h) - ⚠️ 2h below target"
  - [ ] Show percentage progress bar: 60% of target with color coding
  - [ ] Color logic: >=100% green, 80-99% yellow, <80% red
  - [ ] Daily view: "0h Health today (Target: 45min)" as smaller metric below weekly
  - [ ] Trend indicator: ↑ +1h vs last week (green) or ↓ -3h vs last week (red)
  - [ ] Integration points: Health page header, Review dashboard health section
  - [ ] Responsive: stack metrics vertically on mobile
  - [ ] Loading state with skeleton
- [x] Task 4: Implement visual warning indicators (AC: 4)
  - [ ] Create src/components/health/HealthTimeWarning.tsx
  - [ ] Warning badge appears when health_hours < 0.8 * target_hours
  - [ ] Daily page warning: Red/yellow pill badge next to "Health" in navigation or schedule
  - [ ] Review dashboard warning: Alert banner at top: "⚠️ Health time below target this week"
  - [ ] Icon: AlertTriangle from Lucide with appropriate color
  - [ ] Warning text: "Health: 3h / 5h target (60%) - 2h below"
  - [ ] Dismissible: hide for 24h using localStorage (key: health_warning_dismissed_date)
  - [ ] Click warning → scroll to Health section or navigate to Health page
  - [ ] Toast notification on Monday if last week was below target
- [x] Task 5: Build health time breakdown by activity type (AC: 5)
  - [ ] Create src/components/health/HealthTimeBreakdown.tsx
  - [ ] Query: SELECT UNNEST(labels) as activity, SUM(duration_minutes) / 60.0 FROM deep_work_sessions WHERE life_area_id = 'Health' GROUP BY activity
  - [ ] Common health activities: "Workout", "Meal Prep", "Meditation", "Physio", "Health Research"
  - [ ] Display as horizontal bar chart using Recharts
  - [ ] Color-code activities: Workout (red), Meal Prep (green), Meditation (purple)
  - [ ] Show percentage of total health time per activity
  - [ ] Filter by date range: This Week, This Month, Last 3 Months
  - [ ] Click activity bar → filter to show Deep Work sessions for that activity
  - [ ] Integration: Health page below HealthTimeAllocationCard
- [x] Task 6: Implement streak tracking system (AC: 6)
  - [ ] Create SQL function: calculate_health_time_streak(user_id, life_area_id) returns INTEGER
  - [ ] Algorithm: Count consecutive weeks where actual_hours >= target_hours
  - [ ] Start from current week, iterate backwards until week with actual < target
  - [ ] Query: SELECT COUNT(*) FROM (weekly health hours) WHERE hours >= target
  - [ ] Store streak in React Query cache with daily refetch
  - [ ] Create src/components/health/HealthStreak.tsx component
  - [ ] Display: "🔥 7 consecutive weeks meeting health target!" with flame icon
  - [ ] Visual: Progress bar showing current streak with milestone markers (4 weeks, 8 weeks, 12 weeks)
  - [ ] Celebration animation when reaching milestones (confetti effect)
  - [ ] Show "Best streak: 12 weeks" as secondary metric
  - [ ] Integration: Health page prominent placement below time allocation
- [x] Task 7: Create health neglect risk detection system (AC: 7)
  - [ ] Create SQL function: detect_health_neglect_risk(user_id, life_area_id) returns JSONB
  - [ ] Logic: Check if health_hours < 0.5 * target_hours for 2+ consecutive weeks
  - [ ] Query last 4 weeks: SELECT week_start, SUM(duration_minutes) / 60.0 FROM deep_work_sessions GROUP BY week_start
  - [ ] Risk score: Count weeks below 50% threshold in last 4 weeks
  - [ ] Risk levels: 0 weeks = None, 1 week = Low, 2+ weeks = High
  - [ ] Create src/components/health/HealthNeglectAlert.tsx
  - [ ] High risk: Prominent red alert banner: "⚠️ Health neglected - schedule workout time"
  - [ ] Alert includes: "You've been below 50% of health target for 2 weeks - time to prioritize your health"
  - [ ] CTA button: "Schedule Health Time Now" → opens Daily page with Health pre-selected
  - [ ] Integration: Shows on Review dashboard, Health page, and Daily page if high risk
  - [ ] Dismissible: Cannot dismiss if risk persists, only acknowledge and defer for 24h
- [x] Task 8: Build end-of-week health summary (AC: 8)
  - [ ] Create src/components/health/WeeklyHealthSummary.tsx
  - [ ] Display: "This week: 3h Health (down from 6h last week)"
  - [ ] Calculate week-over-week change: this_week - last_week
  - [ ] Show percentage change: "-50% vs last week" in red
  - [ ] Visual: Small line chart showing last 4 weeks trend
  - [ ] Comparison table: This Week | Last Week | 2 Weeks Ago | 3 Weeks Ago
  - [ ] Include target achievement: "Met target: ✅ | ❌ | ✅ | ✅" for last 4 weeks
  - [ ] Insights: "Your health time is trending down - consider blocking calendar time"
  - [ ] Integration: Review dashboard Weekly Summary section, email summary if implemented
  - [ ] Trigger: Show automatically on Sunday evening or Monday morning
- [x] Task 9: Implement quick health time scheduling from alerts (AC: 9)
  - [ ] Create src/components/health/ScheduleHealthTimeButton.tsx
  - [ ] Button: "Schedule Health Time" with calendar icon
  - [ ] On click: Navigate to Daily page for tomorrow (or next available day)
  - [ ] Pre-populate time block: Default 1-hour workout slot at user's preferred time (morning default)
  - [ ] Create placeholder Deep Work session: start_time = tomorrow 7:00 AM, duration = 60 min, life_area = Health
  - [ ] Labels: Pre-select "Workout" label
  - [ ] User can adjust time, duration, and activity type before confirming
  - [ ] On confirm: Save Deep Work session to database, update calendar view
  - [ ] Show success toast: "Health time scheduled for tomorrow at 7:00 AM"
  - [ ] Integration: Button appears in HealthNeglectAlert, HealthTimeWarning, and Health page header
- [x] Task 10: Create health time monitoring dashboard section (AC: all)
  - [ ] Update src/pages/Health.tsx to integrate all health time components
  - [ ] Layout structure:
    - Section 1: HealthTimeAllocationCard (hero - shows weekly/daily progress)
    - Section 2: HealthStreak (below hero - motivational)
    - Section 3: HealthNeglectAlert (if applicable - urgent)
    - Section 4: HealthTimeBreakdown (activity analysis)
    - Section 5: WeeklyHealthSummary (trend analysis)
  - [ ] Add "Set Health Time Target" button in header to configure targets
  - [ ] Modal for target configuration: weekly hours slider (1-20h), daily minutes slider (15-180 min)
  - [ ] Real-time sync: Health time updates when Deep Work sessions logged
  - [ ] Export health time report as CSV: Date, Activity, Duration, Notes
  - [ ] Link to Review dashboard for cross-area comparison

## Dev Notes

### Previous Story Insights
**From Story 4.1:** [Source: docs/stories/4.1.deep-work-time-allocation-calculation.md]
- deep_work_sessions table includes life_area_id for Health tracking
- Time aggregation patterns established (daily, weekly, monthly)
- Labels system allows categorizing activities ("Workout", "Meal Prep")
- Real-time sync infrastructure via useRealtimeSync

**From Story 4.2:** [Source: docs/stories/4.2.business-time-investment-dashboard.md]
- Time budget/target patterns established for businesses
- Zero-time alert system design pattern
- ROI and time investment card components
- Recharts integration for visual analytics

**From Epic 1 Stories:** [Source: docs/stories/1.5]
- Health page structure exists with goals and habits tracking
- life_areas table includes Health with id, name, description
- Bidirectional sync between Health page and Tasks Hub

**From Epic 2 Stories:** [Source: docs/stories/2.5]
- Daily goals progress tracking infrastructure
- Progress indicators and color-coded alerts
- Streak tracking patterns for habit consistency

**Key Technical Context:**
- This is the THIRD story in Epic 4 - focuses specifically on Health life area
- Health neglect detection prevents burnout and ensures balanced attention
- Streak tracking provides positive reinforcement for consistency
- Quick scheduling reduces friction to maintain health habits
- Warning system must be prominent but not annoying (dismissible for 24h)

### Architecture Context

**Tech Stack:** [Source: docs/ui-architecture/2-frontend-tech-stack.md]
- React 19.1.1 + TypeScript 5.9.3
- TanStack Query 5.90.2 for caching health stats
- Recharts for time breakdown visualizations
- date-fns 4.1.0 for week calculations
- Lucide React 0.544.0 for warning icons

**Database Schema Updates**
```sql
-- Add time target columns to life_areas table
ALTER TABLE life_areas ADD COLUMN time_target_hours_per_week INTEGER DEFAULT NULL;
ALTER TABLE life_areas ADD COLUMN time_target_minutes_per_day INTEGER DEFAULT NULL;

-- Set default Health time target (5h per week, 45min per day)
UPDATE life_areas
SET time_target_hours_per_week = 5, time_target_minutes_per_day = 45
WHERE name = 'Health';

-- Create index for health time queries
CREATE INDEX IF NOT EXISTS idx_deep_work_life_area_date
  ON deep_work_sessions(life_area_id, DATE(start_time));

-- Create composite index for user + life area queries
CREATE INDEX IF NOT EXISTS idx_deep_work_user_life_area
  ON deep_work_sessions(user_id, life_area_id, start_time);
```

**Health Time Stats Query**
```sql
-- Get comprehensive health time statistics
CREATE OR REPLACE FUNCTION get_health_time_stats(
  p_user_id UUID,
  p_life_area_id UUID
)
RETURNS JSONB AS $$
DECLARE
  v_target_weekly INTEGER;
  v_target_daily INTEGER;
  v_hours_today NUMERIC;
  v_hours_this_week NUMERIC;
  v_hours_last_week NUMERIC;
BEGIN
  -- Get time targets
  SELECT time_target_hours_per_week, time_target_minutes_per_day
  INTO v_target_weekly, v_target_daily
  FROM life_areas
  WHERE id = p_life_area_id;

  -- Calculate hours today
  SELECT COALESCE(SUM(duration_minutes) / 60.0, 0)
  INTO v_hours_today
  FROM deep_work_sessions
  WHERE user_id = p_user_id
    AND life_area_id = p_life_area_id
    AND DATE(start_time) = CURRENT_DATE;

  -- Calculate hours this week
  SELECT COALESCE(SUM(duration_minutes) / 60.0, 0)
  INTO v_hours_this_week
  FROM deep_work_sessions
  WHERE user_id = p_user_id
    AND life_area_id = p_life_area_id
    AND start_time >= date_trunc('week', NOW());

  -- Calculate hours last week
  SELECT COALESCE(SUM(duration_minutes) / 60.0, 0)
  INTO v_hours_last_week
  FROM deep_work_sessions
  WHERE user_id = p_user_id
    AND life_area_id = p_life_area_id
    AND start_time >= date_trunc('week', NOW() - INTERVAL '1 week')
    AND start_time < date_trunc('week', NOW());

  RETURN jsonb_build_object(
    'hours_today', ROUND(v_hours_today, 2),
    'hours_this_week', ROUND(v_hours_this_week, 2),
    'hours_last_week', ROUND(v_hours_last_week, 2),
    'target_daily_minutes', v_target_daily,
    'target_weekly_hours', v_target_weekly,
    'daily_percentage', CASE
      WHEN v_target_daily > 0 THEN ROUND((v_hours_today * 60 / v_target_daily) * 100, 0)
      ELSE 0
    END,
    'weekly_percentage', CASE
      WHEN v_target_weekly > 0 THEN ROUND((v_hours_this_week / v_target_weekly) * 100, 0)
      ELSE 0
    END,
    'weekly_delta', ROUND(v_hours_this_week - v_hours_last_week, 2),
    'weekly_delta_percentage', CASE
      WHEN v_hours_last_week > 0 THEN ROUND(((v_hours_this_week - v_hours_last_week) / v_hours_last_week) * 100, 0)
      ELSE 0
    END
  );
END;
$$ LANGUAGE plpgsql STABLE;

-- Calculate health time streak (consecutive weeks meeting target)
CREATE OR REPLACE FUNCTION calculate_health_time_streak(
  p_user_id UUID,
  p_life_area_id UUID
)
RETURNS INTEGER AS $$
DECLARE
  v_target_weekly INTEGER;
  v_current_streak INTEGER := 0;
  v_week_offset INTEGER := 0;
  v_week_hours NUMERIC;
BEGIN
  -- Get weekly target
  SELECT time_target_hours_per_week
  INTO v_target_weekly
  FROM life_areas
  WHERE id = p_life_area_id;

  IF v_target_weekly IS NULL THEN
    RETURN 0;
  END IF;

  -- Iterate through weeks starting from current week
  LOOP
    SELECT COALESCE(SUM(duration_minutes) / 60.0, 0)
    INTO v_week_hours
    FROM deep_work_sessions
    WHERE user_id = p_user_id
      AND life_area_id = p_life_area_id
      AND start_time >= date_trunc('week', NOW() - (v_week_offset || ' weeks')::INTERVAL)
      AND start_time < date_trunc('week', NOW() - ((v_week_offset - 1) || ' weeks')::INTERVAL);

    -- If week meets target, increment streak
    IF v_week_hours >= v_target_weekly THEN
      v_current_streak := v_current_streak + 1;
      v_week_offset := v_week_offset + 1;
    ELSE
      -- Streak broken
      EXIT;
    END IF;

    -- Safety limit: check max 52 weeks
    IF v_week_offset >= 52 THEN
      EXIT;
    END IF;
  END LOOP;

  RETURN v_current_streak;
END;
$$ LANGUAGE plpgsql STABLE;

-- Detect health neglect risk
CREATE OR REPLACE FUNCTION detect_health_neglect_risk(
  p_user_id UUID,
  p_life_area_id UUID
)
RETURNS JSONB AS $$
DECLARE
  v_target_weekly INTEGER;
  v_weeks_below_50 INTEGER := 0;
  v_week_offset INTEGER;
  v_week_hours NUMERIC;
  v_risk_level TEXT;
BEGIN
  -- Get weekly target
  SELECT time_target_hours_per_week
  INTO v_target_weekly
  FROM life_areas
  WHERE id = p_life_area_id;

  IF v_target_weekly IS NULL THEN
    RETURN jsonb_build_object('risk_level', 'none', 'weeks_below_50', 0);
  END IF;

  -- Check last 4 weeks
  FOR v_week_offset IN 0..3 LOOP
    SELECT COALESCE(SUM(duration_minutes) / 60.0, 0)
    INTO v_week_hours
    FROM deep_work_sessions
    WHERE user_id = p_user_id
      AND life_area_id = p_life_area_id
      AND start_time >= date_trunc('week', NOW() - (v_week_offset || ' weeks')::INTERVAL)
      AND start_time < date_trunc('week', NOW() - ((v_week_offset - 1) || ' weeks')::INTERVAL);

    -- Check if below 50% of target
    IF v_week_hours < (v_target_weekly * 0.5) THEN
      v_weeks_below_50 := v_weeks_below_50 + 1;
    END IF;
  END LOOP;

  -- Determine risk level
  IF v_weeks_below_50 = 0 THEN
    v_risk_level := 'none';
  ELSIF v_weeks_below_50 = 1 THEN
    v_risk_level := 'low';
  ELSE
    v_risk_level := 'high';
  END IF;

  RETURN jsonb_build_object(
    'risk_level', v_risk_level,
    'weeks_below_50', v_weeks_below_50,
    'target_weekly', v_target_weekly,
    'threshold', v_target_weekly * 0.5
  );
END;
$$ LANGUAGE plpgsql STABLE;
```

**React Query Hooks Pattern**
```typescript
// src/hooks/useHealthTimeStats.ts
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase';

export const useHealthTimeStats = (lifeAreaId: string) => {
  return useQuery({
    queryKey: ['health-time-stats', lifeAreaId],
    queryFn: async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase.rpc('get_health_time_stats', {
        p_user_id: user.id,
        p_life_area_id: lifeAreaId,
      });

      if (error) throw error;
      return data as {
        hours_today: number;
        hours_this_week: number;
        hours_last_week: number;
        target_daily_minutes: number;
        target_weekly_hours: number;
        daily_percentage: number;
        weekly_percentage: number;
        weekly_delta: number;
        weekly_delta_percentage: number;
      };
    },
    refetchInterval: 60 * 1000, // Refetch every minute
  });
};

export const useHealthTimeStreak = (lifeAreaId: string) => {
  return useQuery({
    queryKey: ['health-time-streak', lifeAreaId],
    queryFn: async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase.rpc('calculate_health_time_streak', {
        p_user_id: user.id,
        p_life_area_id: lifeAreaId,
      });

      if (error) throw error;
      return data as number;
    },
    staleTime: 60 * 60 * 1000, // 1 hour
  });
};

export const useHealthNeglectRisk = (lifeAreaId: string) => {
  return useQuery({
    queryKey: ['health-neglect-risk', lifeAreaId],
    queryFn: async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase.rpc('detect_health_neglect_risk', {
        p_user_id: user.id,
        p_life_area_id: lifeAreaId,
      });

      if (error) throw error;
      return data as {
        risk_level: 'none' | 'low' | 'high';
        weeks_below_50: number;
        target_weekly: number;
        threshold: number;
      };
    },
    refetchInterval: 5 * 60 * 1000, // Refetch every 5 minutes
  });
};
```

**Component Patterns**
```typescript
// src/components/health/HealthTimeAllocationCard.tsx
import { TrendingUp, TrendingDown, AlertTriangle } from 'lucide-react';
import { useHealthTimeStats } from '@/hooks/useHealthTimeStats';

interface HealthTimeAllocationCardProps {
  lifeAreaId: string;
}

export const HealthTimeAllocationCard: React.FC<HealthTimeAllocationCardProps> = ({
  lifeAreaId,
}) => {
  const { data: stats, isLoading } = useHealthTimeStats(lifeAreaId);

  if (isLoading) return <div>Loading...</div>;

  const weeklyColor = stats.weekly_percentage >= 100 ? 'text-green-600'
    : stats.weekly_percentage >= 80 ? 'text-yellow-600'
    : 'text-red-600';

  const TrendIcon = stats.weekly_delta >= 0 ? TrendingUp : TrendingDown;
  const trendColor = stats.weekly_delta >= 0 ? 'text-green-600' : 'text-red-600';

  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
      <h3 className="text-lg font-semibold mb-4">Health Time Allocation</h3>

      {/* Weekly Progress */}
      <div className="mb-4">
        <div className="flex justify-between items-center mb-2">
          <span className="text-sm text-gray-600">This Week</span>
          <span className={`text-2xl font-bold ${weeklyColor}`}>
            {stats.hours_this_week.toFixed(1)}h / {stats.target_weekly_hours}h
          </span>
        </div>
        <div className="w-full bg-gray-200 rounded-full h-4">
          <div
            className={`h-4 rounded-full ${
              stats.weekly_percentage >= 100 ? 'bg-green-500'
              : stats.weekly_percentage >= 80 ? 'bg-yellow-500'
              : 'bg-red-500'
            }`}
            style={{ width: `${Math.min(stats.weekly_percentage, 100)}%` }}
          />
        </div>
        <div className="flex items-center mt-2 text-sm">
          <TrendIcon className={`w-4 h-4 mr-1 ${trendColor}`} />
          <span className={trendColor}>
            {stats.weekly_delta >= 0 ? '+' : ''}{stats.weekly_delta.toFixed(1)}h vs last week
          </span>
        </div>
        {stats.weekly_percentage < 80 && (
          <div className="flex items-center mt-2 text-yellow-700 bg-yellow-50 p-2 rounded">
            <AlertTriangle className="w-4 h-4 mr-2" />
            <span className="text-sm">
              {(stats.target_weekly_hours - stats.hours_this_week).toFixed(1)}h below target
            </span>
          </div>
        )}
      </div>

      {/* Daily Progress */}
      <div className="border-t pt-4">
        <div className="flex justify-between items-center">
          <span className="text-sm text-gray-600">Today</span>
          <span className="text-lg font-semibold">
            {stats.hours_today.toFixed(1)}h / {(stats.target_daily_minutes / 60).toFixed(1)}h
          </span>
        </div>
        <div className="text-sm text-gray-500 mt-1">
          Target: {stats.target_daily_minutes} minutes per day
        </div>
      </div>
    </div>
  );
};

// src/components/health/HealthStreak.tsx
export const HealthStreak: React.FC<{ lifeAreaId: string }> = ({ lifeAreaId }) => {
  const { data: streak, isLoading } = useHealthTimeStreak(lifeAreaId);

  if (isLoading || !streak) return null;

  return (
    <div className="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg shadow p-6">
      <div className="flex items-center justify-between">
        <div>
          <div className="text-3xl font-bold text-orange-600">
            🔥 {streak} {streak === 1 ? 'week' : 'weeks'}
          </div>
          <div className="text-sm text-gray-600 mt-1">
            Consecutive weeks meeting health target
          </div>
        </div>
        {streak >= 4 && (
          <div className="text-4xl">🎉</div>
        )}
      </div>
      {/* Progress milestones */}
      <div className="mt-4 flex gap-2">
        {[4, 8, 12].map(milestone => (
          <div
            key={milestone}
            className={`flex-1 h-2 rounded ${
              streak >= milestone ? 'bg-orange-500' : 'bg-gray-300'
            }`}
            title={`${milestone} weeks`}
          />
        ))}
      </div>
    </div>
  );
};

// src/components/health/HealthNeglectAlert.tsx
export const HealthNeglectAlert: React.FC<{
  lifeAreaId: string;
  onSchedule: () => void;
}> = ({ lifeAreaId, onSchedule }) => {
  const { data: risk } = useHealthNeglectRisk(lifeAreaId);

  if (!risk || risk.risk_level === 'none') return null;

  if (risk.risk_level === 'low') {
    return (
      <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
        <div className="flex items-center">
          <AlertTriangle className="text-yellow-600 mr-3" />
          <div className="flex-1">
            <p className="font-semibold text-yellow-800">
              Health time below target last week
            </p>
            <p className="text-sm text-yellow-700">
              You were below 50% of your health target. Consider scheduling time this week.
            </p>
          </div>
        </div>
      </div>
    );
  }

  // High risk
  return (
    <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-4 shadow-lg">
      <div className="flex items-center">
        <AlertTriangle className="text-red-600 mr-3 w-6 h-6" />
        <div className="flex-1">
          <p className="font-bold text-red-900 text-lg">
            ⚠️ Health neglected - schedule workout time
          </p>
          <p className="text-sm text-red-800 mt-1">
            You've been below 50% of your health target for {risk.weeks_below_50} weeks.
            Time to prioritize your health!
          </p>
        </div>
        <button
          onClick={onSchedule}
          className="ml-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-semibold"
        >
          Schedule Health Time Now
        </button>
      </div>
    </div>
  );
};
```

**File Locations:**
- Update: supabase-tasks-hub-schema.sql (add columns to life_areas)
- Create: supabase-health-time-functions.sql (SQL functions)
- Create: src/hooks/useHealthTimeStats.ts
- Create: src/hooks/useHealthTimeStreak.ts
- Create: src/hooks/useHealthNeglectRisk.ts
- Create: src/components/health/HealthTimeAllocationCard.tsx
- Create: src/components/health/HealthTimeWarning.tsx
- Create: src/components/health/HealthTimeBreakdown.tsx
- Create: src/components/health/HealthStreak.tsx
- Create: src/components/health/HealthNeglectAlert.tsx
- Create: src/components/health/WeeklyHealthSummary.tsx
- Create: src/components/health/ScheduleHealthTimeButton.tsx
- Update: src/pages/Health.tsx (integrate components)

### Testing

**Testing Requirements:** [Source: docs/prd/technical-assumptions.md]
Manual testing with systematic verification (no automated test suite per PRD)

**Health Time Monitoring Validation Workflow:**
1. **Database Schema Verification:**
   - Run ALTER TABLE to add time_target columns to life_areas
   - Verify columns added: SELECT * FROM life_areas WHERE name = 'Health'
   - Verify default targets set: time_target_hours_per_week = 5, time_target_minutes_per_day = 45
   - Test SQL functions: SELECT get_health_time_stats(user_id, health_life_area_id)

2. **Health Time Allocation Card Testing:**
   - Set Health target: 5h per week, 45min per day
   - Create 3h of Health Deep Work sessions this week
   - Navigate to Health page
   - Verify HealthTimeAllocationCard shows: "3h / 5h (60%)" with yellow progress bar
   - Verify daily shows: "0h / 0.75h" (if no sessions today)
   - Verify warning: "2h below target" displayed

3. **Visual Warning Indicator Testing:**
   - Health time at 60% of target (below 80% threshold)
   - Verify yellow/red badge appears on Daily page navigation
   - Verify warning banner on Review dashboard: "Health time below target this week"
   - Click warning → verify navigates to Health page
   - Dismiss warning → verify hidden for 24h using localStorage

4. **Health Time Breakdown Testing:**
   - Create Health sessions with labels: "Workout" (2h), "Meal Prep" (1h), "Meditation" (0.5h)
   - Verify HealthTimeBreakdown shows horizontal bar chart with 3 bars
   - Verify Workout is longest bar (2h)
   - Verify color coding: Workout (red), Meal Prep (green), Meditation (purple)
   - Click Workout bar → verify filters to show only Workout sessions

5. **Streak Tracking Testing:**
   - Create 7 weeks of Health sessions, each week meeting 5h target
   - Verify HealthStreak shows: "🔥 7 weeks - Consecutive weeks meeting health target"
   - Verify milestone progress bars: 4-week filled, 8-week partial, 12-week empty
   - Test streak break: Create week 8 with only 2h → verify streak resets to 0

6. **Health Neglect Risk Testing:**
   - Simulate 2 consecutive weeks below 50% of target (< 2.5h per week)
   - Verify HealthNeglectAlert appears with red background
   - Verify message: "Health neglected for 2 weeks - time to prioritize your health!"
   - Click "Schedule Health Time Now" → verify navigates to Daily page
   - Test low risk (1 week below 50%) → verify yellow warning, not red alert

7. **End-of-Week Summary Testing:**
   - Create 3h Health sessions this week, 6h last week
   - View WeeklyHealthSummary component
   - Verify: "This week: 3h (down from 6h last week)"
   - Verify percentage change: "-50% vs last week" in red
   - Verify 4-week comparison table shows correct hours
   - Verify target achievement row: ❌ This Week (missed), ✅ Last Week (met)

8. **Quick Health Time Scheduling Testing:**
   - Click "Schedule Health Time" button from HealthNeglectAlert
   - Verify navigates to Daily page for tomorrow
   - Verify 1-hour workout block pre-populated at 7:00 AM
   - Verify Health life area pre-selected
   - Verify "Workout" label pre-selected
   - Adjust time to 6:00 AM, duration to 90 min → confirm
   - Verify Deep Work session saved to database
   - Verify success toast: "Health time scheduled for tomorrow at 6:00 AM"

9. **Real-Time Sync Testing:**
   - Open Health page in Tab 1 and Tab 2
   - Start Health Deep Work session in Tab 1 (30 min workout)
   - Stop session → verify both tabs update within 500ms
   - Verify HealthTimeAllocationCard updates: hours_today +0.5h
   - Verify HealthTimeBreakdown adds Workout bar (if new activity)
   - Verify warning disappears if target reached

10. **Integration Testing:**
    - Full workflow: Monday morning, no Health time this week
    - Verify HealthNeglectAlert shows (if past pattern indicates risk)
    - Click "Schedule Health Time Now"
    - Add 1h workout to tomorrow's schedule
    - Next day: Complete workout (log Deep Work session)
    - Verify HealthTimeAllocationCard updates: hours_this_week +1h
    - Verify warning reduces in severity or disappears
    - Sunday: View WeeklyHealthSummary → verify week totals correct

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | v1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-14 | v2.0 | Story completed - health monitoring implemented | User |

## Dev Agent Record
### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
